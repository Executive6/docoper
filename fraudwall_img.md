# Введение

FraudWall представляет собой комплексное решение по обнаружению
мошеннических платежей в следующих системах:

  - система ДБО (предотвращение кражи средств клиента банка, являющейся
    следствием атак на компьютер клиента банка)

  - система АБС (предотвращение кражи средств клиента, являющейся
    следствием злонамеренного действия среди сотрудников банка)

  - АРМ КБР (предотвращение кражи средств банка, являющейся следствием
    атак на АРМ КБР)

<!-- end list -->

  - анализ подозрительных действий пользователя в текущей сессии ДБО

  - проверка статистического профиля плательщика, указанного в
    реквизитах платежа

  - проверка статистического профиля получателя, указанного в реквизитах
    платежа.

Статистический профиль формируется системой FraudWall автоматически на
основании наблюдаемой истории создания документов в системе ДБО.

Настоящий документ является частью документации к системе FraudWall и
содержит в себе сведения, необходимые для ее установки,
администрирования и решения возникающих проблем.

# Общие принципы работы системы FraudWall

Система FraudWall устанавливается в локальной вычислительной сети Банка
в дополнение к существующей системе ДБО.

  - система FraudWall получает информацию о платежах клиентов
    непосредственно из базы данных ДБО либо АБС (работа
    универсальном режиме)

  - система FraudWall дополнительно анализирует трафик работы клиентов,
    выступая как WWW-сервер системы ДБО (для системы BS-Client, начиная
    с версии 3.17.7)

  - система FraudWall дополнительно анализирует трафик работы клиентов,
    выступая как промежуточный прокси-сервер между клиентом банка в
    сети Интернет и WWW-сервером системы ДБО

Более подробно о взаимодействии с системой ДБО приведено в разделе
[Интеграция FraudWall с информационными системами
банка](#integration).

При анализе трафика клиентов, терминация SSL-соединения клиента банка
осуществляется непосредственно на сервере системы FraudWall. В
процессе внедрения SSL-сертификат существующего WWW-сервера
экспортируется в систему FireWall, тем самым исключая
необходимость выполнения каких-либо настроек на стороне
клиента банка: клиенты не заметят каких-либо изменений при работе в
ДБО.

Трафик работы клиентов в системе ДБО фиксируется в файле дампа, который
в дальнейшем обрабатывается анализатором трафика на предмет появления
подозрительных платежей в системе ДБО.

Анализ содержимого файла дампа трафика осуществляется отдельным
процессом, что исключает возможные задержки при работе клиентов
в системе ДБО.

Для хранения накопленной информации в системе FraudWall предусмотрен
собственный сервер баз данных.

Информация о платежах клиентов в системе ДБО, которая фиксируется в
файле дампа, анализируется системой FraudWall по множеству
критериев: соответствует ли данный платеж накопленному
статистическому профилю работы клиента в системе ДБО, не были
ли в текущей сессии клиента выполнены подозрительные действия и т.д.

При обнаружении аномалий, платеж считается подозрительным и информация о
нем отправляется сотрудникам банка для дальнейшего реагирования.

Среднее наблюдаемое время, необходимое системе FraudWall для анализа и
информирования в случае подозрительного платежа, составляет менее
секунды с момента появления соответствующего документа в системе
ДБО - этого времени более чем достаточно, чтобы информация о
подозрительном платеже была своевременно доставлена до
конечного получателя (сотрудника банка) до того, как будет
проведен мошеннический платеж. При выявлении подозрительного
платежа, ответственный сотрудник банка должен связаться с
клиентом (например, по телефону) для подтверждения факта
создания платежа непосредственно клиентом банка.

Для работы в системе FraudWall предусмотрен WWW-интерфейс, позволяющий
не только получать информацию о текущих подозрительных платежах, но и
проводить анализ накопленной информации. Кроме того, возможна
интеграция системы FraudWall с АБС Банка, которая позволяет
оповещать операциониста о подозрительном платеже непосредственно в
интерфейсе АБС до того, как он будет проведен.

Более подробно об механизме интеграции с системами банка см. [Интеграция
FraudWall с информационными системами банка](#integration)

Реализация системы FraudWall представляет собой набор модулей,
работающих на предконфигурированной операционной системе
RedHat Enterprise Linux либо CentOS. Процедура установки системы
FraudWall максимально упрощена за счет использования механизмов
самоконфигурирования на основе характеристик используемого
сервера.

Среднее время на установку системы FraudWall собственными силами банка
«с нуля» составляет несколько часов.

Система FraudWall начинает обнаруживать мошеннические платежи уже сразу
после установки системы (без правил, основанных на накопленной
статистике работы клиентов). Система автоматически формирует
необходимую статистику на основе данных, получаемых из системы ДБО за
предыдущее время.

При реализации системы FraudWall особый акцент был сделан на возможность
многолетней эксплуатации в необслуживаемом автономном режиме, что не
требует высокой квалификации со стороны сотрудников банка. Роль
администраторов системы заключается в основном в выполнении
регламентных работ.

# Архитектура системы

## Модули системы

Архитектура системы FraudWall является модульной, позволяющей
реализовать установку одного комплекса системы на нескольких
серверах.

| Модуль                                 | Назначение                                                                                                                                                                                                                           |
| -------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| hGuard. Модуль фильтрации HTTP-трафика | Основное назначение данного модуля - фильтрация всего HTTP-трафика работы клиента в системе ДБО. Дополнительно данный модуль формирует файл дампа трафика клиента, который в дальнейшем будет обработан модулем анализатора трафика. |
| анализатор трафика                     | Данный модуль осуществляет анализ файла дампа трафика, сформированного модулем hGuard, на предмет обнаружения подозрительных платежей в системе ДБО.                                                                                 |
| модуль управления                      | Основное назначение данного модуля - управлять остальными модулями FraudWall, осуществлять автоматическое конфигурирование программного обеспечения на сервере и выполнять прочие служебные операции.                                |
| удостоверяющий центр                   | Реализует инфраструктуру открытых ключей для всех модулей в системы FraudWall.                                                                                                                                                       |
| интерфейс системы                      | WWW-интерфейс, позволяющий администратору либо пользователю системы FraudWall выполнять необходимые действия в системе.                                                                                                              |
| управляющий www-сервер                 | Обеспечивает работу WWW-интерфейса системы FraudWall.                                                                                                                                                                                |
| исполнительный www-сервер              | Обеспечивает транспортный уровень между управляющим WWW-сервером, который может быть установлен на выделенном сервере, и модулем управления, установленным на данном сервере.                                                        |

Перечень модулей системы FraudWall:

### FraudWall. Интерфейс системы

Администрирование системы FraudWall реализовано через WWW-интерфейс.

![Модуль FraudWall. Интерфейс системы](./images/figure3.jpg)

  - демонстрационный режим

  - работа с реальными данными

При работе в демонстрационном режиме установка каких-либо других модулей
либо компонент системы не требуется - WWW-интерфейс представляет собой
набор статических файлов, которые могут быть записаны, например, на
CD-диск, и запущены непосредственно с CD-диска без какой-либо установки
на компьютер.

В режиме работы с реальными данными необходима установка дополнительных
модулей системы FraudWall на сервер. Демонстрационный режим может быть
запущен даже в том случае, если возможна работа с реальными данными
(например, для обучения сотрудников бэк-офиса работе на новой
системе).

Выбор режима работы осуществляется в процессе аутентификации
пользователя:

![Выбор режима работы в процессе аутентификации
пользователя](./images/figure4.jpg)

WWW-интерфейс содержит в себе встроенную помощь, которая доступна при
клике мышкой на значок

![Встроенная помощь в WWW-интерфейсе системы](./images/figure5.jpg)

В системе предусмотрены информационные сообщения-подсказки, улучшающие
работу пользователя в системе:

![Подсказки в WWW-интерфейсе системы](./images/figure6.jpg)

### hGuard. Модуль фильтрации HTTP-трафика

В качестве одного из источников получения данных о действиях клиента
система FraudWall использует HTTP-трафик между клиентом банка и
сервером системы ДБО.

  - FraudWall устанавливается в разрыв между WWW-сервером банка и
    клиентом (работа в режиме прокси)

  - формирование содержимого WWW-страниц полностью осуществляется
    непосредственно на сервере FraudWall

Помимо получения дампа HTTP-трафика, FraudWall позволяет фильтровать
HTTP-трафик, поступающий из сети Интернет, блокируя попадание
вредоносных либо нежелательных запросов непосредственно на
WWW-сервер банка (т.е. фактически, является Web Application FireWall).

hGuard представляет собой модуль FraudWall, реализовывающий весь
вышеперечисленный функционал.

Схематически работа модуля hGuard показана ниже на рисунках.

![Схема функционирования модуля hGuard (работа в режиме
прокси)](./images/figure7.jpg)

![Схема функционирования модуля hGuard (генерация содержимого
непосредственно на сервере Apache)](./images/figure8.jpg)

На рисунке
показаны:

| Обозначение | Функционал                                                                                                                                                                                                          |
| :---------: | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
|             |                                                                                                                                                                                                                     |
|             | (Используется при необходимости) Организовывает шифрованное HTTPS-соединение между клиентом и сервером Apache                                                                                                       |
|             | Собственно модуль hGuard - проверяет входящий трафик от клиента на допустимость (защищая тем самым сервер ДБО от несанкционированного доступа) и сохраняет дамп трафика (от клиента к WWW-серверу и обратно) в файл |
|             | (Используется при необходимости) Кеширует трафик WWW-сервера (если страница находится в кеше, содержимое отдается непосредственно из кеша)                                                                          |
|             | (Используется при необходимости) Пробрасывает HTTP-запрос, полученный от клиента, на другой WWW-сервер. Дополнительно осуществляется балансировка нагрузки между WWW-серверами (если их несколько)                  |
|             | Станицы сайта, непосредственно располагающиеся на сервере Apache                                                                                                                                                    |
|             | Компоненты, необходимые для работы модуля BSI системы BS-Client на сервере Apache                                                                                                                                   |

Условное обозначение

### Модуль FraudWall. Анализатор трафика

Защита системы ДБО от мошеннических платежей, созданных злоумышленником
от имени клиента, реализуется с помощью модуля анализатора трафика.

Данный модуль осуществляет анализ дамп-файла, сформированного модулем
фильтрации HTTP-трафика, на предмет обнаружения подозрительных
платежей в системе ДБО.

В процессе своей работы модуль анализатора трафика формирует для каждого
клиента банка статистический профиль, который храниться в базе данных
системы. Статистический профиль клиента непрерывно корректируется с
учетом текущих особенностей бизнеса клиента (например, клиент банка
может со временем расширить свой бизнес, с аналогичным изменением
характера создаваемых им документов в системе ДБО).

Корректировка статистического профиля осуществляется в автоматическом
режиме.

Информация о накопленных статистических данных храниться в базе данных с
использованием односторонней хеш-функции. Это означает, что можно
проверить профиль для заданного клиента, но нельзя извлечь
информацию, к какому клиенту принадлежит конкретный профиль.
Такой механизм защиты делает бесперспективной кражу базы
статистических данных системы FraudWall потенциальным
злоумышленником, что исключает возможность «обхода» правил
обнаружения мошеннических платежей, например, создав от имени
клиента платеж, соответствующей статистическому профилю.

При обнаружении подозрительного платежа, информация о таком платеже
записывается в базу данных PostgreSQL. В дальнейшем информацию о
подозрительных платежах из базы PostgreSQL может быть отображена в
WWW-интерфейсе системы либо посредством модуля управления передана
внешним по отношению к FraudWall системам (например, АБС и т.д.).

### Удостоверяющий центр системы FraudWall

Внутреннее взаимодействие всех модулей системы между собой
осуществляется через HTTPS-соединение с взаимной
аутентификацией по SSL-сертификатам.

Для организации инфраструктуры открытых ключей в системе FraudWall
предусмотрен собственный удостоверяющий центр на основе
программного обеспечения openssl.

WWW-интерфейс системы доступен пользователям через HTTPS-интерфейс,
SSL-сертификат которого автоматически выпускается на удостоверяющем
центре системы FraudWall.

### Управляющий WWW-сервер системы FraudWall

При необходимости работы в модуле «FraudWall. Интерфейс системы» с
реальными данными, он устанавливается на сервере совместно с
модулем «Управляющий WWW-сервер системы Fraudwall».

Данный модуль представляет собой WWW-сервер apache, на котором
автоматически настраивается единственный HTTPS-сайт на порту
TCP 1000, обрабатывающий запросы пользователя при работе через интерфейс
системы.

Для работы в интерфейсе системы FraudWall с реальными данными,
пользователь должен авторизоваться в системе. После
прохождения успешной аутентификации, пользователю становятся
доступны только те операции, которые соответствуют его роли и правам
доступа к данным.

### Исполнительный WWW-сервер системы FraudWall

Данный модуль представляет собой WWW-сервер apache, на котором
автоматически настраивается единственный HTTPS-сайт на порту
TCP 1001. Основное его назначение - организация защищенного транспорта
передачи запросов от управляющего WWW-сервера к модулю управления
системы FraudWall.

### Модуль управления системы FraudWall

Данный модуль представляет собой постоянно запущенный процесс (демон),
который обрабатывает запросы от управляющего WWW-сервера по изменению
конфигурации сайтов, а также выполняет прочие служебные операции.

## Прочее программное обеспечение

### Система мониторинга работоспособности

Система мониторинга работоспособности компонент системы FraudWall
реализована на базе программного обеспечения monit, которая
автоматически устанавливается на каждый из серверов, где
установлен хотя бы один модуль системы FraudWall.

Система мониторинга автоматически проверяет работоспособность всех
сервисов и при обнаружении факта неработоспособности осуществляет
их автоматический перезапуск. В сложных случаях, когда перезапуск
сервиса не восстанавливает работоспособность модуля, после
нескольких попыток перезапуска система мониторинга автоматически
перезагружает операционную систему.

### Сервер Memcached

Для снижения нагрузки на сервер баз данных PostgreSQL, используемые в
текущий и ближайший момент времени данные дополнительно кешируются в
системе Memcached. Перед тем, как сделать запрос на выборку данных из
СУБД, модули FraudWall первоначально запрашивают эти данные в системе
Memcached, тем самым снижая нагрузку на сервер баз данных и повышая
общую производительность системы.

### Сервер баз данных PostgreSQL

В качестве сервера баз данных используется СУБД на основе PostgreSQL.

## Схема взаимодействия компонент системы FraudWall

Схема взаимодействия компонент системы FraudWall представлена на
рисунке:

![Схема взаимодействия компонент системы
FraudWall](./images/figure9.jpg)

# Установка системы FraudWall

## Общее описание

В качестве операционной системы используется предконфигурированная
операционная система RedHat Enterprise Linux 6.x либо CentOS 6.x.

Процесс установки максимально автоматизирован и поэтому не требует
высокой квалификации.

Процедура установки состоит из следующих шагов:

  - выбор архитектуры установки серверов (см. [Определение архитектуры
    установки компонент системы FraudWall](#deployment_cfg))

  - определение количества и аппаратной конфигурации серверов,
    необходимых для установки (см. [Требования к аппаратному
    обеспечению](#hw_requirements))

  - получение лицензионного файла на систему FraudWall, а также
    ISO-образа kickstart-CD диска для установки операционной
    системы (см. [Получение дистрибутивов программного
    обеспечения](#get_software))

  - получение установочного образа операционной системы RedHat
    Enterprise Linux или CentOS, а также дистрибутивов сопутствующего
    программного обеспечения (см.[Получение дистрибутивов
    программного обеспечения](#get_software))

  - организация инфраструктуры (выделение IP адресов, предоставление
    сетевого доступа, размещение серверов в стойке и т.д.)

  - установка WWW-сервера обновлений (если требуется, см. [Установка
    WWW-сервера обновлений](#fraudwall_update_install))

  - установка сервера управления системы FraudWall (см.[Установка
    сервера управления системы
    FraudWall](#fraudwall_master_install))

  - установка одного или нескольких серверов анализа трафика, если есть
    желание проверять не только реквизиты платежных поручений, но и
    содержимое дампа трафика (см. [Установка сервера анализа
    трафика](#fraudwall_af_install))

  - ввод через WWW-интерфейс сервера управления информации о
    мошеннических платежах (см. [Ручной ввод данных о
    мошенническом платеже](#learn_fraud))

  - тестирование (см. [Тестирование обнаружения мошеннических
    платежей](#testing_example))

  - эксплуатация

## Определение архитектуры установки компонент системы FraudWall

Логически система FraudWall разделена на следующие серверы, которые
могут быть установлены как на одном физическом компьютере
(виртуальной машине), так и разнесены по нескольким
компьютерам:

  - Сервер обновлений системы FraudWall (устанавливается по желанию)

  - Сервер управления системы FraudWall

  - Сервер баз данных системы FraudWall (как правило, устанавливается на
    сервере управления)

  - Сервер анализа трафика (устанавливается по желанию)

В целях балансировки нагрузки и отказоустойчивости может быть
установлено несколько серверов анализа трафика.

### Подход к тестированию системы FraudWall

Архитектура системы FraudWall позволяет реализовать схему, когда часть
клиентов будет работать с ДБО через систему FraudWall (с фильтрацией
трафика и обнаружением мошеннических платежей), а другая часть
клиентов может работать напрямую с сервером ДБО (без фильтрации
трафика и обнаружения мошеннических платежей соответственно). Это
позволяет протестировать работоспособность и надежность
установленной системы FraudWall на период тестирования.
Пример такой схемы показан на рисунке:

![Пример схемы прохождения трафика ДБО на период
тестирования](./images/figure16.jpg)

### Балансировка нагрузки между серверами FraudWall

  - регистрация в DNS 2-х и более IP адресов на одно доменное имя

  - использование аппаратного балансировщика

Первый способ не требует каких-либо затрат. Клиенты должны заходить на
сайт ДБО не по IP адресу, а по доменному имени, например,
<https://dbo.bank.ru>. Для этого доменного имени в DNS регистрируется 2
записи, соответствующие одному доменному имени, но 2 разным IP адресам
в сети Интернет. Балансировка нагрузки осуществляется DNS-сервером,
который отдает разным клиентам разный IP адрес

Рекомендуется установить TTL (срок жизни записи в DNS) не более, чем 10
минут. В случае отказа одного из серверов, в DNS удаляется запись с
неработоспособным IP адресом, и все клиенты меньше, чем через 10
минут начнут работать с исправным сервером.

Аппаратный балансировщик позволяет эффективнее использовать ресурсы
нескольких серверов и гораздо быстрее переключать их в случае
отказа.

## Требования к аппаратному обеспечению

Архитектура системы FraudWall использует ресурсоэффективные методы,
позволяющие снизить нагрузку на жесткие диски, уменьшить сетевой
трафик и процессорное
время.

|                                                         Число клиентов                                                          | Рекомендуемые аппаратные требования                                                                                                                      |
| :-----------------------------------------------------------------------------------------------------------------------------: | -------------------------------------------------------------------------------------------------------------------------------------------------------- |
|                                                             до 1000                                                             | 1xCPU Pentium IV 2.8GHz, 1GB RAM, 24 GB HDD (в аппаратном RAID 0)                                                                                        |
|                                                             до 5000                                                             | 2xCPU Pentium IV 2.8GHz, 2GB RAM, 64 GB HDD (в аппаратном RAID 0, предпочтительно с кешем обратной записи)                                               |
|                                                            до 10000                                                             | 1 сервер конфигурации 2xCPU Pentium IV 2.8GHz, 4GB RAM, 64GB HDD (в аппаратном RAID 0, предпочтительно с кешем обратной записи)                          |
| 1 сервер конфигурации 2xCPU Pentium IV 2.8GHz, 6GB RAM, 64GB HDD (в аппаратном RAID 0, предпочтительно с кешем обратной записи) |                                                                                                                                                          |
|                                                           свыше 10000                                                           | 1 сервер на каждые 20000 клиентов конфигурации 2xCPU Pentium IV 2.8GHz, 4GB RAM, 64GB HDD (в аппаратном RAID 0, предпочтительно с кешем обратной записи) |
|           1 сервер конфигурации 4xCPU Xeon 3.1GHz, 16 GB RAM, 128GB HDD (в аппаратном RAID 6 с кешем обратной записи)           |                                                                                                                                                          |

Рекомендуемая конфигурация серверов

Для целей тестирования возможно использовать и более слабое
оборудование.

Оценить загрузку виртуальной машины можно, установив систему и выполнив
импорт данных из АБС за последний год работы.

В журнале событий импорта фиксируется время, необходимое для обработки
каждой тысячи платежных документов. Если время, необходимое для
импорта 1000 документов, минимум в 10 раз меньше времени, за
которое клиенты создают в реальной системе ДБО 1000 платежных
документов, то производительность системы достаточна.

## Получение дистрибутивов программного обеспечения

  - лицензионный файл на систему FraudWall

  - CD-диск: kickstart-диск, используемый для быстрой установки
    операционной системы
    
    > **Note**
    > 
    > ISO-образ kickstart-диска может быть получен в технической
    > поддержке компании Фродекс по запросу.
    
    > **Warning**
    > 
    > Версия kickstart-диска должна совпадать с версией устанавливаемой
    > операционной системы.

  - DVD-диск: стандартный установочный дистрибутив операционной системы
    RedHat Enterprise Linux или CentOS

  - Sun Java JRE (при установке модуля BSI системы ДБО BS-Client
    непосредственно на сервер FraudWall)

  - SSH-клиент (например, PuTTY)

  - файловый менеджер, позволяющий передавать файлы по протоколу SCP
    (например, плагин WinSCP для файлового менеджера FAR)

### Получение дистрибутива RedHat Enterprise Linux

> **Note**
> 
> Если в качестве операционной системы используется CentOS, выполнять
> действия в данном разделе не требуется

В качестве операционной системы используется 32-х битная операционная
система RedHat Enterprise Linux версии 6.x. Получить ISO-образы
компакт-дисков операционной системы можно, скачав их
непосредственно с сайта после покупки технической
поддержки на RedHat Enterprise Linux.

Возможно также скачать ISO-образ, оформив на сайте
<https://access.redhat.com/downloads/> бесплатную 30-дневную техническую
поддержку.

> **Warning**
> 
> Необходимо запомнить (либо записать) логин и пароль на сайт
> redhat.com, так как он понадобиться в дальнейшем при установке
> операционной системы.

После регистрации на сайте redhat.com, необходимо скачать Binary DVD
операционной системы RedHat Enterprise Linux Server 6.3 (32-битная
для x86):

![Страница скачивания ISO-образа RedHat Enterprise
Linux](./images/figure10.jpg)

После скачивания файла рекомендуется проверить MD5-хеш файла ISO-образа
утилитой типа **md5sum**.

### Получение дистрибутива CentOS

> **Note**
> 
> Если в качестве операционной системы используется RedHat Enterprise
> Linux, выполнять действия в данном разделе не требуется

Дистрибутив CentOS распространяется бесплатно с сайта
<http://www.centos.org/>.

> **Note**
> 
> Необходимо загрузить **CentOS версии 6.х** . Список зеркал можно найти
> по следующей ссылке [](http://wiki.centos.org/Download)

Для установки системы FraudWall необходимо скачать ISO-образ первого
(DVD-1) инсталляционного диска CentOS под 32-битную архитектуру (имя
файла выглядит как `CentOS-6.6-i386-bin-DVD1.iso`).

После скачивания файла рекомендуется проверить MD5-хеш файла ISO-образа
утилитой типа **md5sum**.

### Получение дистрибутива Sun Java JRE

> **Note**
> 
> Sun Java JRE необходим только в случае установки модуля BSI системы
> ДБО BS-Client непосредственно на сервер FraudWall.

Для бесплатного скачивания дистрибутива Sun Java JRE, необходимо зайти
по ссылке
[](http://www.oracle.com/technetwork/java/javase/downloads/index.html) и
выбрать Download JRE 7, затем скачать файл с расширением .rpm для Linux
x86 (32-bit):

![Страница скачивания дистрибутива Sun Java JRE](./images/figure11.jpg)

> **Warning**
> 
> Если вы используете браузер Opera, то для корректной работы с сайтом
> www.oracle.com рекомендуется использовать последнюю версию браузера,
> либо использовать Chrome либо Internet Explorer.

## Установка операционной системы

В качестве операционной системы используется **RedHat Enterprise Linux
6.x** или **CentOS 6.x**.

> **Note**
> 
> RedHat Enterprise Linux 6.x является промышленной операционной
> системой, техническая поддержка которой осуществляется
> компанией RedHat Inc. на платной основе (в рамках так
> называемой Software Subscription). В рамках [Red Hat
> Enterprise Linux Life
> Cycle](https://access.redhat.com/support/policy/updates/errata/),
> компания RedHat обязуется выпускать обновления на данную
> операционную систему и исправлять ошибки, связанные с
> безопасностью, до 30 ноября 2020 г.
> 
> CentOS - это операционная система, собираемая добровольцами всего мира
> из пакетов, публикуемых компанией RedHat с добавлением небольших
> доработок, связанных, в первую очередь, с механизмом получения
> обновлений на операционную систему.
> 
> Из-за отсутствия каких-либо обязательств по выпуску обновлений на
> CentOS, исправления безопасности на программное обеспечение CentOS
> выходят с некоторой задержкой, в течение которой операционная
> система с FraudWall может быть уязвима для атак извне.

1.  Проверяем, что на межсетевом экране (и при необходимости на
    proxy-сервере) был предоставлен доступ, необходимый для
    взаимодействия компонент и получения программного
    обеспечения системы FraudWall (см. разделы
    [Конфигурирование межсетевых экранов](#firewall_cfg)
    и [Механизм получения обновлений](#update_subsystem) ).

2.  Убеждаемся, что в банке есть NTP-сервер времени, который
    синхронизирован с глобальными серверами времени
    посредством Internet.
    
    > **Note**
    > 
    > Как правило, в качестве NTP-сервера времени используется
    > контроллер ActiveDirectory, на котором поднята
    > соответствующая служба.
    
    > **Warning**
    > 
    > Системы ДБО, системы АБС, а также почтовые сервера банка также
    > должны синхронизироваться с NTP-сервером времени банка

3.  Загружаемся в BIOS и выставляем время на сервере во временной зоне
    UTC (GMT). На 1 января 2015г. время в зоне UTC отставало от
    московского на 3 часа (т.е. если московское время 13:00, в
    BIOS необходимо выставить 10:00).
    
    > **Warning**
    > 
    > В случае установки сервера на виртуальную машину, время должно
    > быть выставлено в BIOS виртуальной машины. Детали по загрузке
    > в BIOS виртуальной машины можно получить в документации по
    > программному обеспечению виртуального гипервизора.

4.  Сверяем версию полученного kickstart-диска и версию установочного
    дистрибутива Linux. Они должны совпадать.

5.  Загружаемся с kickstart-диска
    
    > **Warning**
    > 
    > Версия kickstart-диска должна совпадать с версией устанавливаемой
    > операционной системы (т.е. если операционная система - это RedHat
    > версии 6.9, имя iso-образа kickstart-диска должно быть как
    > fraudwall-ks-**rhel-server-6.9**-...iso). Если это не так,
    > обратитесь в техническую поддержку за получением
    > iso-образа kickstart-диска, или используйте дистрибутив
    > операционной системы соответствующей версии).
    
    > **Warning**
    > 
    > Убедитесь, что вы загружаетесь с kickstart-диска, а не с
    > установочного дистрибутива Linux. Сам kickstart-диск
    > представляет собой CD-диск размером 40 мегабайт, имя
    > ISO-образа должно начинаться как fraudwall-ks-...
    > 
    > **Не нужно пытаться ставить Linux без kickstart-диска, т.к. в нем
    > прошиты необходимые параметры для правильной работы FraudWall.
    > Если вы все-таки поставили Linux без kickstart-диска, придется
    > переустанавливать сервер.**

6.  В появившемся меню выбираем меню **Install from CD-ROM**:
    
    ![Меню начала установки операционной системы](./images/figure17.jpg)

7.  При появлении сообщения **Disc Not Found**, необходимо извлечь
    kickstart-диск и вставить DVD-диск дистрибутива операционной
    системы, после чего выбрать пункт **Ok**:
    
    ![Сообщение о необходимости установки DVD-ROM
    диска](./images/figure18.jpg)

8.  Если система устанавливается на виртуальную машину, то вполне
    возможно, что при установке будет запрошена необходимость
    инициализировать виртуальный жесткий диск. В этом случае с
    помощью кнопок клавиатуры Tab и Enter необходимо выбрать пункт
    **Re-initialize all**, как показано на рисунке:

9.  Установка операционной системы, включая выбор необходимых компонент,
    форматирование разделов жесткого диска и т.д. осуществляется
    автоматически.
    
    > **Note**
    > 
    > Если процесс автоматической установки операционной системы не
    > запустился, необходимо обратиться в службу технической
    > поддержки.

10. По завершению процесса установки будет отображено соответствующее
    уведомление:
    
    ![Сообщение о завершении установки операционной
    системы](./images/figure20.jpg)
    
    После нажатия на клавишу **Enter** будет осуществлена перезагрузка
    системы.
    
    > **Warning**
    > 
    > В BIOS компьютера должен быть установлен приоритет загрузки с
    > жесткого диска, иначе после перезагрузки запустится повторная
    > установка операционной системы c DVD-диска.

11. После перезагрузки системы будет выполнена первоначальная
    конфигурация сервера:
    
    ![Конфигурирование сетевых настроек сервера](./images/figure21.jpg)

12. Назначаем серверу доменное имя (в соответствии с принятыми в банке
    правилами формирования названий серверов банка), указываем
    статический IP адрес сервера и остальные сетевые настройки
    
    > **Note**
    > 
    > Если на этом этапе сетевые настройки сервера были указаны
    > некорректно, то инициализация сетевого интерфейса может
    > завершиться с ошибкой. Исправить их можно на одном из
    > последующих этапах этого раздела.

13. После ввода настроек будет автоматически активирован сетевой
    интерфейс, и откроется окно приглашения ввода логина и
    пароля при работе сервером. Заходим под логином **root**,
    пароль **12345**
    
    ![Приглашение на ввод пароля в консоли RedHat Enterprise
    Linux](./images/figure22.jpg)

14. Если вы на предыдущем этапе ошиблись в указании сетевых настроек, их
    можно исправить в соответствии с разделом [Администрирование сетевых
    настроек](#os_network_cfg).

15. При установке на операционную систему RedHat Enterprise Linux
    необходимо зарегистрировать установленный сервер в RedHat
    Network в соответствии с разделом [Процедура регистрации
    операционной системы RedHat Enterprise
    Linux](#rhel_registration).

16. Если сервер будет скачивать обновления в проксированном режиме,
    необходимо выполнить настройки, указанные в разделе
    *[Конфигурирование получения обновлений в проксированном
    режиме](#cfg_update_via_proxy)*.

17. Выполняем команду установки минимально необходимых компонент (для
    подтверждения установки укажите **y** и нажмите **Enter**): `yum
    install fraudwall-system`

18. В командной строке запускаем команду: `fw_passwd root`
    
    Меняем пароль учетной записи root на другой.
    
    > **Warning**
    > 
    > Если пароль пользователя **root** забыт, существует довольно
    > сложная процедура сброса пароля, которая потребует
    > перезагрузки сервера. Поэтому рекомендуется указывать
    > такой пароль, который не будет утерян либо забыт.
    > 
    > Учетная запись **root** позволяет получить неограниченный доступ к
    > серверу FraudWall, в том числе к дампам трафика работы клиентов в
    > системе ДБО, содержащих конфиденциальную информацию. Поэтому
    > храните пароль учетной записи **root** в секрете.

19. Подключаемся к серверу файловым менеджером по протоколу SFTP(SCP) и
    копируем файл с лицензией в файл `/etc/fraudwall/license.dat`
    
    > **Note**
    > 
    > Работа с SFTP (SCP)-клиентом описана в разделе [Интерфейс передачи
    > файлов посредством протоколов SCP и SFTP](#admin_file_ssh)

20. В SSH-консоли запускаем Midnight Commander командой: `mc`

21. Указываем в конфигурационных файлах `/etc/fraudwall/fwcontrol.xml` и
    `/etc/fraudwall/fraudwall.xml` значение всех параметров.
    
    > **Note**
    > 
    > Содержимое конфигурационных файлов `/etc/fraudwall/fwcontrol.xml`
    > и `/etc/fraudwall/fraudwall.xml`, как правило, идентично на всех
    > серверах, где установлена система FraudWall. Если вы
    > устанавливаете операционную систему для еще одного
    > сервера системы FraudWall, можно скопировать эти файлы с ранее
    > настроенного сервера.
    
    > **Warning**
    > 
    > Обратите внимание, что есть ограничения по допустимым символам
    > логина и пароля, которые могут быть указаны в конфигурационном
    > файле.
    > 
    > Детальное описание параметров приведено в разделах
    > [Конфигурационный файл
    > fraudwall.xml](#fraudwall_xml) и [Конфигурационный файл
    > fwcontrol.xml](#fwcontrol_xml).

22. Если сервер установлен на виртуальную машину VMWare, на
    установленную операционную систему рекомендуется
    установить программное обеспечение VMWare Tools. Документацию
    по установке VMWare Tools на RedHat Enterprise Linux 6 либо CentOS
    можно получить на сайте компании VMware, Inc.

23. Если сервер будет использован как WWW-сервер обновлений, необходимо
    перейти к процессу его установки (раздел [Установка WWW-сервера
    обновлений](#fraudwall_update_install)).

24. Устанавливаем обновления на операционную систему в соответствии с
    разделом [Установка обновлений на операционную систему в ручном
    режиме](#manual_os_update)`fw_update -s`

25. Перегружаем сервер командой `reboot`

## Установка сервера базы данных системы FraudWall

1.  В SSH-консоли выполняем команду установки компонент баз данных: `yum
    install fraudwall-psql`

2.  Выполняем команду создания администратора на уровне базы данных:
    `fw_dbadmin`

3.  Вводим логин и пароль администратора базы данных (с учетом
    регистра), указанные в конфигурационном файле
    `fwcontrol.xml`.

4.  В SSH-консоли выполняем команду: `yum install fraudwall-control`

5.  Убеждаемся в корректности данных, указанных в конфигурационных
    файлах `fraudwall.xml` и `fwcontrol.xml`. Для этого выполняем
    команду: `service fw_control restart`
    
    > **Warning**
    > 
    > Если при выполнении этой команды возникла ошибка, исправьте
    > конфигурационные файлы, т.к. при некорректных
    > конфигурационных файлах сервер будет периодически
    > перегружаться.

6.  При необходимости подкорректируйте конфигурационный файл СУБД
    PostgreSQL `/var/lib/pgsql/data/postgresql.conf` (например, размер
    используемой памяти СУБД и т.д.). Описание каждого
    конфигурационного параметра приведено по тексту
    этого файла, при необходимости можете проконсультироваться с
    технической поддержкой.
    
    > **Note**
    > 
    > Файл конфигурации СУБД PostgreSQL, устанавливаемый по умолчанию,
    > достаточен для большинства небольших и средних банков. Вносить
    > изменения в этот конфигурационный файл необходимо только для
    > крупных банков, где обрабатывается большой объем данных.
    
    Если вы изменили конфигурационный файл `postgresql.conf`, убедитесь
    в его корректности, для этого выполните команду `service postgresql
    restart`
    
    При выполнении этой команды не должно быть каких-либо ошибок, а
    процесс сервиса СУБД PostgreSQL должен корректно запустится (в
    этом можно убедиться в файлах событий в директории
    `/var/log/postgresql`)

## Установка сервера управления системы FraudWall

1.  Проверяем, что ранее был установлен и настроен сервер баз данных
    (см. раздел [Установка сервера базы данных системы
    FraudWall](#fraudwall_db_install)).

2.  В SSH-консоли выполняем команду установки компонент управляющего
    WWW-сервера: `yum install fraudwall-master`

3.  Открываем WWW-интерфейс системы по ссылке
    [](https://IP_адрес_сервера:1000) (на предупреждение
    браузера о некорректном сертификате нажимаем игнорировать).
    
    > **Note**
    > 
    > Если у вас не открывается данная ссылка, попробуйте временно
    > полностью отключить использование proxy-сервера в браузере,
    > либо использовать другой браузер (например, Chrome или Firefox).

4.  Входим в систему под логином **admin** (пароль также **admin**),
    являющегося встроенным администратором системы FraudWall.
    Заходим в пункт "Мои настройки" меню "Пользователи" и меняем
    пароль.
    
    > **Warning**
    > 
    > Если вы в дальнейшем забыли пароль пользователя **admin**, его
    > можно сбросить через SSH-консоль. Более подробно см. раздел
    > [Сброс пароля встроенного администратора системы
    > FraudWall](#admin_password_reset).

5.  В пункте «Администирование» меню «Пользователи» создаем необходимых
    пользователей (детали см. в разделе [Администрирование
    пользователей системы FraudWall](#fw_user_admin)):
    
    ![Интерфейс администрирования пользователей](images/figure39.jpg)
    
    > **Warning**
    > 
    > Обязательно удостоверьтесь, что в системе зарегистрирован хотя бы
    > один пользователь с ролью «**Администратор**», у которого указан
    > **e-mail**. При отсутствии такого пользователя, почтовые
    > уведомления системного характера отправляться не будут.
    > Детали см. в разделах [Особенности доставки административных
    > SMTP-сообщений](#alert_smtp_admin) и [Особенности доставки
    > SMTP-сообщений при обнаружении подозрительного платежного
    > поручения](#alert_smtp_payment).

6.  Убеждаемся, что на почтовый ящик администратора приходит тестовое
    письмо. Для этого в ssh-косоли выполняем команду (скопируйте
    через буфер обмена):`echo test | mail root`
    
    > **Warning**
    > 
    > Если письмо не доставлено, посмотрите возможные причины в конце
    > файла `/var/log/maillog`. При необходимости свяжитесь с
    > технической поддержкой

7.  Заходим в пункт «Профили антифрода» меню «Система» и создаем новый
    профиль (детали см. в разделе [Конфигурирование профилей
    обнаружения мошеннических платежей](#cfg_profile)):
    
    ![Интерфейс создания нового профиля](./images/figure36.jpg)

8.  В пункте «Филиалы» привязываем созданный профиль каждому из банков
    либо его филиалу (детали см. в разделе [Конфигурирование профилей
    обнаружения мошеннических платежей](#cfg_profile)):
    
    ![Интерфейс параметров банков либо их
    филиалов](./images/figure37.jpg)
    
    > **Warning**
    > 
    > Проверьте, что каждому из доступных банков либо его филиалов
    > привязан профиль обнаружения мошеннических платежей

9.  Все мошеннические платежи, которые были в банке за последние 2 года,
    необходимо зарегистрировать в системе через меню "Платежи \\ Ручной
    импорт".
    
    > **Warning**
    > 
    > Если это не сделать, при автоматическом обучении истории платежей
    > всех клиентов, система будет считать предыдущие мошеннические
    > платежи как "хорошие" с соответствующим статусом в базе
    > статистики. Поэтому если в дальнейшем в банке будут платежи
    > на того же получателя, они не распознаются как мошеннические.

10. Импортируйте черные списки, полученные в рамках антидроп-клуба (см.
    раздел [Поддержка межбанковского почтового обмена
    ("антидроп-клуб")](#blacklist_antidrop))

11. Ознакомьтесь с подходами к интеграции с ДБО и АБС банка
    (см.[Интеграция FraudWall с информационными системами
    банка](#integration))

12. Совместно с технической поддержкой выберите оптимальный вариант
    интеграции (см. [Варианты интеграции FraudWall с системами
    банка](#integration_modes))

13. Устанавливаем ODBC-драйвера для подключения к базе данных систем ДБО
    и АБС (см. раздел [Установка ODBC-драйверов](#odbc_install))

14. На сервере баз данных системы ДБО или АБС создаем набор VIEW и
    пользователя, под которым система FraudWall будет подключаться
    к этой базе данных.
    
    > **Note**
    > 
    > Пример SQL-скриптов, которые должны быть выполнены на сервере базы
    > данных ДБО, находятся в директории `/usr/share/doc/fraudwall/` в
    > файлах, оканчивающихся на `_universal.sql` (полное имя файла
    > содержит тип системы ДБО и базы данных системы ДБО).

15. Если интеграция с ДБО подразумевает создание сайта, работающего
    через HTTPS, необходимо предварительно экспортировать с
    существующего WWW-сервера системы ДБО SSL-сертификат в
    формате PKCS\#12, содержащий открытый сертификат, секретный
    ключ, а также сертификаты всех удостоверяющих центров,
    выпустивших этот сертификат. Пример процедуры экспорта
    приведен в разделе [Процедура экспорта SSL-сертификата из
    IIS](#export_ssl)

16. В пункте «Сайты» создаем необходимые сайты, которые будут
    обслуживаться FraudWall (детали см. в разделе
    [Конфигурирование системы FraudWall. Сайты](#cfg_sites)):
    
    ![Интерфейс конфигурирования сайтов](./images/figure38.jpg)

17. На сервере управления в `/var/log/fraudwall/siteNNN-afdb.log`
    убеждаемся, что системой FraudWall начали проверяться платежи
    из анализируемой системы.

## Установка сервера анализа трафика

1.  Проверяем, что ранее были установлены и настроены сервер баз данных
    (см. раздел [Установка сервера базы данных системы
    FraudWall](#fraudwall_db_install)), а также сервер управления
    системы FraudWall (см. раздел [Установка сервера управления
    системы FraudWall](#fraudwall_master_install)).

2.  Если сервер анализа трафика будет являться WWW-сервером (а не
    прокси-сервером), дополнительно должен быть установлен модуль
    BSI системы BS-Client, см. раздел [Установка модуля BSI на сервер
    FraudWall (предварительный этап)](#bsi_install_step1).

3.  Выполняем команду установки компонент анализа трафика: `yum install
    fraudwall-site`

4.  Выполняем команду синхронизации сертификатов с сервера управления:
    `fw_cert`

5.  Выполняем команду получения конфигурации профилей с управляющего
    WWW-сервера системы FraudWall: `fw_control -u profile`

6.  Открываем в Midnight Commander файл
    `/var/log/fraudwall/fw_control.log` на чтение и проверяем его на
    наличие ошибок.
    
    > **Warning**
    > 
    > При наличии ошибок необходимо удостовериться в наличии необходимых
    > доступов на межсетевых экранах (должен быть открыт доступ по TCP
    > порту 1000 с данного сервера на управляющий WWW-сервер). Если
    > устранить ошибки не удалось, необходимо обратится в техническую
    > поддержку.

7.  Выполняем команду получения конфигурации Web-сайтов с управляющего
    WWW-сервера системы FraudWall: `fw_control -u site`

8.  Повторно открываем в Midnight Commander файл
    `/var/log/fraudwall/fw_control.log` на чтение и проверяем его на
    наличие ошибок.
    
    > **Note**
    > 
    > Чтобы быстро проверить файл на наличие ошибок, при его просмотре
    > нажмите кнопку F7 и поищите текст **\[err\]**, **\[warn\]**,
    > **error** или **ошибка**.

9.  Если сервер анализа трафика будет являться WWW-сервером (а не
    прокси-сервером), необходимо выполнить действия из [Установка
    модуля BSI на сервер FraudWall (завершающий
    этап)](#bsi_install_step2).

### Установка модуля BSI на сервер FraudWall (предварительный этап)

> **Note**
> 
> Данный раздел нужно выполнять только если сервер анализа трафика будет
> являться WWW-сервером системы ДБО BS-Client

Установка модуля BSI состоит из 2 этапов:

  - предварительный этап - установка и настройка программного
    обеспечения

  - завершающий этап - настройка модуля BSI (см. [Установка модуля BSI
    на сервер FraudWall (завершающий этап)](#bsi_install_step2))

Процедура установки и настройки программного обеспечения модуля BSI
следующая:

1.  Подключаемся к серверу файловым менеджером по протоколу SFTP(SCP) и
    копируем скаченный ранее установочный дистрибутив с Sun Java JRE
    (например, `jre-7u3-linux-i586.rpm`) во временную директорию
    **/tmp**

2.  В SSH-консоли запускаем Midnight Commander: `mc`

3.  Переходим в директорию **/tmp**

4.  Запускаем команду установки Sun Java JRE (указываем точное имя
    скаченного rpm-файла дистрибутива Sun Java JRE), например:
    `rpm -i jre-7u3-linux-i586.rpm`
    
    Если в процессе установки появились ошибки об отсутствии файлов с
    расширением .pack, то их можно игнорировать:
    
    ![Ошибки инсталлятора JRE от Oracle, которые можно
    игнорировать](./images/figure40.jpg)

5.  Выполняем команду установки компонент системы FraudWall, необходимых
    для работы модуля BSI ДБО BS-Client: `yum install fraudwall-bsi`

6.  В Проводнике Windows открываем сетевой диск **bsi** (либо в файловом
    менеджере по протоколу SFTP(SCP) переходим в директорию
    `/etc/tomcat6/RT_Ic`)

7.  Копируем в нее файл `bsi.jar` с Web-сервера BS-Client (как правило,
    он располагается в папке `C:\BSSystems\Inetpub\Bsi_scripts\RT_Ic\`)

8.  Для работы модуля BSI требуется конфигурационный файл `  bsi.xml `,
    который должен располагаться в папке `/etc/tomcat6/RT_Ic/` на
    сервере анализа трафика.
    
    В комплекте FraudWall есть готовый файл `bsi.xml.sample`, который вы
    можете скопировать под именем `bsi.xml` или же создать средствами
    `bsiset.exe` ([Формирование bsi.xml в формате Linux](#make_bsixml))

### Установка модуля BSI на сервер FraudWall (завершающий этап)

> **Warning**
> 
> Приступать к выполнению действий данного раздела можно только после
> установки на сервер анализа трафика модуля анализатора трафика, а
> также модуля фильтрации HTTP-трафика ([Установка сервера анализа
> трафика](#fraudwall_af_install)).

1.  На сервере RTS BS-Client добавляем IP адрес созданного сервера BSI в
    список соединений (порт аналогично тому BSI, который ранее
    использовался, как правило, это 12060):
    
    ![Добавление нового сервера BSI в конфигурацию сервера RTS
    BS-Client](./images/figure45.jpg)

2.  Открываем WWW-интерфейс системы FraudWall и открываем пункт
    «Конфигурирование» в меню «Система», вкладка «Web-сайты».

3.  Уточняем номер ID сайта, который создан для сайта ДБО BS-Client с
    модулем BSI, устанавливаемого на сервер FraudWall:
    
    ![Автоматически сгенерированный ID сайта](./images/figure46.jpg)

4.  В Проводнике Windows открываем сетевой диск `siteN` (либо в файловом
    менеджере по протоколу SFTP/SCP переходим в директорию
    `/etc/fraudwall/site/www/siteN`), где N-номер ID сайта

5.  Копируем в нее актуальное содержимое Web-сайта системы BS-Client.
    Как правило, Web-сайт располагается на Web-сервере BS-Client в
    папке `C:\BSSystems\Inetpub\Bsi_sites\rt_ic\`

6.  Открываем Internet Explorer и соединяемся с созданным Web-сайтом
    системы FraudWall. Должен открыться стандартный интерфейс
    клиента ДБО BS-Client.
    
    > **Note**
    > 
    > Если сайт не открывается, то смотрим журналы событий модуля BSI
    > (файлы в директории `/var/log/tomcat6`) и Apache (файлы в
    > директории `/var/log/fraudwall`) и устраняем
    > зафиксированные ошибки совместно со службой
    > технической поддержки.

### Действия при обновлении файлов сайта ДБО BS-Client

> **Note**
> 
> Действия этого раздела необходимо выполнять только если модуль BSI
> системы BS-Client установлен непосредственно на сервер анализа
> трафика

При установке модуля BSI на сервер анализа трафика, данный сервер
фактически выполняет роль WWW-сервера системы BS-Client, с
которым работают клиенты банка. Поэтому, в процессе обновления
системы BS-Client, необходимо также обновлять содержимое
соответствующего WWW-сайта на сервере FraudWall.

Для этого, с помощью Проводника Windows подключитесь с сетевому диску
\\\\IP\_адрес\\siteN (где N-идентификатор сайта в конфигурации
FraudWall) и выложите обновления.

После наката обновлений рекомендуется полностью перегрузить операционную
систему как сервера FraudWall, так и сервера RTS

> **Warning**
> 
> При замене файлов сайта не забывайте изменять номер версионного
> каталога BS-Client, т.к. в браузере клиента некоторые файлы
> могли закешироваться.

## Установка WWW-сервера обновлений

> **Warning**
> 
> Операционная система WWW-сервера обновлений должна быть установлена
> согласно разделу [Установка операционной системы](#os_install) ,
> аналогично всем серверам инфраструктуры FraudWall.

> **Note**
> 
> WWW-сервер обновлений рекомендуется устанавливать на отдельный
> компьютер (либо виртуальную машину), на который не будут
> установлены компоненты FraudWall.

1.  Устанавливаем обновления на программное обеспечение FraudWall
    командой: `fw_update -b`

2.  Выполняем команду установки WWW-сервера обновлений: `yum install
    fraudwall-updatesrv`

3.  Устанавливаем пакеты - зависимости, требуемые для компонент системы
    FraudWall: `yum install fraudwall-packages`

4.  Устанавливаем обновления командой: ` fw_update -s  `
    
    > **Note**
    > 
    > Данная команда на WWW-сервере обновлений выполняется несколько
    > минут.

5.  Создаем директорию `/mnt/cdrom` командой `mkdir -p /mnt/cdrom`

6.  Вставляем инсталляционный DVD-диск операционной системы и монтируем
    его командой `mount -o ro /dev/cdrom /mnt/cdrom`

7.  С помощью Midnight Commander копируем все все файлы, находящиеся в
    директории `/mnt/cdrom/Packages` в директорию
    `/etc/fraudwall/update/www/repo/rhel-i386-server-6/` (если в
    качестве операционной системы используется RedHat Enterprise
    Linux) либо `/etc/fraudwall/update/www/repo/base/` (для операционной
    системы CentOS).

8.  Повторно выполняем команду установки обновлений операционной
    системы: `fw_update`

9.  Перегружаем сервер командой `reboot`

### Важная информация по эксплуатации WWW-сервера обновлений

> **Warning**
> 
> На WWW-сервере обновлений нельзя выполнять команду очищения кеша yum
> (**yum clean all**), т.к. очищенные пакеты не будут доступны остальным
> серверам.

Все пакеты, установленные на WWW-сервере обновлений, обновляются
автоматически.

Чтобы остальным серверам были доступны новые пакеты программного
обеспечения, которые еще не установлены на WWW-сервере
обновлений, необходимо выполнить команду: `yum install
имя_пакета` а затем `fw_update`

## Инфраструктура FraudNET

### Общее описание

В крупных банках с развитой филиальной сетью, в которых установлено
несколько независимых площадок системы ДБО, возникает проблема
централизованного администрирования всеми серверами FraudWall: т.к.
для каждой независимой площадки ДБО необходима установка независимого
комплекта серверов FraudWall. Часто возникает необходимость
вмешательства специалистов центрального офиса в деятельность
филиалов: помощь при внесении изменений в конфигурацию системы,
проверка установленных параметров, просмотр аналитики.

Для решения данной задачи, все сервера FraudWall в филиалах могут быть
объединены в единую инфраструктуру, называемую FraudNET.

> **Warning**
> 
> Поддержка инфраструктуры FraudNET является опциональной и
> лицензируется отдельно

В инфраструктуре FraudNET один из серверов управления выступает в роли
так называемого главного сервера управления. Посредством интерфейса
главного сервера можно получить централизованный доступ к любому
входящему в инфраструктуру серверу управления, что значительно
упрощает администрирование и позволяет отслеживать
работоспособность всех серверов FraudWall, участвующих
в инфраструктуре FraudNET.

### Синхронизация серверов

Благодаря синхронизации всех серверов управления филиалов с центральным
(с частотой 1 раз в 10 мин), на нем всегда имеется актуальная информация
о работоспособности серверов сети, об ошибках возникших в работе
FraudWall или других компонент. Также при синхронизации происходит обмен
обновленной информацией о мошеннических платежах, что позволяет
своевременно оповестить все филиалы и предотвратить массовый
увод денег у клиентов.

### Настройка серверов для работы в режиме FraudNET

1.  В инфраструктуре сети банка выделяем один из серверов управления
    FraudWall, который получит статус главного сервера управления.

2.  В конфигурационном файле ` /etc/fraudwall/fraudwall.xml  `дописываем
    следующие строки:
    
        <!-- IP адрес главного сервера управления FraudWall -->
        <option name="supermaster_server" value="1.2.3.4"/>

3.  С главного сервера копируем файлы `/etc/fraudwall/pki/ca.cer` и
    `/etc/fraudwall/pki/ca.key` и заменяем ими аналогичные файлы на всех
    серверах (кроме серверов обновлений) всех филиалов банка.

4.  После замены файлов сертификатов на каждом из серверов выполняем
    команду `fw_cert`

5.  На главном сервере управления заходим в интерфейс администрирования
    по адресу [](https://IP_адрес_главного_сервера_управления:1000).

6.  Заходим в пункт «Инфраструктура системы» меню «Система» и
    регистрируем серверы управления филиалов.
    
    ![Регистрация нового сервера управления](images/figure81.jpg)

### Работа с интерфейсом главного сервера управления

Для просмотра инфраструктуры сети банка необходимо во вкладке «Система»
выбрать раздел «Инфраструктура системы» или нажать на пиктограмму сети
в правой нижней части окна.

![Интерфейс инфраструктуры системы](images/figure84.jpg)

Проблемные серверы можно легко обнаружить по мигающему красному цвету.
При этом выделяется пункт с ошибкой, повлекшей за собой проблемы:
обмен с главным сервером управления, обновление FraudWall или ОС и
другие. Важной особенностью является то, что при потере сервером
филиала соединения с главным сервером управления, не возникает
проблем в работе филиала, но теряется возможность обмена данными,
поэтому следует как можно скорее устранять подобные разрывы.

![Информация о сервере](images/figure82.jpg)

Из интерфейса FraudWall главного сервера управления можно перейти к
администрированию любого сервера управления филиала с возможностью
полноценной работы в роли администратора, то есть с возможностью
внесения изменений в конфигурацию системы, просмотра аналитики,
платежей.

![Выбор сервера управления для администрирования](images/figure83.jpg)

## Сервис FraudTrack

### Общее описание

Система FraudWall является решением, все компоненты которой
устанавливаются только в банке. На стороне клиента
каких-либо агентов либо специфического программного обеспечения
не ставится.

FraudWall также не является облачным решением - вся обработка и хранение
данных осуществляется только внутри банка.

С одной стороны, это хорошо - получить несанкционированный доступ к
антифрод-системе практически невозможно. Но с другой стороны, такой
подход не позволяет учитывать информацию о состоянии компьютера клиента
- есть ли на нем вредоносное программное обеспечение, удаленное
подключение и т.д.

Для устранения этого недостатка, FraudWall позволяет интегрироваться с
облачными решениями сторонних производителей. Данные решения на
стороне клиента банка запускают специализированное программное
обеспечение, осуществляющее поиск банковских троянов, подозрительной
активности на компьютере и т.д.

Результат проверки компьютера клиента банка поступает на сервера
облачного провайдера. В свою очередь, FraudWall запрашивает у
облачного провайдера результат проверки, а затем учитывает его при
анализе платежных поручений, создаваемых в системе ДБО. Такая
технология носит название **сервис FraudTrack**.

> **Warning**
> 
> Поддержка сервиса FraudTrack является опциональной и лицензируется
> отдельно

FraudWall поддерживает следующих облачных провайдеров:

  - [IBM Trusteer Pinpoint Malware
    Detection](http://www.ibm.com/software/products/en/trusteer-pinpoint-malware-detection)

  - [Group-IB Bot-Trek Secure
    Bank](http://www.group-ib.ru/secure_bank.html)

  - [Kaspersky Fraud Prevention
    Cloud](https://www.kaspersky.com/enterprise-security/fraud-prevention)

### Схема работы сервиса FraudTrack

Общая схема работы сервиса FraudTrack показана на рисунке:

![Общая схема работы сервиса FraudTrack](images/figure88.jpg)

Сервер управления при необходимости соединяется с серверами облачного
провайдера и получает от них информацию, связанную с состоянием
компьютера клиента банка. В дальнейшем, данная информация
учитывается при анализе платежных поручений в системе ДБО -
если в процессе создания платежки были зафиксирована подозрительная
активность на компьютере клиента, такой платеж будет считаться более
подозрительным.

### Конфигурирование сервиса FraudTrack

Конфигурирование сервиса FraudTrack осуществляется через интерфейс
**Система\\Сайты** в группе параметров FraudTrack:

![Конфигурирование сервиса FraudTrack](images/figure89.jpg)

### Конфигурирование межсетевого экрана для работы сервиса FraudTrack

Непосредственное взаимодействие с серверами облачного провайдера
осуществляет сервер управления - он является инициатором
установки TCP-соединения.

На межсетевом экране необходимо дополнительно открыть доступ с сервера
управления на сервера облачного провайдера по соответствующим портам.

### Особенности интеграции с IBM Trusteer Pinpoint Malware Detection

1.  Перед началом конфигурирования FraudTrack необходимо подготовить
    файл в формате PKCS\#7, содержащий секретный ключ, сертификат, а
    также полную цепочку сертификатов удостоверяющих центров. Секретный
    ключ и сертификат формируются согласно документации к IBM Trusteer
    Pinpoint Malware Detection, а затем совместно с набором сертификатов
    удостоверяющих центров экспортируется в файл формата PKCS\#7 (при
    экспорте в качестве пароля необходимо использовать только цифры и
    латинские буквы).
    
    > **Warning**
    > 
    > Обратите внимание - сертификат для общения с серверами облачного
    > провайдера - это не сертификат, указываемый при конфигурировании
    > Web-сайта ДБО.

2.  В параметре "URL доступа к API облачного провайдера" необходимо
    указать URL, сформированный с учетом Application code (см.
    документацию по IBM Trusteer Pinpoint Malware Detection) по
    следующему примеру:`https://1.2.3.4/88888/api/session`
    
    где **88888** - это присвоенный Application code

3.  Для удобства конфигурирования правил, FraudWall соотносит уровни
    риска IBM Trusteer Pinpoint Malware Detection по следующему
    алгоритму:
    
    | Уровень IBM Trusteer Pinpoint Malware Detection | Уровень FraudWall |
    | ----------------------------------------------- | ----------------- |
    | 0 - 200                                         | незначительный    |
    | 201 - 400                                       | небольшой         |
    | 401 - 600                                       | средний           |
    | 601 - 800                                       | большой           |
    | 801 - 1000                                      | очень большой     |
    

    Соответствие уровней риска

### Особенности интеграции с Group-IB Bot-Trek Secure Bank

1.  В качестве файла с SSL-сертификатом можно указывать файл, содержащий
    цепочку сертификатов удостоверяющих центров (в PEM-формате)

2.  Для удобства конфигурирования правил, FraudWall соотносит уровни
    риска Group-IB Bot-Trek Secure Bank по следующему алгоритму:
    
    | Уровень Group-IB Bot-Trek Secure Bank | Уровень FraudWall |
    | ------------------------------------- | ----------------- |
    | 1 (low)                               | небольшой         |
    | 2 (medium)                            | средний           |
    | 3 (high)                              | очень большой     |
    

    Соответствие уровней риска

### Особенности интеграции с Kaspersky Fraud Prevention Cloud

## Система FraudInform

### Общее описание

FraudInform — это автоматизированная система голосового подтверждения
подозрительных платежей. Когда антифрод-система FraudWall выявила
подозрительный платеж, FraudInform автоматически звонит клиенту и
ведет с ним голосовое общение. При этом произносимая речь
синтезируется, а ответы клиента распознаются с помощью
специализированной системы VoiceNavigator от компании [ЦРТ ("Центр
Речевых Технологий")](http://www.speechpro.ru). По результатам общения
платеж либо исполняется, либо останавливается.

Система FraudInform состоит из 3-х компонент:

  - антифрод-системы FraudWall, которая обнаруживает подозрительные
    платежи

  - сервера синтеза и распознавания речи VoiceNavigator

  - голосовой платформы Asterisk, осуществляющей звонок и общение с
    клиентом, которая устанавливается на сервер управления
    FraudWall

Схема взаимодействия компонентов системы представлена на рисунке:

![Схема взаимодействия компонентов системы
FraudInform](images/figure91.jpg)

### Установка системы FraudInform

После установки и настройки системы FraudWall необходимо выполнить
установку компонентов голосовой платформы FraudInform: `  yum
install asterisk-fraudwall `

На межсетевом экране необходимо дополнительно прописать следующий
доступ:

| порты                                                                         | направление трафика                                        |
| ----------------------------------------------------------------------------- | ---------------------------------------------------------- |
| UDP 5060 и TCP 5060 (протокол SIP)                                            | от сервера управления к АТС Банка                          |
| UDP 10000-20000 (протокол RTP)                                                | от АТС Банка и сервера VoiceNavigator к серверу управления |
| UDP 10000-32767 (или иной, в зависимости от настроек АТС Банка, протокол RTP) | от сервера управления к АТС Банка                          |
| TCP 8000 (протокол RTSP)                                                      | от сервера управления к серверу VoiceNavigator             |
| UDP 32768-40960 (протокол RTP)                                                | от сервера управления к серверу VoiceNavigator             |

Список сетевых портов, используемых системой FraudInform

> **Note**
> 
> В конфигурации FraudInform разрешена работа только по единственному
> кодеку **G711-alaw** (также известный как **alaw** или PCMA). Это
> необходимо для того, чтобы исключить транскодирование звукового
> потока (так называемые "бульки" в речи), т.к. VoiceNavigator
> также поддерживает только этот кодек.

### Установка системы VoiceNavigator

Установка системы VoiceNavigator осуществляется согласно “Руководству по
установке” из архива с дистрибутивом системы. VoiceNavigator
устанавливается на отдельном сервере или виртуальной машине
с ОС Microsoft Windows Server 2012 R2 Standard.

Необходимые системные требования и требования к программному обеспечению
представлены в п.п. 4.1.1 “Требования к вычислительным средствам” и п.п.
4.2.2 “Требования к общему программному обеспечению” руководства по
установке.

При использовании пробной версии системы на 4 канала синтеза и
распознавания достаточно виртуальной машины с 1 процессором и
1Гб оперативной памяти.

Настройка системы VoiceNavigator осуществляется при помощи утилиты
“**MRCP Server configuration tool**” (Пуск\>Speech Technology
Center\>MRCP Server configuration tool).

В настройках необходимы изменения только в 2-х пунктах, остальные
параметры необходимоы оставить по умолчанию:

\- в настройках подключения к голосовой платформе в **обоих**пунктах “IP
адрес сервера” и “Внешний IP сервера” необходимо указать IP адрес
сервера, на котором развернут VoiceNavigator

![Настройка подключения к голосовой платформе](images/figure92.jpg)

\- в настройках параметров синтеза значение пункта “Голос по умолчанию”
должно быть изменено на **Юлия8000**

![Настройка параметров синтеза](images/figure93.jpg)

> **Note**
> 
> В зависимости от лицензии VoiceNavigator также доступны следующие
> голоса: **Александр8000**, **Анна8000**, **Владимир8000**,
> **Лидия8000**, **Мария8000**, **Юлия8000**. Вы можете
> поэкспериментировать с различными голосами, чтобы выбрать
> наиболее дружелюбный.

### Настройка соединения с VoiceNavigator

Соединение FraudInform с сервером синтеза и распознавания речи
VoiceNavigator осуществляется по протоколу MRCPv1, который в свою
очередь использует протоколы RTSP и RTP. Конфигурационный файл с
настройками данного соединения находится на сервере FraudInform по
следующему пути: `/etc/asterisk/mrcp.conf`.

В этом файле необходимо изменить следующие параметры:

  - **server-ip** - IP адрес сервера VoiceNavigator

  - **rtp-ip** - IP адрес сервера управления FraudWall

Остальные параметры остаются по умолчанию.

После внесения изменений необходимо выполнить команду: `service asterisk
restart`

### Настройка соединения с ATC Банка

Для соединения FraudInform с АТС Банка используется протоколы SIP и RTP,
настройка осуществляется в файле`  /etc/asterisk/sip_ats.conf `.

В этом файле необходимо изменить следующие параметры:

  - **host** - IP адрес АТС Банка

  - **fromdomain** - IP адрес сервера управления FraudWall

  - **fromuser** - имя/номер\_телефона, выделенный для регистрации на
    АТС

  - **defaultuser** - имя/номер\_телефона, выделенный для регистрации на
    АТС (аналогично fromuser)

  - **remotesecret** - пароль для регистрации на АТС

После внесения изменений необходимо выполнить команду: ` service
asterisk restart  `

### Настройка правил набора номера телефона

В системе FraudInform предусмотрено автоматическое преобразование
телефонных номеров, содержащих код города, а также номеров
сотовых операторов к 11-ти значному формату вида 7xxxxxxxxxxx.
Телефонные номера, в которых не указан код города, а также внутренние
номера набираются как цифры.

Если банковская АТС не поддерживает набор номера в таком формате, в
системе FraudInform предусмотрены правила корректировки номера
телефона перед передачей его в банковскую АТС. Для таких целей
используется конфигурационный файл `/etc/asterisk/dialog_dial.conf`

По умолчанию в этом файле прописаны следующие правила преобразования
телефонного номера:

  - все 11-ти значные номера, начинающиеся с цифры 7 или 8, перед
    вызовом приводятся к формату 8хххххххххх

  - для всех 7-ми, 6-ти и 5-ти значных номеров перед вызовом добавляется
    префикс 8 (т.е. телефонный номер 123-45-67 будет набираться как
    81234567)

  - все номера длиной менее 5 цифр считаются внутренними и набираются
    без изменений

  - звонки на номера других форматов не осуществляются

Если в банковской АТС другие требования к набору номера, необходимо
подкорректировать эти правила. После внесения изменений необходимо
выполнить команду: ` service asterisk restart  `

### Настройка специфичных для банка параметров

Настройки специфичных для банка параметров диалога с клиентом
осуществляется в файле`  /etc/asterisk/dialog_vars.conf `.

В этом файле необходимо изменить следующие параметры:

  - **OPER\_NUM** - Номер телефона сотрудника банка, по которому будет
    звонить система, если долго не удается дозвониться до клиента

  - **BANK\_FROM** - Название банка (заключенное в двойных кавычках),
    которое будет произноситься при приветствии клиента.

После внесения изменений необходимо выполнить команду: `service asterisk
restart`

### Настройка диалога общения с клиентом

Сценарий разговора с клиентом может быть отредактирован в зависимости от
требований банка. Например, можно изменить текст, который будет
произнесен клиенту, либо полностью изменить сценарий общения.

Сценарий диалога с клиентом банка конфигурируется в файле ` 
/etc/asterisk/dialog.conf `

После внесения изменений необходимо выполнить команду: `service asterisk
restart`

> **Warning**
> 
> Некорректная конфигурация может привести к полному прекращению работы
> системы FraudInform.

### Конфигурирование системы FraudInform

Активация процесса автоматического обзвона клиентов осуществляется через
интерфейс **Система\\Сайты** в группе параметров **FraudInform**:

![Вкладка конфигурирования FraudInform](images/figure94.jpg)

Здесь же устанавливается максимальная сумма платежа для автоматического
подтверждения. Подозрительные платежи на очень большие суммы
рекомендуется подтверждать с помощью "живого" общения
сотрудника банка с клиентом.

### Диагностика работоспособности компонент

Для успешного общения с клиентом системе FraudInform необходимо
одновременное выполнение следующих требований:

  - телефон клиента банка, который создал подозрительное платежное
    поручение, доступен через VIEW **fraudwall\_contact** или VIEW
    **fraudwall\_contact\_doc**

  - в свойствах сайта во вкладке FraudInform выставлено соответствующее
    значение параметра "**Автоматически звонить клиенту по
    подозрительным платежам**"

  - сумма подозрительного документа не превышает порогового значения,
    указанного в свойствах соответствующего сайта

  - на сервере VoiceNavigator запущены оба сервиса **STC MRCPServer** и
    **STC TTSControl**

  - на сервере управления FraudWall правильно сконфигурированы файлы
    `/etc/asterisk/sip_ats.conf` и `/etc/asterisk/mrcp.conf`

  - на межсетевом экране настроен необходимый доступ

  - в АТС банка предпочтительным кодеком выставлен кодек **alaw** (PCMA,
    G711-alaw)

Перед началом тестирования необходимо в консоли сервера управления
FraudWall выполнить команду (число символов **v** в командной строке
нужно не менее 5): `asterisk -rvvvvvvvvvvvvvvvvv`

Начинать тестирование системы рекомендуется, подключившись к Asterisk на
сервере управления FraudWall с помощью программного SIP-софтфона
(например программных софтфонов X-Lite или Ekiga) и, подключенных
к компьютеру, динамика с микрофоном.

В настройках подключения софтфона необходимо указать следующие настройки
(они прописаны в файле `/etc/asterisk/sip_test.conf`):

  - IP адрес SIP Proxy/Регистратора — IP адрес сервера управления
    FraudWall

  - Имя пользователя / Имя для авторизации — 100

  - Пароль — fw\_password

  - кодек alaw (или PCMA, G711-alaw) должен быть разрешен

После успешной регистрации софтфона на нем необходимо набрать номер 101.
В ответ вы услышите приветствие и голосовое меню диагностики подключений
системы. А затем, набрав на клавиатуре софтфона цифру 1, вы должны
услышать голос, синтезируемый сервером VoiceNavigator.

Если в ответ тишина, первоначально нужно убедиться в отсутствии ошибок,
выводимых в консоли запущенного ранее asterisk. Если есть ошибки -
соответственно попытаться устранить их либо самостоятельно, либо с
помощью технической поддержки.

> **Warning**
> 
> Иногда бывает так, что сервис STC TTSControl не стартует по причине
> недостатка памяти (если установлено много голосов генерации, то
> каждый будет потреблять несколько сотен мб памяти). В данном
> случае необходимо удалить все голоса кроме одного (например "STC
> RussianUS Julia 8000"). После удаления голосов необходимо
> перезагрузить компьютер.

Для диагностики подключения к АТС Банка необходимо набрать номер 101 с
софтфона, дождаться ответа от голосового меню, а затем набрать номер
телефона для звонка через АТС (можно делать тестовый звонок как на
внутренний номер, так и на городской номер).

Если в консоли asterisk отсутствуют какие-либо ошибки, но при этом в
трубке "тишина", необходимо проверить наличие доступа на межсетевом
экране, а также отсутствие каких-либо трансляций SIP-трафика в
конфигурации АТС.

Если в трубке слышна синтезируемая речь, но наблюдаются характерные
"бульки", необходимо удостоверится, что в АТС приоритетным является
кодек alaw (остальные кодеки лучше вообще отключить).

При корректной конфигурации всех компонент системы FraudInform и
выполнении всех необходимых требований для его работы, обзвон
клиентов начнется автоматически.

### Запись разговоров системы

Система FraudInform ведет запись всех разговоров с клиентами Банка.

Записи храняться в каталоге ` /var/spool/asterisk/monitor  ` в формате
.wav

Записи системой не удаляются. Чтобы избежать переполнения дискового
пространства, рекомендуется периодически выгружать файлы с записями
во внешнюю систему хранения в рамках регламентных работ по обслуживанию
сервера.

# Администрирование системы FraudWall

## Администрирование операционной системы

### Общие положения

Несмотря на то, что сервер с установленной системой FraudWall рассчитан
на автономную многолетнюю работу, ряд операций, связанных с
администрированием операционной системы, придется выполнять
вручную.

Для администрирования операционной системы RedHat Enterprise Linux
рекомендуется пройти обучение на соответствующих курсах в
специализированных учебных центрах.

Для получения помощи по использованию команд необходимо выполнить
команду: `man имя_команды`

На большинство вопросов можно получить ответ, воспользовавшись
поисковыми системами в сети Интернет.

  - Self-support Subscription

  - Standard Subscription

  - Premium Subscription

Более детальную информацию по условиям технической поддержки RedHat
можно уточнить на сайте компании RedHat.

Системное администрирование сервера с FraudWall осуществляется по
протоколу SSH (см. раздел [Администрирование через
SSH-консоль](#admin_shell)).

Для обмена файлами с сервером предусмотрено 2 варианта:

  - по протоколу SCP либо SFTP (см. раздел [Интерфейс передачи файлов
    посредством протоколов SCP и SFTP](#admin_file_ssh))

  - по сетевому диску (network share) сети Microsoft (см. раздел
    [Интерфейс передачи файлов посредством сетевых дисков сети
    Microsoft](#admin_file_samba))

Существует также Web-интерфейс системы мониторинга, доступный по
протоколу HTTP на порту TCP 2812, позволяющий посмотреть статус
контролируемых сервисов в режиме «только чтение».

### Администрирование через SSH-консоль

Консольное администрирование всех серверов с системой FraudWall
осуществляется по шифрованному протоколу SSH.

В качестве SSH-клиента можно использовать любое программное обеспечение,
например, [PuTTY](http://www.chiark.greenend.org.uk/~sgtatham/putty/). В
настройках SSH-клиента необходимо указать кодировку символов UTF-8:

![Выбор кодировки для администрирования](./images/figure13.jpg)

### Интерфейс передачи файлов посредством протоколов SCP и SFTP

Обмен файлами посредством протоколов SCP и SFTP осуществляется внутри
шифрованного SSH-туннеля.

На компьютер администратора необходимо установить соответствующее
программное обеспечение, например, [WinSCP](http://winscp.net/).
В настройках SSH-клиента необходимо указать кодировку символов UTF-8.

Для увеличения скорости передачи файлов по протоколу SCP(SFTP), во
вкладке \[SSH\] рекомендуется установить алгоритм шифрования
blowfish первым используемым алгоритмом. Например, для плагина WinSCP к
файловому менеджеру FAR такая настройка выглядит следующим образом:

![Выбор алгоритма шифрования](./images/figure15.jpg)

### Интерфейс передачи файлов посредством сетевых дисков сети Microsoft

Для упрощенных задач администрирования предусмотрен обмен файлами
посредством сетевых дисков сети Microsoft.

Для подключения к сетевым дискам сервера FraudWall, необходимо в
Проводнике открыть путь `\\IP_адрес_сервера`, либо найти
компьютер в сети Microsoft с соответствующим именем (рабочая
группа **WORKGROUP**):

![Подключение к сетевым дискам сервера FraudWall](./images/figure12.jpg)

В операционной системе предусмотрены следующие учетные записи,
посредством которых можно подключиться к сетевым дискам
сервера
FraudWall:

|  Логин   | Типовая роль                                                                                                                                                |
| :------: | ----------------------------------------------------------------------------------------------------------------------------------------------------------- |
|   root   | администрирование операционной системы                                                                                                                      |
|   dbo    | обновление файлов WWW-сервера ДБО (например, если модуль BSI.JAR установлен непосредственно на сервер FraudWall и он является WWW-сервером для системы ДБО) |
|  backup  | автоматизированный перенос архивов журналов событий и дампов трафика с сервера FraudWall на внешний архивный сервер                                         |
| security | для импорта списков 550-П и просмотра журнала событий из /var/log/fraudwall и /var/log/archive                                                              |
|  podft   | для импорта списков 550-П                                                                                                                                   |

Пользователи операционной системы, которые могут подключиться к сетевым
дискам сервера FraudWall

В качестве пароля необходимо использовать соответствующий пароль в
операционной системе, заданный с помощью утилиты **fw\_passwd**

> **Warning**
> 
> Обратите внимание, что для установки пароля пользователя в
> операционной системе необходимо использовать утилиту
> **fw\_passwd**, поставляемую в комплекте программного обеспечения
> FraudWall. Сервис SAMBA, который обеспечивает функционал подключения к
> файловым ресурсам Linux, использует отдельный пароль, не связанный с
> паролем операционной системы. Поэтому, если в операционной системе
> пароль пользователя изменен с помощью штатной системной утилиты
> **passwd** (а не утилиты **fw\_passwd**), пароль пользователя,
> используемый для подключения сетевым дискам, не будет
> синхронизирован.

На сервере предусмотрены следующие сетевые диски:

<table>
<caption>Доступные сетевые диски</caption>
<thead>
<tr class="header">
<th style="text-align: center;">Диск</th>
<th style="text-align: center;">Доступ</th>
<th style="text-align: center;">Аналог файлового пути Linux</th>
<th>Назначение</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">disk</td>
<td style="text-align: center;"><p>root</p>
<p>только для чтения</p></td>
<td style="text-align: center;">/</td>
<td>позволяет прочитать любой файл на диске сервера</td>
</tr>
<tr class="even">
<td style="text-align: center;">log</td>
<td style="text-align: center;"><p>root, security</p>
<p>только для чтения</p></td>
<td style="text-align: center;">/var/log/</td>
<td>чтение журналов событий, хранящихся в виде файлов</td>
</tr>
<tr class="odd">
<td style="text-align: center;">archive</td>
<td style="text-align: center;"><p>root, backup, security</p>
<p>чтение / запись</p></td>
<td style="text-align: center;">/var/log/archive/</td>
<td>для переноса архивных файлов с сервера FraudWall на другой сервер (либо внешний носитель)</td>
</tr>
<tr class="even">
<td style="text-align: center;">550p</td>
<td style="text-align: center;"><p>root, security, podft</p>
<p>чтение / запись</p></td>
<td style="text-align: center;">/etc/fraudwall/blacklist/550p</td>
<td>для импорта списков по 550-П</td>
</tr>
<tr class="odd">
<td style="text-align: center;">bsi</td>
<td style="text-align: center;"><p>root, dbo</p>
<p>чтение / запись</p></td>
<td style="text-align: center;">/etc/tomcat6/RT_Ic/</td>
<td>Для записи на сервер файлов модуля BSI системы BSClient (появляется, если модуль BSI системы BSClient устанавливается непосредственно на сервер FraudWall)</td>
</tr>
<tr class="even">
<td style="text-align: center;">siteN</td>
<td style="text-align: center;"><p>root, dbo</p>
<p>чтение / запись</p></td>
<td style="text-align: center;">/etc/fraudwall/site/www/siteN</td>
<td>Для записи на сервер файлов WWW-сайта с ID=N</td>
</tr>
</tbody>
</table>

### Пользователи операционной системы

При установке системы пользователю **root**, обладающему неограниченными
правами в операционной системе, присваивается пароль **12345**.

Для изменения пароля пользователя операционной системы необходимо
выполнить команду: `fw_passwd имя_пользователя`

> **Warning**
> 
> Для подключения к сетевым дискам сервера необходимо хотя бы один раз
> установить пароль пользователя root с помощью утилиты
> **fw\_passwd**.

Существует также ряд команд по созданию (useradd), удалению (userdel)
пользователей и групп (groupadd и groupdel соответственно) - более
подробное описание их можно получить в специализированной литературе
по администрированию операционной системы Linux.

> **Warning**
> 
> Если вы забыли пароль пользователя root, существует процедура его
> сброса на первоначальное значение, требующая перезагрузки
> сервера. Для получения детальных инструкций обратитесь в службу
> технической поддержки.

### Администрирование сетевых настроек

Для сетевого взаимодействия в системе используется один Ethernet-адаптер
со статическим IP адресом.

Для изменения сетевых настроек необходимо выполнить команду: `service
fw_setup start`

После указания сетевых настроек, они вступают в силу сразу по завершению
выполнения команды.

> **Warning**
> 
> При смене IP адреса сервера обязательно проверьте значение IP адресов,
> указанных в файле `/etc/fraudwall/fraudwall.xml` (старый IP адрес
> может встречаться в нескольких местах этого файла)

#### Действия в случае изменения MAC-адреса сетевой платы сервера

При изменении MAC-адреса сетевой платы (например, при клонировании
виртуальной машины либо замене сетевой платы) необходимо выполнить
команду: `rm -f /etc/udev/rules.d/70-persistent-net.rules`после чего
перегрузить сервер командой `reboot`

### Конфигурирование межсетевых экранов

На сервере отключена локальная служба межсетевого экранирования. Для
защиты сервера FraudWall от несанкционированного доступа по сети
необходимо использовать специализированные сторонние межсетевые
экраны.

Полный перечень сетевых портов, необходимых для написания правил
межсетевого экранирования, приведен в
таблице:

| доступ                                                                                  | назначение                                                                                                                                                                                         |
| :-------------------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| от компьютеров администраторов к этому серверу по TCP 22, 2812, 139, 445 и UDP 137, 138 | администрирование сервера, доступ к сетевым ресурсам сервера                                                                                                                                       |
| от этого сервера к банковскому DNS-серверу по UDP 53 и TCP 53                           | распознавание DNS-имен                                                                                                                                                                             |
| от этого сервера к NTP-серверу синхронизации времени банка по UDP 123                   | синхронизация времени                                                                                                                                                                              |
| от этого сервера к прокси-серверу банка на TCP порт прокси-сервера                      | получение обновлений из сети Интернет в прокси-режиме (если обновление идет через банковский прокси-сервер). Если в банке устанавливается WWW-сервер обновлений, доступ открывать только для него. |
| от этого сервера ко всей сети интернет по TCP 80 и 443                                  | получение обновлений из сети Интернет (если обновление идет прямым соединением с сервером в сети Интернет). Если в банке устанавливается WWW-сервер обновлений, доступ открывать только для него.  |
| от этого сервера к WWW-серверу обновлений по TCP 1003                                   | получение обновлений от WWW-сервера обновлений (если он установлен)                                                                                                                                |

Доступ, необходимый для любого сервера
FraudWall

| доступ                                                         | назначение                                                                    |
| :------------------------------------------------------------- | :---------------------------------------------------------------------------- |
| от пользователей системы FraudWall к этому серверу по TCP 1000 | работа в WWW-интерфейсе системы                                               |
| от этого сервера ко всей сети интернет по TCP 43               | получение WHOIS-информации об IP адресе в интерфейсе системы (не обязательно) |
| от этого сервера к банковскому почтовому серверу по TCP 25     | отправка информационных сообщений по SMTP-почте                               |
| от банковского почтового сервера к этому серверу по TCP 25     | получение писем антидроп-клуба                                                |

Дополнительный доступ для сервера
управления

| доступ                                                          | назначение                                      |
| :-------------------------------------------------------------- | :---------------------------------------------- |
| от этого сервера к серверу управления по TCP 1000, 5432 и 11211 | внутренний информационный обмен                 |
| от сервера управления к этому серверу по TCP 1001               | внутренний информационный обмен                 |
| от этого сервера к банковскому почтовому серверу по TCP 25      | отправка информационных сообщений по SMTP-почте |

Дополнительный доступ для сервера анализа трафика (если установлен)

### Подсистема журналирования

Журналы событий всех процессов сервера хранятся в файлах в директории
`/var/log`.

Дата и время во всех журналах событий представлено во временной зоне UTC
(GMT). На 1 января 2012г. время в зоне UTC отставало от московского на 4
часа (т.е. если московское время 14:00, время события в журнале событий
будет зафиксировано как 10:00).

Назначение основных файлов журналов приведено в
таблице:

| Файл                                        | Назначение                                                                                                                                  |
| ------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------- |
| `/var/log/messages`                         | Основной файл журналов событий операционной системы                                                                                         |
| `/var/log/maillog`                          | Файл журналов событий почтовой системы                                                                                                      |
| `/var/log/monit`                            | Файл журналов событий системы мониторинга и самовосстановления                                                                              |
| `/var/log/yum.log`                          | Файл журналов событий установки обновлений                                                                                                  |
| `/var/log/sa/sarДД`                         | История загрузки ресурсов сервера за заданную дату                                                                                          |
| `/var/log/postgresql/ postgresql-*`         | Файл журналов событий базы данных PostgreSQL. Имя файла соответствует дате запуска сервиса.                                                 |
| `/var/log/tomcat6/catalina-*`               | Файл журналов событий Tomcat. Имя файла соответствует дате запуска сервиса.                                                                 |
| `/var/log/fraudwall/fw_control.log`         | Файл журналов событий модуля управления системы FraudWall.                                                                                  |
| `/var/log/fraudwall/ fw_master_access.log`  | Файл журналов событий управляющего WWW-сервера системы FraudWall.                                                                           |
| `/var/log/fraudwall/ fw_master_error.log`   | Файл журналов ошибок управляющего WWW-сервера системы FraudWall.                                                                            |
| `/var/log/fraudwall/ fw_slave_access.log`   | Файл журналов событий исполнительного WWW-сервера системы FraudWall.                                                                        |
| `/var/log/fraudwall/ fw_slave_error.log`    | Файл журналов ошибок исполнительного WWW-сервера системы FraudWall.                                                                         |
| `/var/log/fraudwall/ hguard.log`            | Файл журналов ошибок модуля «hGuard. Модуль фильтрации HTTP-трафика»                                                                        |
| `/var/log/fraudwall/ siteN-af.log`          | Файл журналов ошибок модуля «FraudWall. Анализатор трафика» для сайта с ID=N                                                                |
| `/var/log/fraudwall/ siteN-afdb.log`        | Файл журналов ошибок анализатора платежей из базы данных для сайта с ID=N                                                                   |
| `/var/log/fraudwall/ siteN-http_access.log` | Файл журналов событий WWW-сервера Apache модуля «hGuard. Модуль фильтрации HTTP-трафика» для сайта с ID=N                                   |
| `/var/log/fraudwall/ siteN-http_error.log`  | Файл журналов ошибок WWW-сервера Apache модуля «hGuard. Модуль фильтрации HTTP-трафика» для сайта с ID=N                                    |
| `/var/log/fraudwall/ siteN-jk.log`          | Файл журналов событий модуля mod\_jk, применимых к сайту с ID=N                                                                             |
| `/var/log/fraudwall/ siteN-learn.log`       | Файл журналов событий процесса получения исполненных платежей из базы данных ДБО или АБС                                                    |
| `/var/log/fraudwall/ siteN-learn.dat.last`  | Файл, в котором хранится дата (в зоне UTC), по которую завершилось обучение по исполненным платежам в базе данных ДБО или АБС               |
| `/var/log/fraudwall/ fw_site_access.log`    | Файл журналов событий WWW-сервера Apache модуля «hGuard. Модуль фильтрации HTTP-трафика» для запросов, не относящихся ни к одному из сайтов |
| `/var/log/fraudwall/ fw_site_error.log`     | Файл журналов ошибок WWW-сервера Apache модуля «hGuard. Модуль фильтрации HTTP-трафика» для запросов, не относящихся ни к одному из сайтов  |
| `/var/log/fraudwall/mod_jk.log`             | Файл журналов событий модуля mod\_jk                                                                                                        |

Каждую ночь автоматически осуществляется переключение файлов старых
журналов событий и помещение их в архивные файлы в директорию
`/var/log/archive`.

Имя архивного файла формируется по правилу:
`тип-датаГГГГММДД_времяЧЧММСС-имя_сервера.расширение`

  - fwlog - архивы файлов событий системы FraudWall

  - syslog - архивы файлов событий операционной системы

  - dump - архивы дампа трафика работы клиентов

В качестве программы - архиватора используется rar (если установлен),
либо tar с сжатием BZIP2 (если не установлен rar). В соответствии с
используемым архиватором, расширение будет **.rar** либо **.tar.bz2**.

В случае использования программы - архиватора rar, возможно
дополнительное шифрование содержимого архивов по паролю.
Пароль шифрования указывается в параметре archive\_password в
конфигурационном файле `fwcontrol.xml`.

### Регламентные процедуры

Рекомендуется ежедневно переносить архивные файлы с журналами событий,
созданные в директории `/var/log/archive` (сетевой диск **archive**),
на внешний носитель.

Рекомендуется обновлять программное обеспечение операционной системы в
малозагруженное время, но не реже, чем 1 раза в неделю.

Рекомендуется также периодически просматривать файлы журналов событий на
наличие критичных записей (ошибки обновления, проблемы в работе и т.д.).

Рекомендуется периодически формировать архивный образ жестких дисков
всех серверов системы специализированными средствами создания
резервных копий.

## Администрирование системы FraudWall

### Общие положения

Служебные конфигурационные файлы компонент системы FraudWall
располагаются в директории `/etc/fraudwall` (файлы
`fwcontrol.xml` и `fraudwall.xml`).

Прикладное администрирование системы FraudWall осуществляется через
WWW-интерфейс.

### Конфигурационный файл fwcontrol.xml

Конфигурационный файл fwcontrol.xml представляет собой XML-файл в
кодировке UTF.

Данный файл содержит в себе параметры ограниченного доступа, которые
должны быть доступны только пользователю root.

Синтаксис строки параметра следующий:

    <option name="параметр" value="значение"/>

> **Warning**
> 
> Так как файл `fwcontrol.xml` имеет синтаксис XML, при указании
> значений параметров необходимо учитывать необходимость
> преобразования некоторых спецсимволов. Детали можно уточнить
> по ссылке <http://ru.wikipedia.org/wiki/XML>

<table>
<caption>Перечень параметров файла <code>fwcontrol.xml</code></caption>
<thead>
<tr class="header">
<th style="text-align: center;">параметр</th>
<th style="text-align: center;">допустимые значения</th>
<th>назначение</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">database_masteruser</td>
<td style="text-align: center;">текст</td>
<td><p>логин администратора базы данных</p>
<p>Логин и пароль администратора баз данных придумываются в процессе первоначальной установки системы.</p>
<blockquote>
<p><strong>Warning</strong></p>
<p>Логин должен содержать латинские символы только нижнего регистра, цифры и символ "_".</p>
<p>Значение логина и пароля не должно быть равно зарезервированным командам PostgreSQL. Например, в качестве логина нельзя использовать “user”, “superuser” и т.д. - при таких значениях в логах PostgreSQL (в директории <code>/var/log/postgresql/</code>) будет зафиксирована ошибка.</p>
<p>Логин и пароль администратора базы данных будут храниться в открытом виде в конфигурационном файле <code>fwcontrol.xml</code>. Несмотря на то, что этот файл будет доступен на чтение только пользователю с правами root, не рекомендуется использовать такой же пароль, который указан для пользователя root операционной системы.</p>
</blockquote></td>
</tr>
<tr class="even">
<td style="text-align: center;">database_masterpassword</td>
<td style="text-align: center;">текст</td>
<td>пароль администратора базы данных</td>
</tr>
<tr class="odd">
<td style="text-align: center;">archive_password</td>
<td style="text-align: center;">текст</td>
<td><p>пароль шифрования архивов журналов событий</p>
<p>Если значение параметра <code>archive_password</code> пустое, шифрование архивов не осуществляется.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>Шифрование архивов журналов событий возможно только в случае, если в качестве архиватора используется <strong>rar</strong>. В остальных случаях значение этого параметра игнорируется.</p>
</blockquote></td>
</tr>
</tbody>
</table>

Изменить логин и пароль администратора баз данных можно, выполнив на
сервере, где установлены компоненты базы данных FraudWall, команду:
`fw_dbadmin`

> **Warning**
> 
> При изменении логина администратора баз данных, старая учетная запись
> не удаляется. Процедура удаления старой учетной записи указана в
> документации к PostgreSQL.

После внесения изменений в файл `fwcontrol.xml` необходимо выполнить
команду: `service fw_control restart`

> **Note**
> 
> В случае установки компонент системы FraudWall на нескольких серверах,
> необходимо скопировать изменения на все остальные сервера.

### Конфигурационный файл fraudwall.xml

Конфигурационный файл fraudwall.xml представляет собой XML-файл в
кодировке UTF.

Данный файл содержит в себе параметры, необходимые для взаимодействия
различных компонент системы FraudWall между собой.

Синтаксис строки параметра следующий:

    <option name="параметр" value="значение"/>

> **Warning**
> 
> Так как файл `fraudwall.xml` имеет синтаксис XML, при указании
> значений параметров необходимо учитывать необходимость
> преобразования некоторых спецсимволов. Детали можно уточнить
> по ссылке `http://ru.wikipedia.org/wiki/XML`

<table>
<caption>Перечень параметров файла fraudwall.xml</caption>
<thead>
<tr class="header">
<th style="text-align: center;">параметр</th>
<th style="text-align: center;">допустимые значения</th>
<th>назначение</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">log_level</td>
<td style="text-align: center;">число от 0 до 9</td>
<td>уровень логирования компонент FraudWall, устанавливаемый по-умолчанию</td>
</tr>
<tr class="even">
<td style="text-align: center;">tz_moscowdelta</td>
<td style="text-align: center;">целое число от -23 до +23</td>
<td>смещение времени этого сервера относительно московского времени в часах</td>
</tr>
<tr class="odd">
<td style="text-align: center;">master_server</td>
<td style="text-align: center;">IP адрес</td>
<td>IP адрес сервера, на котором установлен управляющий WWW-сервер FraudWall</td>
</tr>
<tr class="even">
<td style="text-align: center;">dbha_server</td>
<td style="text-align: center;">IP адрес</td>
<td>указывает IP адрес резервного сервера базы данных. Если такого сервера не установлено, указывается пустое значение</td>
</tr>
<tr class="odd">
<td style="text-align: center;">database_server</td>
<td style="text-align: center;">IP адрес</td>
<td>IP адрес сервера, на котором установлены компоненты базы данных системы FraudWall</td>
</tr>
<tr class="even">
<td style="text-align: center;">database_user</td>
<td style="text-align: center;">текст</td>
<td><p>логин пользователя базы данных</p>
<p>Логин и пароль пользователя баз данных придумываются в процессе первоначальной установке системы.</p>
<blockquote>
<p><strong>Warning</strong></p>
<p>Логин должен содержать латинские символы только нижнего регистра, цифры и символ "_".</p>
<p>Значение логина и пароля не должно быть равно зарезервированным командам PostgreSQL. Например, в качестве логина нельзя использовать “user”, “superuser” и т.д. - при таких значениях в логах PostgreSQL (в директории <code>/var/log/postgresql/</code>) будет зафиксирована ошибка.</p>
</blockquote>
<blockquote>
<p><strong>Note</strong></p>
<p>Следует различать учетную запись пользователя баз данных, указываемую в конфигурационном файле <code>fraudwall.xml</code>, с учетной записью администратора баз данных, указываемой в конфигурационном файле <code>fwcontrol.xml</code>.</p>
<p>Учетная запись пользователя баз данных (параметр <code>database_user</code> в файле <code>fraudwall.xml</code>) используется для штатной работы всех модулей системы FraudWall. На уровне базы данных ей предоставлены ограниченные права доступа.</p>
<p>Учетная запись администратора баз данных (параметр <code>database_masteruser</code> в файле <code>fwcontrol.xml</code>) используется только модулем управления для автоматического создания схемы базы данных. На уровне базы данных ей предоставлены неограниченные права доступа.</p>
</blockquote></td>
</tr>
<tr class="odd">
<td style="text-align: center;">database_password</td>
<td style="text-align: center;">текст</td>
<td>пароль пользователя базы данных</td>
</tr>
<tr class="even">
<td style="text-align: center;">www_password_days</td>
<td style="text-align: center;">число</td>
<td>указывает, через сколько дней требовать у пользователя FraudWall сменить пароль. Отсутствие параметра или значение, равное 0, означает бесконечный срок жизни пароля пользователя в интерфейсе FraudWall</td>
</tr>
<tr class="odd">
<td style="text-align: center;">memcached_server</td>
<td style="text-align: center;">IP адрес</td>
<td>IP адрес сервера, на котором установлен сервер Memcached (необходимо указать IP адрес управляющего WWW-сервера системы FraudWall)</td>
</tr>
<tr class="even">
<td style="text-align: center;">mail_server</td>
<td style="text-align: center;">IP адрес</td>
<td><p>IP адрес банковского почтового сервера</p>
<p>При изменении этого параметра необходимо выполнить команду: <code>fw_control -s mail</code></p>
<blockquote>
<p><strong>Warning</strong></p>
<p>ВНИМАНИЕ! Почтовые сообщения, формируемые системой, носят важный характер. Обязательно проверьте конфигурацию вашего почтового сервера, что эти сообщения не будут блокироваться антиспам- и прочими фильтрами.</p>
</blockquote></td>
</tr>
<tr class="odd">
<td style="text-align: center;">mail_sasl_user</td>
<td style="text-align: center;">текст</td>
<td>Логин для SASL-аутентификации на почтовом сервере. Если SASL-аутентификация не требуется, укажите пустое значение.</td>
</tr>
<tr class="even">
<td style="text-align: center;">mail_sasl_password</td>
<td style="text-align: center;">текст</td>
<td>Пароль для SASL-аутентификации на почтовом сервере. Если SASL-аутентификация не требуется, укажите пустое значение.</td>
</tr>
<tr class="odd">
<td style="text-align: center;">mail_from</td>
<td style="text-align: center;">e-mail адрес</td>
<td>Почтовый адрес, от имени которого будут отправляться все почтовые сообщения с сервера FraudWall</td>
</tr>
<tr class="even">
<td style="text-align: center;">autoupdate_fw</td>
<td style="text-align: center;">on/off</td>
<td>on - автоматически устанавливать обновления компонент системы FraudWall, off - только информировать по почте</td>
</tr>
<tr class="odd">
<td style="text-align: center;">autoupdate_db</td>
<td style="text-align: center;">on/off</td>
<td>on - автоматически устанавливать обновления справочников (справочник БИК, GeoIP и т.д., off - только информировать по почте</td>
</tr>
<tr class="even">
<td style="text-align: center;">autoupdate_rh</td>
<td style="text-align: center;">on/off</td>
<td>on - если включено автообновление компонент FraudWall, то дополнительно обновлять операционную систему</td>
</tr>
</tbody>
</table>

#### Действия при редактировании файла fraudwall.xml

После внесения изменений в файл `fraudwall.xml` необходимо выполнить
команду: `service fw_control restart`

> **Note**
> 
> В случае установки компонент системы FraudWall на нескольких серверах,
> необходимо скопировать изменения на все остальные сервера и выполнить
> на них указанные выше команды.

### Администрирование пользователей системы FraudWall

Администрирование пользователей системы FraudWall осуществляется
посредством WWW-интерфейса в пункте «Администрирование» меню
«Пользователи»:

![Интерфейс администрирования пользователей системы
FraudWall](./images/figure47.jpg)

Для редактирования свойств существующего пользователя необходимо ввести
в поле «Пользователь» логин пользователя либо его фамилию, затем нажать
Enter.

Установить (сбросить) первоначальный пароль входа пользователя можно,
указав новый пароль в поле «`Установить первоначальный пароль`»,
затем нажать на кнопку «Сохранить»:

![Сброс пароля пользователя](./images/figure48.jpg)

Можно временно заблокировать пользователя, нажав на кнопку
«Заблокировать». Разблокирование пользователя
осуществляется нажатием на кнопку «Разблокировать».

При удалении пользователя соответствующая учетная запись помечается со
статусом «**Удален**». Восстановить удаленного пользователя
невозможно.

Права доступа каждого пользователя в системе определяются его ролью, а
также перечнем допустимых кодов БИК банка плательщика, масок расчетных
счетов плательщика, а также кодом подразделения KBOPID.

Перечень допустимых операций каждой роли можно посмотреть в помощи к
параметру «Роль пользователя»:

![Роли пользователей системы FraudWall](./images/figure49.jpg)

Списки допустимых БИК банка плательщика, масок расчетных счетов
плательщика и кодов подразделения KBOPID работают по принципу -
если указано хотя бы оно значение в списке, то пользователю доступны
платежи только попадающие под этот список. Если в списке значений
нет, то ограничений доступа по соответствующему списку пользователю
не накладывается.

Для удобства администрирования пользователей, имеющих идентичные права
доступа (например, сотрудники бэк-офиса одного и того же филиала
банка), можно настроить права доступа одному из пользователей, а
затем скопировать его права другим пользователям. При копировании
прав доступа пользователю, ранее существующие у него права будут
полностью заменены.

### Сброс пароля встроенного администратора системы FraudWall

В процессе первоначальной установки создается встроенный администратор
системы ‘**admin**’ с паролем ‘**admin**’.

В целях безопасности пароль этого пользователя рекомендуется изменить на
более сложный.

Если в процессе эксплуатации системы новый пароль пользователя
‘**admin**’ был забыт, то возможно сбросить его на первоначальное
значение. Для этого, необходимо зайти SSH-консолью под учетной
записью root и выполнить команду: `fw_control -c resetadmin`

В файле журнала событий модуля управления
`/var/log/fraudwall/fw_control.log` будет зафиксирована соответствующая
запись о результате выполнения команды.

### Аудит пользователей системы FraudWall

Действие пользователей в WWW-интерфейсе системы FraudWall
протоколируется в журнале аудита. Просмотр событий
журнала аудита осуществляется в WWW-интерфейсе системы FraudWall,
пункт «Аудит пользователей» меню «Пользователи»:

![Интерфейс аудита системы FraudWall](./images/figure50.jpg)

Интерфейс аудита позволяет найти события в том числе по удаленным
пользователям системы FraudWall.

### Конфигурирование профилей обнаружения мошеннических платежей

Все настройки по обнаружению мошеннических платежей хранятся в так
называемых профилях.

Профили могут быть применены на уровне клиента, на уровне сайта и на
уровне филиала (банка). Приоритетным считается профиль на уровне
клиента, если он не указан, то используется профиль на уровне сайта,
если на уровне сайта профиль также не указан, используется профиль на
уровне филиала (банка).

Один и тот же профиль может быть применен к нескольким филиалам банка,
нескольким сайтам и нескольким клиентам.

Редактирование свойств профиля осуществляется в пункте «Профили
антифрода» меню «Система»:

![Интерфейс редактирования свойств профиля](./images/figure51.jpg)

В рабочей системе FraudWall должен быть создан как минимум один профиль,
и к каждому банку (филиалу) должен быть привязан профиль.

Привязка профиля к банку либо его филиалу осуществляется при
конфигурировании свойств филиала (пункт «Филиалы» меню
«Система»):

![Привязка профиля к банку либо его филиалу](./images/figure52.jpg)

Привязка профиля к сайту осуществляется при конфигурировании свойств
сайта (пункт «Сайты» меню «Система», «Общие параметры»):

![Привязка профиля к сайту](./images/figure53.jpg)

Привязка профиля к клиенту банка осуществляется в интерфейсе получение
аналитических отчетов по клиенту (интерфейс «Плательщик» меню
«Аналитика»):

![Привязка профиля к клиенту банка](./images/figure54.jpg)

### Конфигурирование системы FraudWall. Банки и филиалы

Система FraudWall обнаруживает мошеннические платежи только для тех
банков (филиалов), на которые есть соответствующая лицензия.
Привязка осуществляется по коду БИК.

Один и тот же сервер FraudWall может анализировать трафик и обнаруживать
мошеннические платежи клиентов одновременно нескольких филиалов.

Как показывает практика, клиенты разных филиалов одного и того же банка,
имеют свою специфику, связанную с особенностью региона, где расположен
филиал. Помимо разного значения средних сумм платежей, которое уже
упоминалось в разделе [Конфигурирование профилей обнаружения
мошеннических платежей](#cfg_profile), это может быть часовой
пояс, в котором работают клиенты, либо другие параметры.

В системе FraudWall предусмотрена возможность устанавливать каждому
филиалу собственные настройки, либо использовать типовые правила и
параметры обнаружения мошеннических платежей.

![Интерфейс редактирования свойств банка либо
филиала](images/figure55.jpg)

> **Warning**
> 
> Необходимо убедиться, что каждому зарегистрированному банку либо
> филиалу сопоставлен профиль обнаружения мошеннических платежей

### Конфигурирование системы FraudWall. Сайты

Клиенты, работая в системе ДБО, фактически работают на Web-сайте,
который создан на WWW-сервере системы ДБО.

Так как для фильтрации трафика и обнаружения мошеннических платежей весь
трафик клиентов должен проходить через систему FraudWall, в системе
FraudWall для каждого из таких Web-сайтов ДБО создаются собственные
настройки.

Для того, чтобы трафик клиентов проходил через систему FraudWall, на
сервере FraudWall есть WWW-сервер Apache, с которым должен
соединяться клиент для работы с ДБО.

> **Warning**
> 
> Если система FraudWall интегрируется с ДБО в универсальном режиме
> (т.е. FraudWall не выступает в качестве WWW-сервера ДБО, а получает
> информацию о платежах из базы данных ДБО), все равно необходимо
> создать "виртуальный" сайт с типом "**Анализ платежей в базе
> данных (универсальный режим)**".

Интерфейс конфигурирования Web-сайтов системы FraudWall доступен через
пункт «Сайты» меню «Система»:

![Интерфейс редактирования свойств Cайта
FraudWall](./images/figure56.jpg)

Один и тот же сервер FraudWall может работать одновременно с несколькими
Web-сайтами системы ДБО. Единственное ограничение - если модуль BSI
системы ДБО BS-Client устанавливается непосредственно на сервер
FraudWall, то на этом сервере может быть настроен только один сайт с
модулем BSI (при этом, Web-сайтов, работающих в проксированном
режиме, может быть несколько).

  - На одной паре «`IP адрес сервера FraudWall:TCP порт сайта`» может
    быть несколько Web-сайтов.

  - Для определения Web-сайта из зарегистрированных в системе FraudWall
    используется соответствие «`доменное имя сайта:TCP порт сайта`».

  - Имя сайта, указанное клиентом в Internet-браузере (dbo.bank.ru в
    строке <http://dbo.bank.ru:8080>) должно совпадать с основным
    либо дополнительным доменным именем в сети Internet, указанных в
    свойствах Web-сайта в конфигурации FraudWall. Регистр символов не
    учитывается

  - Для URL вида <http://1.2.3.4>, в качестве доменного имени Web-сайта
    FraudWall необходимо указать 1.2.3.4

  - TCP-порт, указанный клиентом в Internet-браузере (80 в строке
    <http://dbo.bank.ru> или 8080 в строке <http://dbo.bank.ru:8080>),
    должен совпадать с TCP-портом, указанном в свойствах Web-сайта в
    конфигурации FraudWall

<!-- end list -->

  - На одной паре «`IP адрес сервера FraudWall:TCP порт сайта`» может
    быть только один Web-сайт.

  - **Имя сервера**, указанного клиентом в URL, игнорируется. Оно может
    как совпадать с именем, указанным в параметре «`Доменное имя в сети
    Интернет`», так и отличаться от него.

При конфигурировании Web-сайта, работающего по шифрованному протоколу
HTTPS, необходимо установить SSL-сертификат из файла формата PKCS\#12,
содержащего в том числе сертификаты всех вышестоящих удостоверяющих
центров, на которых выпущен SSL-сертификат. Процедура импорта
SSL-сертификата из операционной системы Microsoft Windows приведена
в разделе [Установка сервера управления системы
FraudWall](#fraudwall_master_install) .

SSL-сертификат в конфигурации Web-сайта системы FraudWall достаточно
установить один раз - при последующем изменении параметров этого
Web-сайта повторно импортировать SSL сертификат из файла не потребуется.

Можно настроить кеширование данных Web-сайта, что может снизить нагрузку
на WWW-сервер системы ДБО, а также объем передаваемых данных между
сервером FraudWall и WWW-сервером:

![Настройка кеширования Web-сайта FraudWall](./images/figure57.jpg)

Более подробно о кешировании трафика см.раздел [Кеширование трафика на
стороне FraudWall](#fraudwall_caching).

Трафик клиентов при работе в ДБО, который используется для обнаружения
мошеннических платежей, помещается в файл. Учитывая сложность работы с
файлами большого размера, в системе FraudWall предусмотрена возможность
переключения файла (т.е. создание нового файла с переименованием
существующего) при превышении заданного размера файла:

![Настройка максимального размера файла дампа](./images/figure58.jpg)

### Кеширование трафика на стороне FraudWall

Срок устаревания содержимого, сообщаемого WWW-сервером системы ДБО
клиенту, носит не обязательный, а рекомендательный характер.

В некоторых случаях Internet-браузер на стороне клиента игнорирует
параметры срока устаревания содержимого.

Например, при включении указанных ниже опций Internet Explorer может
запрашивать у Web-сервера файл, срок устаревания которого с
последнего посещения страницы сайта еще не прошел:

![Параметры Internet Explorer, при которых игнорируется устаревание
кеша](./images/figure59.jpg)

В этом случае Internet Explorer формирует много паразитного трафика,
состоящего из множества запросов на получение одной и той же
картинки, css-файла и т.д. Такой трафик повышает нагрузку на
Web-сервер системы ДБО, систему FraudWall и т.д.

Исходя из особенностей Internet Explorer, кеширование на стороне
FraudWall дает наибольший эффект для сайтов, работающих через
шифрованный протокол HTTPS.

При включении кеширования на стороне FraudWall, если запрашиваемое
клиентом статическое содержимое находится в кеше, то этот запрос
уже не будет перенаправлен на WWW-сервер ДБО, и клиенту будет
отправлено закешированное содержимое. Таким образом, WWW-сервер
ДБО будет заниматься в основном формированием динамического содержимого.

Срок устаревания данных в кеше аналогичен параметрам устаревания
содержимого, указанных в конфигурации Web-сервера:

![Настройка устаревания содержимого в WWW-сервере
IIS](./images/figure60.jpg)

> **Warning**
> 
> Директории, которые указаны в списке для кеширования, а также все
> нижестоящие директории должны содержать только статический
> контент. Если в них формируются динамические страницы, то их
> содержимое не будет зафиксировано в файле дампа, а соответственно,
> не будут обрабатываться анализатором трафика.
> 
> Поддиректории, указываемые в списке для кеширования, обрабатываются с
> учетом регистра символов.

### Балансировка нагрузки между WWW-серверами ДБО

Для создания отказоустойчивой схемы и балансировки нагрузки можно
использовать несколько WWW-серверов системы ДБО.

> **Warning**
> 
> Не путайте балансировку нагрузки между WWW-серверами системы ДБО и
> балансировку нагрузки между серверами FraudWall.

Каждый из WWW-серверов системы ДБО должен иметь идентичную конфигурацию
программного обеспечения: настройки WWW-сервера, содержимое сайтов и
т.д.

Балансировка нагрузки между WWW-серверами системы ДБО предусматривает
также автоматическое отключение отказавшего WWW-сервера, т.е.
отказоустойчивую среду.

Схема балансировки нагрузки показана на рисунке:

![Балансировка WWW-серверов ДБО средствами
FraudWall](./images/figure61.jpg)

Список внутренних WWW-серверов, участвующих при балансировке нагрузки
одного Web-сайта, указывается в WWW-интерфейсе FraudWall при
конфигурировании Web-сайта:

![Список внутренних WWW-серверов при балансировке
нагрузки](./images/figure62.jpg)

Приоритет WWW-сервера означает соотношение числа обрабатываемых запросов
из общего числа - чем больше приоритет, тем больше на него будет
перенаправлено запросов. Например, если приоритет 1-го сервера
10, а 2-го сервера 20, то из 30 запросов 10 будут отправлены на 1-й
сервер, а 20 оставшихся запросов - на 2-й.

Для корректной балансировки нагрузки между WWW-серверами необходимо,
чтобы Internet-браузер на стороне клиента поддерживал Cookie. Если в
Internet-браузере клиента поддержка Cookie отключена, то все его запросы
будут перенаправляться на первый работоспособный сервер из списка
внутренних WWW-серверов.

При включенной поддержке Cookie на стороне клиента, он будет
обслуживаться только тем WWW-сервером ДБО, который
обрабатывал его первый запрос.

Можно также реализовать схему, при которой, помимо балансировки
WWW-серверов системы ДБО, осуществляется балансировка серверов
FraudWall:

![Одновременная балансировка серверов FraudWall и WWW-серверов
ДБО](./images/figure63.jpg)

### Высвобождение лицензии в случае закрытия клиентом расчетного счета в банке

Система FraudWall автоматически вычисляет число используемых лицензий на
основе данных о платежах клиентов, полученных в процессе обучения
системы (т.е. из VIEW fraudwall\_learn).

При приближении числа используемых лицензий к максимальному значению,
система FraudWall формирует администраторам сервера письмо с
соответствующим предупреждением.

Возможна ситуация, когда клиент банка закрывает расторгает договор с
банком об обслуживании расчетного счета, и выделять для него
лицензию FraudWall нецелесообразно. В этом случае предусмотрено
три варианта высвобождения лицензии:

  - Вариант 1: автоматическое освобождение лицензии
    
    Данный механизм автоматически запускается в случае превышения числа
    используемых лицензий над максимально допустимым. Система FraudWall
    определяет самого неактивного клиента (т.е. клиента, который дольше
    всех не создавал платежей в ДБО), и подчищает по нему статистику.
    Высвобожденная таким образом лицензия передается новому клиенту
    банка

  - Вариант 2: освобождение лицензии в ручном режиме через интерфейс
    "Аналитика по плательщику"
    
    Чтобы не ждать, пока число лицензий достигнет максимального
    значения, можно вручную очищать статистику по клиенту банка,
    закрывшему расчетный счет - тем самым лицензия будет высвобождена
    лицензия этого клиента.
    
    Для этого необходимо зайти в интерфейс "Аналитика по плательщику",
    получить аналитику по ИНН клиента, закрывшего счет, а затем в
    группе "Очищение статистики по плательщику" указать дату
    закрытия счета (т.е. дату, до которой будет очищена
    статистика) и причину очищения статистики:
    
    ![Очищение статистики по плательщику](./images/figure86.jpg)
    
    После очищения статистики рекомендуется получить аналитику по
    очищаемому ИНН клиента повторно - в отчете "Накопленная
    статистика по плательщику" должен быть текст следующего
    содержания:
    
    ![Сообщение, отображаемое в отчете по плательщику после
    высвобождения лицензии](./images/figure87.jpg)
    
    > **Note**
    > 
    > Обратите внимание, что процесс подсчета числа лицензий - довольно
    > долгая процедура, поэтому она выполняется в ночное время. Поэтому
    > если вы освобождаете лицензию вручную, счетчик числа
    > использованных лицензий изменится только на
    > следующий день.

  - Вариант 3: высвобождение лицензий на основе актуального списка ИНН
    клиентов банка
    
    Если вручную очищать лицензии не удобно, предусмотрено очищение
    лицензий на основе файла со списком ИНН клиентов банка.
    
    Для этого необходимо предварительно из АБС, ДБО или других
    источников получить список ИНН или КИО активных клиентов -
    юридических лиц и индивидуальных предпринимателей, а затем
    подготовить текстовый файл, содержащий этот список (в
    формате одна строка содержит один ИНН или КИО):
    
        01234567890
        23456780924
        12345
        1234678901234
    
    > **Warning**
    > 
    > Если ИНН активного клиента банка (юридического лица или
    > индивидуального предпринимателя) будет отсутствовать в
    > этом файле, по нему удалится статистика. Это приведет к тому, что
    > для этого клиента в первые N дней (N задается банком в свойствах
    > сайта) большинство встроенных правил будут отключены, что может
    > привести к краже средств.
    
    > **Note**
    > 
    > Если клиент банка - физическое лицо не является индивидуальным
    > предпринимателем, ИНН этого клиента помещать в список активных
    > клиентов не требуется.
    
    Созданный файл запишите на сервер управления в директорию `/tmp`, а
    затем выполните команду (вместо **filename** укажите полный путь к
    файлу):
    
    ` fw_control -c corplist -i filename  `

### Решение проблем с базой данных

СУБД PostgreSQL, используемая в качестве хранилища данных в системе
FraudWall, отличается высокой надежностью в своей работе.
Конфигурационные файлы, поставляемые по-умолчанию,
рассчитаны на многолетнюю необслуживаемую работу.

Тем не менее, могут возникнуть следующие проблемы:

  - размер базы данных может неоправданно быть большим. Это возникает,
    когда в базе данных было много данных (например, выставлен
    параметр хранения подозрительных платежей в несколько лет),
    а затем их одномоментно уменьшили (например, изменили срок хранения
    на 1 год)

  - из\-за аппаратных проблем может возникнуть ситуация, когда в
    log-файлах FraudWall фиксируются ошибки следующего рода:
    
    `ОШИБКА: Database error detected: 'ERROR: Invalid page header in
    block 75 of relation base/16385/16438'`

Для решения таких проблем предусмотрена утилита, которая пересоздает
файлы базы данных, уменьшая их в размере и исправляя при этом
возможные проблемы. Для ее запуска необходимо выполнить команду
`fw_dbshrink`

> **Warning**
> 
> В процессе сжатия базы данных все сервисы FraudWall будут остановлены

### Очищение базы данных FraudWall

В процессе первоначального тестирования системы, FraudWall, как правило,
обрабатывает тестовые несуществующие платежи, которые отсутствуют в
боевой базе ДБО или АБС. Поэтому после завершения этапа
тестирования, база данных статистики FraudWall может быть
искажена.

Чтобы в промышленной эксплуатации FraudWall работал только с корректной
базой данных статистики, предусмотрена возможность полного очищения
базы данных FraudWall. Для этого необходимо в SSH-консоли выполнить
команду: `fw_dbclear`

## Архивирование и восстановление из архива

### Общие положения

Предполагаются следующие возможные варианты создания архивной копии
конфигурации FraudWall:

  - создание snapshot-образов виртуальных машин (наиболее
    предпочтительный вариант)

  - создание посекторной копии жесткого диска серверов FraudWall
    (требует специализированного программного обеспечения)

  - создание архива конфигурации сервера штатными утилитами FraudWall
    `fw_backup` и `fw_restore`

Утилита `fw_backup` позволяет сохранить конфигурацию сервера FraudWall,
а также содержимое базы данных FraudWall, в архивном файле.

Данная процедура также позволяет мигрировать сервер FraudWall на другой
физический сервер, т.к. архивный файл может быть восстановлен на другом
сервере.

Создание архива может быть выполнено как в интерактивном режиме, так и
как cron-задание.

Созданный архив будет находится в директории `/var/tmp/` с именем файла
вида `fwbackup-ГГГГММДД_ЧЧММСС-имясервера.tgz`, который необходимо
вручную перенести с сервера FraudWall на сервер хранения
архивов.

### Создание архивной копии с помощью утилиты fw\_backup в интерактивном режиме

Для начала создания архивной копии необходимо выполнить команду
`fw_backup`

### Создание архивной копии с помощью утилиты fw\_backup как cron-задание

Создание архива можно автоматизировать, например, как еженочное создание
архива.

Для выполнения утилиты `fw_backup` в скриптах предусмотрен параметр
`-c`. После завершения работы, fw\_backup возвращает код возврата 0 при
успехе, а при ошибке - ненулевое значение.

При конфигурировании автоматического создания архива на сервере
управления убедитесь, что в конфигурационном файле
`/var/lib/pgsql/data/postgresql.conf` есть следующие параметры:

    archive_mode = on
    archive_command = '/usr/sbin/fw_dbwal "%p" "%f"'
    archive_timeout = 0

Если указанные параметры отличаются, подкорректируйте их, а затем
перегрузите сервер командой **reboot**

Пример скрипта, который будет выполнять автоматическое создание архива,
следующий:

    #!/bin/bash
    
    # Создаем архив в /var/tmp
    /usr/sbin/fw_backup -c
    RETVAL=$?
    if [ $RETVAL -ne 0 ]; then
      echo "Error"
      exit 1
    fi
    
    # Копируем архив из /var/tmp на другой сервер по SCP
    scp /var/tmp/fwbackup* user@arcserver:/mnt/backup/
    
    # Удаляем архив из /var/tmp
    rm -f /var/tmp/fwbackup*

> **Warning**
> 
> Чтобы не вызвать конфликта с другими процессами, запускайте скрипт
> автоматического создания архива в 00 минут необходимого часа

### Восстановление из архивной копии с помощью утилиты fw\_restore

Утилита `fw_restore` позволяет восстановить сервер FraudWall из архивной
копии, в том числе на другом физическом сервере.

Восстановление сервера осуществляется в следующей последовательности:

1.  Если предполагается восстанавливать архив на другом физическом
    сервере, необходимо предварительно на нем установить "чистую"
    операционную систему (т.е. выполнить действия в разделе [Установка
    операционной системы](#os_install) до начала копирования файла с
    лицензией, т.к. дальнейшие пункты (в т.ч. редактировать файлы ` 
    /etc/fraudwall/fwcontrol.xml ` и `/etc/fraudwall/fraudwall.xml`)
    выполнять не обязательно).

2.  Перед началом восстановления скопируйте файл архивной копии в
    директорию`/var/tmp` (убедитесь, что в ней нет других
    архивных файлов fwbackup-\*.tgz)
    
    > **Note**
    > 
    > Работа с SFTP (SCP)-клиентом описана в разделе [Интерфейс передачи
    > файлов посредством протоколов SCP и SFTP](#admin_file_ssh)

3.  Для начала восстановления из архивной копии запустите команду
    `fw_restore`

4.  После восстановления проверьте и при необходимости подкорректируйте
    IP адреса, указанные в файле `/etc/fraudwall/fraudwall.xml`

5.  Перегрузите сервер командой `reboot`

6.  Если восстанавливается сервер баз данных FraudWall (как правило, это
    сервер управления), после восстановления и перезагрузки сервера,
    необходимо дополнительно выполнить команду: `fw_control -c
    dbfix`

7.  Установите обновления на операционную систему в соответствии с
    разделом [Установка обновлений на операционную систему в
    ручном режиме](#manual_os_update)`fw_update -s`

8.  Убедитесь в работоспособности восстановленного
сервера

### Восстановление из snapshot-образов и посекторной копии жесткого диска

После восстановления сервера из snapshot-образов или посекторной копии
жесткого диска, сервер FraudWall необходимо перегрузить командой
`reboot`

Если восстанавливается сервер баз данных FraudWall (как правило, это
сервер управления), после восстановления и перезагрузки сервера,
необходимо дополнительно выполнить команду: `fw_control -c dbfix`

По завершению данной команды сервер считается восстановленным.

### Миграция сервера FraudWall на другой физический сервер.

Миграция сервера FraudWall, как правило, осуществляется при
необходимости расширить аппаратные ресурсы сервера
(например, увеличить дисковое пространство), либо при смене
операционной системы (например, с RedHat на бесплатный CentOS).

Миграция осуществляется с помощью утилиты fw\_backup.

Если в установлен дополнительный сервер анализа трафика, первоначально
необходимо мигрировать сервер управления FraudWall.

> **Warning**
> 
> В процессе миграции платежи анализироваться не будут.

#### Подготовительные мероприятия

Перед началом миграции необходимо выделить новую виртуальную или
выделенную машину, с характеристиками не хуже мигрируемого
сервера (например, можно увеличить место на диске и т.д.).

> **Note**
> 
> Подготовительные мероприятия из данного пункта делаются до начала
> миграции. Они не влияют на анализ платежей существующими
> серверами FraudWall, поэтому подготовку к миграции можно
> выполнить в любое рабочее время.

На новый сервер нужно установить "чистую" операционную систему (т.е.
выполнить действия в разделе [Установка операционной
системы](#os_install) до начала копирования файла с лицензией,
т.к. дальнейшие пункты (в т.ч. редактировать файлы
`/etc/fraudwall/fwcontrol.xml` и `/etc/fraudwall/fraudwall.xml`)
выполнять не нужно).

> **Warning**
> 
> Во время выполнения пункта 11 необходимо выдать временные IP адреса
> для дальнейшего взаимодействия и переноса резервной копии.

> **Note**
> 
> Если взаимодействие с Интернет осуществляется через proxy-сервер, то
> необходимо произвести настройку согласно пункту [Конфигурирование
> получения обновлений в проксированном
> режиме](#cfg_update_via_proxy)

#### Миграция сервера: создание резервной копии старого сервера

Создание резервной копии осуществляется утилитой **fw\_backup** (т.е.
необходимо выполнить действия, описанные в разделе [Создание архивной
копии с помощью утилиты fw\_backup в интерактивном режиме](#backup_cli).

Переносим `/var/tmp/fwbackup-ГГГГММДД_ЧЧММСС-<имясервера>.tgz` с старого
сервера на новый.

#### Миграция сервера: восстановление резервной копии на новом сервере

1.  Выключаем старый сервер.

2.  Выполняем команду на новом сервере`  service fw_setup start `

3.  Изменяем доменное имя и IP адрес на значения старого сервера.

4.  Перезагружаем новый сервер командой `  reboot `

5.  На новом сервере (он будет доступен уже по IP адресу старого
    сервера) восстанавливаем конфигурацию сервера командой
    `fw_restore`

6.  Повторно перегружаем сервер командой `  reboot `

7.  Выполняем обновление системных пакетов командой `  fw_update -s `

#### Миграция сервера: проверка работоспособности

После восстановления сервера FraudWall, необходимо убедиться в
работоспособности системы:

1.  Проверяем доступность WEB-интерфейса системы FraudWall.

2.  Обновляем статус всех серверов в WEB-интерфейсе FraudWall во вкладке
    инфраструктура. Не должно быть ошибок, а время последнего обновления
    статуса серверов должно быть актуальным.

3.  Просматриваем логи `/var/log/fraudwall/fw_control.log` на наличие
    ошибок (строки содержащие "\[err\]").

4.  При миграции сервера управления необходимо проверить, что все сайты
    подключаются к соответствующим БД (АБС или ДБО). Для этого
    необходимо проверить, что последние записи в файлах
    `/var/log/fraudwall/siteNNN-afdb.log` не содержат ошибок (строки
    содержащие "\[err\]").

5.  При миграции сервера анализа трафика проверяем работоспособность
    связки нового сервера анализа трафика с сервером управления. Для
    этого необходимо проверить, что файл
    /var/log/fraudwall/siteNNN-af.log на сервере анализа трафика не
    содержат ошибок (строки содержащие "\[err\]").
    
    Дополнительно проверяем работоспособность тонкого клиента BS-Client.

## Создание отказоустойчивой конфигурации

### Общие положения

Если размер базы данных на сервере FraudWall превышает несколько
десятков гигабайт, восстановление сервера из архива займет
значительное время. Поэтому в FraudWall предусмотрена возможность
создания горячего резерва сервера базы данных.

> **Note**
> 
> Как правило, сервер базы данных и сервер управления располагаются на
> одном и том же сервере. В этом случае обеспечивается также горячее
> резервирование сервера управления.

Горячее резервирование подразумевает, что в банке установлено минимум 3
сервера:

  - WWW-сервер обновлений FraudWall

  - основной сервер FraudWall

  - резервный сервер FraudWall

Резервный сервер FraudWall может быть установлен после установки
основного сервера в любой момент времени.

При отказе основного сервера, резервный может полностью быть
восстановлен как основной сервер, в т.ч. резервный сервер
может подхватить IP адреса отказавшего сервера.

Конфигурирование серверов, включая переконфигурирование резервного
сервера на работу как основной сервер, осуществляется вручную из
командной строки операционной системы.Для работы с горячим
резервированием серверов предусмотрена команда `fw_dbha`

### Создание резервного сервера

Для создания резервного сервера необходимо:

1.  Выделить IP адрес для резервного сервера.
    
    > **Note**
    > 
    > Резервный сервер рекомендуется настраивать в той же подсети, в
    > которой находится основной сервер. Это упростит процедуру
    > восстановления, если основной сервер полностью выйдет из
    > строя.

2.  Установить операционную систему согласно раздела [Установка
    операционной системы](#os_install)
    
    > **Note**
    > 
    > Конфигурационные файлы `fraudwall.xml` и `fwcontrol.xml` в
    > процессе установки лучше скопировать с основного сервера
    > управления

3.  Установить сервер баз данных в соответствии с разделом [Установка
    сервера базы данных системы FraudWall](#fraudwall_db_install)

4.  На основном сервере запустить команду `fw_dbha`
    
    > **Warning**
    > 
    > Обратите внимание, конфигурирование горячего резервирования
    > осуществляется только на основном сервере

5.  Примерно через 10 минут в интерфейсе "Инфраструктура серверов" меню
    "Система" появится резервный сервер. Для удобства рекомендуется
    переименовать его как "резервный сервер".

### Порядок действий в случае сбоя основного сервера

Процедура восстановления подразумевает, что резервный сервер будет
полностью переконфигурирован как оказавший основной сервер, в т.ч.
на резервном сервере будут восстановлены сетевые настройки (IP адрес)
основного сервера.

Для восстановления системы необходимо:

1.  Убедится, что отказавший основной сервер полностью выключен

2.  Зайти в консоль операционной системы резервного сервера и выполнить
    команду `fw_dbha`

3.  В появившемся диалоге выбрать режим "**основной сервер не работает,
    восстановить этот сервер как основной**"

4.  Перегрузить сервер командой `reboot`

5.  Зайти в Web-интерфейс системы и убедится в работоспособности сервера
    
    > **Note**
    > 
    > При восстановлении сетевых параметров, на резервном сервере не
    > меняется доменное имя. При необходимости его можно поменять в
    > соответствии с разделом [Администрирование сетевых
    > настроек](#os_network_cfg)

### Порядок действий при восстановлении отказавшего сервера

После того, как резервный сервер взял на себя функционал основного (т.е.
фактически стал основным сервером и стал обслуживать IP адрес основного
сервера), бывший основной сервер должен оставаться выключенным, т.к. на
нем остался тот же IP адрес и при его включении возникнет конфликт
адресов.

Процедура его обратного включения заключается в том, что он
восстанавливается как резервный сервер, в т.ч. с
переформатированием жестких дисков и установкой чистой
операционной системы (более детально см. раздел [Создание
резервного сервера](#dbha_slave)).

Если восстановленный сервер (он теперь выступает в роли резервного
сервера) является более быстрым, имеет смысл дополнительно сделать
его опять основным согласно следующей последовательности (эту процедуру
лучше делать во внерабочее время):

1.  Т.к. через удаленный доступ по SSH выполнить данную процедуру
    невозможно, необходимо зайти в консоль операционной системы
    (для виртуальных машин - через интерфейс управления гипервизором,
    для физических серверов - непосредственно на сервере).

2.  На быстром сервере (он сейчас резервный) необходимо выполнить
    команду `fw_dbha`
    
    и выбрать режим "**основной сервер не работает, восстановить этот
    сервер как основной**"

3.  На медленном сервере установить IP адрес резервного сервера командой
    `service fw_setup start` (если будут ошибки конфликта IP адресов, их
    можно игнорировать)

4.  Перегрузить оба сервера командой `reboot`

5.  На быстром сервере выполнить команду `fw_dbha` и указать IP адрес
    резервного сервера (он сейчас установлен на медленном сервере)

6.  Убедится, что Web-интерфейс FraudWall доступен (как и прежде, он
    находится по IP адресу основного сервера, но сейчас его
    обрабатывает быстрый сервер)

### Переконфигурирование резервного сервера

Если необходимости в резервном сервере больше нет, его можно
переконфигурировать как обычный сервер и использовать,
например, в тестовых целях.

Для этого необходимо:

1.  На основном сервере убедится, что этот сервер не является резервным.
    Для этого необходимо на основном сервере выполнить команду `fw_dbha`
    и проверить, какие сервера участвуют в горячем резервировании

2.  На резервном сервере, который должен быть переконфигурирован как
    обычный сервер, выполнить команду `fw_dbha` и выбрать режим
    "**вывести этот сервер из резервирования**"

3.  После завершения настроек перегрузить сервер командой `reboot`

# Обнаружение мошеннических платежей

## Общие принципы обнаружения мошеннических платежей

Для обнаружения мошеннических платежей, система FraudWall анализирует не
только содержимое платежного документа, но и весь сетевой трафик работы
в системе ДБО, в котором фиксируется каждое действие клиента: что было
сделано в сессии перед созданием документа, выполнялись ли операции, не
свойственные обычной работе клиента в системе ДБО и т.д.

Система FraudWall не устанавливает какого-либо программного обеспечения
на стороне клиента - для анализа используется только те данные, которые
получены извне непосредственно на сервер банка. Такой подход исключает
какое-либо вмешательство в работу компьютера клиента банка.

По каждому клиенту банка, обнаруженного в реквизитах созданного в ДБО
платежного поручения, система FraudWall накапливает статистику - на
каких получателей платит этот клиент, на какие суммы и т.д.

  - получатель - физическое лицо

  - получатель - юридическое лицо

  - получатель - платежный шлюз

Под платежным шлюзом считается юридическое лицо, которое при поступлении
средств на его расчетный счет, осуществляет дальнейшее зачисление на
внутренние лицевые счета физических лиц. Например, в качестве
платежного шлюза выступают платежные системы Яндекс.Деньги,
WebMoney и т.д.

Под получателем - юридическим лицом считаются юридические лица (кроме
платежных шлюзов), а также индивидуальные предприниматели (физические
лица, зарегистрированные в установленном законом порядке и
осуществляющие предпринимательскую деятельность без
образования юридического лица).

Помимо статистики «плательщик - получатель», получаемой из реквизитов
платежного поручения, система FraudWall также накапливает статистику
по компьютеру клиента (с каких IP адресов работает клиент в ДБО и
т.д.).

Статистика автоматически формируется с учетом особенностей платежей
каждого клиента.

Все параметры, критерии и правила обнаружения мошеннических платежей
хранятся в так называемых **профилях параметров обнаружения
мошеннических платежей**.

Профиль может быть применен на уровне филиала банка, на уровне сайта и
на уровне клиента (плательщика). Наивысший приоритет имеет профиль на
уровне клиента, если он не указан - то на уровне сайта, если профиль не
указан на уровне клиента и сайта - то используется профиль на уровне
филиала.

![Последовательность анализа документа системой
FraudWall](./images/figure64.jpg)

При обнаружении факта создания документа в ДБО, система FraudWall
анализирует накопленную статистику «плательщик - получатель»,
статистику по компьютеру клиента, а также выполняемые в течение
сессии действия, формируя тем самым набор флагов (параметров),
свойственных для конкретного документа.

Выставляемые флаги могут быть как логическими (т.е. принимать значения
ПРАВДА, ЛОЖЬ НЕИЗВЕСТНО), уровневыми (т.е. НЕЗНАЧИТЕЛЬНЫЙ, НЕБОЛЬШОЙ,
СРЕДНИЙ, БОЛЬШОЙ, ОЧЕНЬ БОЛЬШОЙ, НЕЕСТЕСТВЕННЫЙ, НЕИЗВЕСТНО), либо
числовыми (обычное число с запятой).

Значение НЕИЗВЕСТНО выставляется в случае, если вычислить значение флага
по каким-либо причинам невозможно. Например, если система FraudWall
интегрирована с системой ДБО в универсальном режиме (т.е. в
качестве источника информации для анализа выступают не дамп
трафика, а реквизиты платежного поручения в базе данных), проверить
значение User-Agent браузера клиента становится невозможным (а
следовательно, соответствующий флаг будет иметь значение
НЕИЗВЕСТНО).

1.  встроенные правила (поставляемые разработчиком системы)

2.  правила, создаваемые вручную через Web-интерфейс

FraudWall последовательно проверяет все правила до тех пор, пока не
сработает первое созданное вручную правило вида «считать платеж
созданным клиентом» (либо до последнего правила, если таких нет).

При завершении проверки правил, FraudWall проверяет - сработало ли
встроенное либо созданное вручную правило вида «считать платеж
подозрительным». Если сработало хотя бы одно такое правило (даже
если дополнительно сработало правило вида «считать платеж созданным
клиентом»), то FraudWall считает платеж подозрительным и выполняет
соответствующие действия по информированию сотрудников
банка.

## Конфигурирование правил и критериев обнаружения мошеннических платежей

Набор параметров, правил и критериев, на основании которых система
FraudWall относит платежи к подозрительным, хранятся в так называемых
**профилях параметров обнаружения мошеннических платежей**.

Профиль может быть применен на уровне филиала банка, на уровне сайта и
на уровне клиента (плательщика). Наивысший приоритет имеет профиль на
уровне клиента, если он не указан - то на уровне сайта, если профиль не
указан на уровне клиента и сайта - то используется профиль на уровне
филиала.

Профиль создается через Web-интерфейс системы FraudWall, пункт
«Конфигурирование» в меню «Система», вкладка «Платежи». В
системе может быть создано несколько профилей, содержащих разные
параметры обнаружения - максимальное число профилей не
ограничивается.

Правом создания либо редактирования профиля наделены только пользователи
с ролью «**администратор**» либо «**сотрудник службы безопасности**».

> **Warning**
> 
> Для обнаружения мошеннических платежей, в системе FraudWall должен
> быть создан как минимум один профиль. Кроме того, соответствующий
> профиль должен быть указан для каждого филиала, зарегистрированного в
> системе.

Описание каждого из параметров профиля приведено в online-помощи
Web-интерфейса системы.

Система FraudWall содержит в себе набор встроенных правил, которые
прошиты в коде системы и обновляются в рамках технической
поддержки. В дополнение к ним, можно создать собственные
правила обнаружения мошеннических платежей.

### Использование встроенных правил обнаружения мошеннических платежей

В конфигурации профиля есть параметр - **Использование встроенных
правил**, который определяет число активированных встроенных
правил для данного профиля.

![Использование встроенных правил](./images/figure65.jpg)

Все встроенные правила сгруппированы таким образом, чтобы их уровень
срабатывания относился к среднестатистическим показателям
мошеннических платежей, наблюдаемых в процессе разработки
системы FraudWall. Разработчиком определены следующие уровни
срабатывания встроенных
правил:

| Уровень правила               | Область применения                                                                                                                      |
| ----------------------------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| явное мошенничество           | Явное подозрение на мошеннический платеж: получатель находится в черном списке, обнаружено явное создание платежа вирусным кодом и т.д. |
| похоже на мошенничество       | Очень высокое подозрение на мошеннический платеж: с компьютера недавно был мошеннический платеж и т.д.                                  |
| основные критерии обнаружения | Используются правила, реализующие основные критерии обнаружения мошеннических платежей                                                  |
| рекомендуемый набор правил    | Типовой набор правил, рекомендуемый к эксплуатации                                                                                      |
| экспериментальные правила     | Активируются правила, предназначенные для тестирования и экспериментальных исследований                                                 |

Для обнаружения подавляющего большинства мошеннических платежей для
среднестатистических клиентов рекомендуется использовать
рекомендуемый набор правил. Более низкие уровни рекомендуется
устанавливать на отдельных клиентов, если по ним наблюдается высокий
уровень ложного срабатывания и клиент принимает риски возможного
ущерба от мошеннических платежей.

Можно полностью отключить использование встроенных правил, установив
значение параметра «Использование встроенных правил» как
«отсутствует» (например, если необходимо использовать только
правила, созданные вручную).

> **Note**
> 
> Образно наборы правил можно представить в виде обычной мишени с
> "кольцами". Чем ниже уровень - тем ближе кольцо к центру, а
> соответственно, точнее попадание в цель (т.е. обнаружение
> мошеннического платежа).
> 
> Размер этой "мишени" задается в параметре "**использование встроенных
> правил**". Например, при выставлении этого параметра в значение
> "рекомендуемый набор правил", в мишени есть кольца "явное
> мошенничество", "похоже на мошенничество", "основные критерии"
> и "рекомендуемый набор правил".
> 
> Если же выставлен уровень "похоже на мошенничество", то в мишени будут
> только кольца "явное мошенничество" и "похоже на мошенничество".
> 
> Если конкретный платеж по своим характеристикам "пролетает" мимо
> мишени, то он не считается подозрительным.
> 
> И наоборот, если сработало какое-либо правило из имеющихся в мишени
> уровней, то он будет считаться подозрительным.
> 
> Таким образом, чем меньше размер мишени, тем меньше вероятность того,
> что платеж в нее попадет - попасть в нее смогут только явно
> подозрительные платежи.

### Создание собственных правил обнаружения мошеннических платежей

Вне зависимости от параметра «уровень использования встроенных правил»,
FraudWall проверяет также правила, созданные вручную на стороне банка.

Каждое правило содержит набор критериев, которые должны одновременно
выполниться, чтобы сработало правило. Например, если в правиле
указаны критерии «Сумма платежа свыше 1000000 рублей», «Значение
(сумма платежа) / (остаток на счете) больше 0.8», то правило сработает
на платежи свыше 1000000 руб. и если сумма платежа составит свыше 80%
от остатка на счете.

Правила проверяются сверху вниз до срабатывания первого правила вида
«платеж создан клиентом». Правила этого вида необходимы для того,
чтобы исключить срабатывание созданных вручную правил на платежи на
небольшие суммы, либо на переводы между своими счетами и т.д.
Например, если требуется, чтобы созданные вручную правила
обнаружения мошеннических платежей не срабатывали на платежи
суммой ниже 25000 рублей и на платежи между своими счетами, то в
самом начале списка правил необходимо создать 2 правила вида «платеж
создан клиентом»: первое правило с критерием «сумма платежа меньше
25000 рублей, а второе правило - с критерием «платеж между своими
счетами».

Интерфейс редактирования правил позволяет перемещать правило как вверх
по списку (повышая его приоритет), так и вниз. Созданное вручную
правило можно отключить на необходимое время (например, если
созданное правило приводит к большому числу ложных срабатываний,
его можно временно отключить для более детального анализа), а также
удалить без возможности восстановления.

На один и тот же документ может сработать одновременно несколько правил.
Система FraudWall будет считать платеж подозрительным, если сработало
хотя бы одно из встроенных правил, либо созданных вручную вида
«подозрительный платеж».

Ограничений как на число созданных вручную правил, так и на число
критериев в одном правиле не накладывается.

### Особенности конфигурирования правил при неизвестных значениях флагов

В зависимости от способа интеграции с системой ДБО, а также версии самой
ДБО, значение некоторых флагов выставляется как «НЕИЗВЕСТНО», а для
числовых флагов - соответствующий критерий никогда не сработает.

Например, в универсальном режиме интеграции с ДБО (анализ платежей
непосредственно в базе данных) информацию о времени просмотра
остатка на счете вычислить, как правило, невозможно. Если создано
ручное правило «сумма платежа свыше 100 000 рублей» и «время создания
документа после просмотра остатка меньше 120 секунд», то оно никогда не
сработает.

В таких случаях рекомендуется использовать условие не «ЗНАЧЕНИЕ =
ПРАВДА», а «ЗНАЧЕНИЕ \!= ЛОЖЬ» - в этом случае под правило
попадают не только платежи, у которых ЗНАЧЕНИЕ = ПРАВДА, но также
и платежи, когда значение параметра вычислить невозможно.

## Тестирование обнаружения мошеннических платежей

Для обнаружения мошеннических платежей, система FraudWall использует не
только информацию о текущих действиях клиента в сессии, но и
статистику, накопленную за продолжительный период работы
системы.

Так как при первоначальной установке системы накопленной статистики нет,
рекомендуется для тестирования использовать критерии, не требующие
статистики.

Самый простой способ проверки - это поместить какого-либо
несуществующего получателя в черный список. Для этого
необходимо зайти в интерфейс получения аналитического отчета по
получателю - юридическому лицу (интерфейс «Получатель» меню
«Аналитика»), сделать выборку по ИНН 1234567890 и в группе
«Статус» установить соответствующий статус:

![Помещение получателя в черный список](./images/figure66.jpg)

После выставления статуса, необходимо зайти под клиентом в ДБО и создать
рублевый платеж на получателя с этим ИНН.

> **Warning**
> 
> При создании тестового платежа необходимо, чтобы платеж соответствовал
> всем требованиям платежных документов в РФ - номер расчетного счета
> должен относится к юридическому лицу, код валюты 810 и т.д.
> Например, расчетный счет должен выглядеть как 40702810…

Так как встроенные правила даже минимального уровня проверяют черные
списки получателей, то система должна распознать этот платеж как
подозрительный, и он должен отобразиться в Web-интерфейсе просмотра
платежей (пункт «Все платежи» меню «Платежи»).

Необходимо кликнуть мышкой на этот документ и проверить идентичность
всех полей документа с тем, что было введено в интерфейсе ДБО.

Полный перечень правил, сработавших для конкретного документа, можно
посмотреть в разделе «технические детали» свойств документа:

![Список правил, по которому данный платеж был признан
подозрительным](./images/figure67.jpg)

## Тонкая настройка обнаружения мошеннических платежей

### Снижение уровня ложного срабатывания системы

Как и любая система принятия решений, FraudWall может ошибочно считать
документы подозрительными (ошибка первого рода, или ложное
срабатывание).

  - определить список правил, которые наиболее часто формируют ложное
    срабатывание

  - определить массовость проблемы - т.е. относится ли ложное
    срабатывание ко всем клиентам, либо ярко выражена только
    среди определенных клиентов

  - скорректировать настройки профиля обнаружения мошеннических платежей
    (либо создать новый профиль, если проблема не является массовой)

Для определения наиболее часто срабатывающих правил, в системе FraudWall
предусмотрен удобный интерфейс получения аналитических и статистических
отчетов по срабатыванию правил (пункт «Статистика - правила» меню
«Аналитика»).

Для определения массовости проблемы необходимо воспользоваться
интерфейсом поиска платежей (Пункт «Все» меню «Платежи»). В
критериях поиска платежей необходимо задать номер анализируемого
правила:

![Поиск документов по правилу с заданным номером](./images/figure68.jpg)

Результат выборки будет содержать платежи всех клиентов, которые
сработали по заданному номеру правила.

Если проблема носит частный характер, т.е. ложное срабатывание
свойственно только некоторым клиентам, рекомендуется создать
для них собственный профиль обнаружения мошеннических платежей, в
котором указать другой диапазон сумм, набор правил и т.д.

Привязать профиль к клиенту можно через интерфейс просмотра аналитики по
клиентам банка (интерфейс «Плательщик» меню «Аналитика»):

![Установка профиля на уровне клиента банка](./images/figure69.jpg)

### Повышение вероятности обнаружения мошеннических платежей

Ошибка второго рода, или пропуск события, может привести к тому, что
мошеннический платеж будет исполнен на стороне банка и вернуть
средства клиента будет невозможно.

  - Устанавливать параметр «уровень использования встроенных правил» в
    максимальное, а для особо важных клиентов - в параноидальное
    значение.

  - В дополнение к встроенным правилам, создавать собственные правила,
    исходя из накопленной в банке статистике по мошенническим платежам

  - Проверять на наличие обновлений к системе FraudWall не реже одного
    раза в сутки, т.к. в обновлении может быть добавлено новое
    встроенное правило либо критерий для анализа

  - Устанавливать значения диапазонов сумм в свойствах профиля исходя из
    особенностей региона, где работает каждый филиал

  - Если клиенту не требуется платить в пользу платежных шлюзов,
    рекомендуется установить небольшое значение (100 - 200
    рублей) в поле «сверхбольшая сумма платежей в пользу платежных
    шлюзов».

При выполнении вышеперечисленных действий стоит учитывать, что
выполненные изменения могут привести к росту ложного числа
срабатываний системы.

### Использование утилиты fw\_forecast

В процессе своей работы на каждом сервере FraudWall в директории
`/var/log/archive/statistics` формируются обезличенные лог-файлы
обработки платежных поручений. Эти файлы могут быть
проанализированы с целью поиска оптимальных значений
параметров обнаружения как на стороне банка, так и на стороне
технической поддержки.

Для автоматизированного анализа обезличенных лог-файлов предусмотрена
утилита fw\_forecast.С ее помощью можно определить оптимальные
значения пороговых сумм профилей обнаружения мошеннических
платежей, а также спрогнозировать уровень ложного срабатывания
при добавлении в профиле каких-либо правил, созданных вручную.

Для ее запуска необходимо выполнить команду: `fw_forecast -i ID`

где **ID** - идентификатор профиля, настройки которого будут
анализироваться - его можно посмотреть в Web-интерфейсе
"Система\\Конфигурирование\\Профили". Чтобы оценить уровень ложного
срабатывания с настройками по умолчанию, укажите значение "0".

> **Warning**
> 
> Для наиболее достоверной оценке уровня ложного срабатывания
> необходимо, чтобы в директории `/var/log/archive/statistics`
> были журналы событий минимум за месяц эксплуатации на реальных данных.

## Анализ дампов трафика клиентов в ручном режиме

Детальный анализ действий злоумышленника в системе ДБО можно осуществить
на основе анализа архивных файлов дампа трафика (см. также раздел
[Подсистема журналирования](#audit_subsystem)).

В штатном режиме работы, модуль фильтрации трафика формирует единый файл
дампа трафика всех клиентов. В процессе еженочного переключения журналов
событий, ранее созданный файл дампа переименовывается, а новое имя файла
содержит информацию о времени переключения файла во временной зоне UTC.

В целях экономии места на архивном носителе, после переименования файл
дампа сжимается архиватором **rar** (если установлен) либо **tar** (со
сжатием bzip2), которые перед анализом необходимо распаковать во
временную директорию.

Для удобства анализа действий злоумышленников, которые были в момент
создания мошеннического документа, в FraudWall предусмотрена
возможность создания на основе большого файла дампа нескольких
небольших файлов, содержащих информацию только по заданному клиенту
банка (либо по заданному компьютеру клиента банка).

Извлеченные файлы дампа трафика создаются с учетом времени
аутентификации (как успешной, так и не успешной) по маске:
`ЛогинПользователяКлиента[_ЛогинЮрЛица ]-ГГГГММДД_ЧЧММСС_UTC.dat`

> **Note**
> 
> Значение поля «ЛогинЮрЛица» указывается только в том случае, если в
> ДБО предусмотрен не только логин пользователя клиента, но и логин
> юридического лица (например, в этом случае для разных логинов юр.лиц
> **CORP1** и **CORP2** могут быть созданы пользователи с одинаковыми
> логинами **director**).

Дата и время, указанные в имени файла, являются временем аутентификации
во временной зоне UTC.

### Подготовка файлов для обработки

> **Note**
> 
> Файлы дампа, как правило, занимают на диске много места. Поэтому
> работу с ними лучше осуществлять в директории `/var/tmp`.
> 
> Предварительно убедитесь, что на соответствующем разделе достаточно
> места командой: `df /var -H`

Перед началом анализа данных необходимо определить, за какой период
будут обрабатываться данные:

  - дамп за текущий день находится в директории `/var/log/fraudwall`

  - дамп за предыдущие периоды помещаются в архивные файлы (один файл
    архива содержит дампы всех сайтов за одни сутки) в директорию
    `/var/log/archive`.
    
    > **Warning**
    > 
    > При восстановлении архивов с дампами трафика необходимо учитывать,
    > что время, указанное в имени архивного файла, является не началом
    > времени формирования архива, а временем его завершения (во
    > временной зоне UTC).
    
    > **Note**
    > 
    > Согласно разделу [Регламентные процедуры](#admin_daily), файлы из
    > директории /var/log/archive должны переносится на внешний
    > носитель (сетевой диск, DVD-диск и т.д.)

  - в кластерной установке (если один и тот же сайт системы ДБО
    обслуживается несколькими серверами FraudWall с модулем
    анализа трафика), дампы за текущий день и их архивы необходимо
    скопировать на один сервер.

Для разархивирования файлов с расширением `.tar.bz2`, в SSH-консоли
необходимо выполнить команду: `tar -x -j -f ИмяФайла.tar.bz2 -C
ДиректорияАнализа`

`tar -x -j -f srv1-dump-20120903_180001.tar.bz2 -C /var/tmp/dump/srv1`

`tar -x -j -f srv2-dump-20120903_180001.tar.bz2 -C /var/tmp/dump/srv2`

> **Warning**
> 
> В кластерной установке распакованные файлы дампов разных серверов
> называются одинаково (например, `site1-dump.dat`). Поэтому при
> распаковке архивов разных серверов необходимо указывать разные
> поддиректории (например, `/var/tmp/dump/srv1` и
> `/var/tmp/dump/srv2`).

### Фильтрация сессий для извлечения из архива

Файл дампа содержит информацию по сессиям всех клиентов банка. Чтобы
работать только с нужной информацией, необходимо выбрать критерии
извлечения данных.

Критерии фильтрации указываются как опции в командной строке при вызове
утилиты формирования файлов дампа.

Можно указать один или одновременно несколько
фильтров:

| Критерий фильтрации                    | Опция                        |
| -------------------------------------- | ---------------------------- |
| логин пользователя клиента             | \-u ЛогинПользователяКлиента |
| логин юр. лица                         | \-g ЛогинЮрЛица              |
| IP адрес компьютера клиента            | \-i IP\_адрес                |
| CID (внутренний ID компьютера клиента) | \-c CID\_компьютера          |

Критерии фильтрации сессий клиентов

> **Warning**
> 
> Обратите внимание, что для некоторых систем ДБО логин пользователя и
> юр.лица могут быть регистрозависимы (например, это ДБО BSClient),
> поэтому их необходимо указывать в соответствующем регистре.

Если указано два и более критерия отбора, они работают по принципу
"ИЛИ".

### Запуск утилиты формирования файлов дампов сессий клиентов

В зависимости от системы ДБО, используются разные утилиты обработки
файлов дампа:

| Система ДБО      | Наименование утилиты |
| ---------------- | -------------------- |
| BS-Client        | fw\_bsclient         |
| iSimpleBank 2.0  | fw\_isimple          |
| Finacle eBanking | fw\_finacle          |

Утилиты анализа файлов дампов

При вызове утилиты анализа дампов необходимо указать следующие
опции:

| Опция                    | Назначение                                                                                                                                     |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------- |
| \-w                      | Признак того, что необходимо записать файл дампа в соответствии с критериями                                                                   |
| \-s ДиректорияАнализа    | Директория, в которой находятся распакованные файлы (внутри нее могут находится поддиректории, например, от разных серверов системы FraudWall) |
| \-d ДиректорияРезультата | Директория, в которую будут записаны результирующие файлы                                                                                      |
| \-l ЛогФайл              | (опционально) файл журнала событий обработки файлов дампа. Если опция не указывается, журнал событий будет выведен на экран                    |

Обязательные опции запуска утилиты анализа файлов дампов

> **Warning**
> 
> Необходимо убедится, что директория, в которую будут сохранены
> обработанные данные, пуста, или вообще отсутствует.

Результатом работы утилиты будет набор файлов, содержащих дамп работы
каждой из сессий клиентов с учетом заданных критериев фильтрации.

Примеры использования утилиты обработки файла дампа:

` fw_bsclient -w -s /var/tmp/a -d /var/tmp/result -l result.log -u
user01  `

` fw_bsclient -w -s /var/tmp/a -d /var/tmp/result -l result.log -u
user01 -u user02  `

` fw_bsclient -w -s /var/tmp/a -d /var/tmp/result -l result.log -u
user01 -i 198.3.45.89  `

` fw_bsclient -w -s /var/tmp/a -d /var/tmp/result -l result.log
-i 198.3.45.89  `

> **Warning**
> 
> После обработки данных не забудьте удалить директорию с распакованными
> дампами трафика, т.к. они занимают много места и не нужны для работы
> системы FraudWall в штатном режиме.

# Обучение системы

## Самообучение системы

В системе FraudWall предусмотрен механизм самообучения на основе данных
о работе клиентов, полученных в процессе эксплуатации системы.

Для каждого клиента банка формируется собственная статистическая модель,
которая используется при проверке каждого платежа, созданного в системе
ДБО.

В случае, если по клиенту накоплено мало статистики (например, клиент
недавно подключился к системе ДБО, либо система FraudWall установлена
в банке недавно), система автоматически для этого клиента отключит
правила обнаружения мошеннических платежей, основанных на
статистике, - это необходимо для того, чтобы снизить число
ложных срабатываний системы из-за недостаточной статистики.

Период первоначального накопления статистики по клиенту задается в
настройках профиля.

![Конфигурирование параметра срока первоначального накопления
статистики](./images/figure70.jpg)

Статистическая модель автоматически корректируется в процессе
эксплуатации системы.

Чтобы снизить период первоначального накопления статистики при
первоначальной установке системы FraudWall, предусмотрена
возможность формирования статистического профиля клиентов банка на
основании истории ранее совершенных платежей.

Такое обучение возможно в двух режимах:

  - автоматически через ODBC-подключение к базе данных ДБО (см. раздел
    [Обучение через ODBC-подключение к базе данных ДБО](#learn_odbc))

  - вручную посредством файла экспорта (см. раздел [Обучение на
    основании файла экспорта](#learn_exported))

> **Warning**
> 
> Следует обратить внимание, что FraudWall считает все платежи,
> находящиеся в базе данных ДБО, созданными клиентом (т.е. не
> мошенническими). Поэтому необходимо обязательно дополнительно ввести
> все мошеннические платежи, зафиксированные в банке, через
> WWW-интерфейс системы FraudWall (см. раздел [Ручной ввод
> данных о мошенническом платеже](#learn_fraud)).

## Обучение через ODBC-подключение к базе данных ДБО

Процесс обучения через ODBC-подключение запускается автоматически, как
только в конфигурации сайта в группе параметров "Анализируемая база
данных" заполнены необходимые поля:

  - идентификатор DSN, а также логин и пароль для подключения к базе
    данных ДБО через ODBC

  - указано число дней, после которых платеж, зафиксированный в базе
    данных ДБО, будет считаться созданным клиентом (т.е. пригодным
    для обучения)

![Конфигурирование параметров обучения через
ODBC-подключение](./images/figure80.jpg)

При первоначальном конфигурировании системы обучение осуществляется за
предыдущие 2 года, затем - автоматически дообучивается, периодически
обращаясь к базе данных ДБО.

> **Warning**
> 
> Вышеперечисленные параметры должны быть **указаны для всех сайтов** в
> конфигурации FraudWall, относящихся к системе ДБО (в т.ч. при
> интеграции с ДБО на уровне анализа платежей в базе данных).

## Обучение на основании файла экспорта

> **Warning**
> 
> Начиная с версии 2.3.0, обучение на основании файла экспорта заменено
> более совершенным механизмом (см. раздел [Обучение через
> ODBC-подключение к базе данных ДБО](#learn_odbc)).
> 
> Тем не менее, эта возможность оставлена для тех случаев, когда
> настроить подключение системы FraudWall к базе данных ДБО по
> каким-либо причинам невозможно.

  - Выгрузка из АБС в файл определенного формата всех платежей (включая
    мошеннические) всех клиентов за продолжительный период времени

  - Запуск утилиты обучения статистических профилей клиентов на
    основании выгруженных данных

  - Ручной ввод реквизитов всех мошеннических платежей через
    WWW-интерфейс системы FraudWall

<!-- end list -->

  - если в базе отсутствует статистика по получателю платежа, платеж в
    его пользу считается созданным непосредственно клиентом

  - если в базе зафиксировано, что получатель платежа использовался при
    совершении мошеннического платежа, его статус не меняется (т.е. все
    платежи в его пользу будут считаться подозрительными)

### Формат файла для обучения из внешних источников

Файл, используемый утилитой обучения статистических профилей клиентов,
представляет собой текстовый файл следующего
    формата:

    Дата документа`Наименование плательщика`ИНН плательщика`БИК банка плательщика`Р/с плательщика`Наименование получателя`ИНН получателя`БИК банка получателя`Р/с получателя`Сумма платежа`Назначение платежа

Каждая строка текстового файла содержит информацию об одном платеже и
завершается символами перевода строки DOS-файла (два байта
шестнадцатеричного значения 0D и 0A).

Символ разделения полей данных - \` (шестнадцатеричный ASCII-код 60).
Кодировка всех символов - Windows 1251.

Значение поля ИНН получателя может быть пустым. Остальные поля должны
содержать непустое значение. Ведущие и завершающие пробелы для
каждого поля игнорируются.

### Использование утилиты обучения статистических профилей клиентов

Утилита обучения запускается на сервере управления системы FraudWall.

  - на сервер во временную папку (например, в `/var/tmp/`) записывается
    файл с выгруженными данными
    
    > **Warning**
    > 
    > В целях безопасности утилита обучения автоматически сбрасывает
    > свои привилегии до уровня пользвателя **fwsite**. Если в
    > дальнейшем не создадутся .log и .last файлы, используйте
    > директорию `/var/tmp/` или `/tmp/`, для которой необходимые
    > права даны по-умолчанию.

  - запускается одновременно две SSH-консоли на сервер под учетной
    записью root

  - в одной из SSH-консолей запускается следующая команда: `fw_import -d
    имя_файла`

  - во второй SSH-консоли запускается Midnight Commander (команда mc), и
    открывается на чтение файл `имя_файла.log` (т.е. файл, имя которого
    состоит из имени файла с выгруженными данными с добавлением .log в
    конце).

  - периодически осуществляется проверка ошибок импорта, которые
    фиксируются в .log файле - для этого можно закрыть и открыть
    .log файл в Midnight Commander повторно. Можно также запустить
    следующую команду, которая будет выводить последние строки
    .log-файла на экран: `tail -f имя_файла.log`

Прервать процесс импорта (с возможностью продолжения с места остановки)
можно, нажав Ctrl+C в SSH-консоли, где запущена команда **fw\_import**.

В случае критических ошибок, а также завершения процесса **fw\_import**,
создается файл с именем, аналогичным имени файла с выгруженными данными,
с добавлением **.last** в конце. В этом файле фиксируется последняя
обработанная строка файла выгруженных данных.

При повторном запуске процедуры импорта, утилита первоначально пытается
открыть файл с окончанием .last. Если он найден, то импорт начинается с
той строки, номер которой записан в этом .last - файле. Это удобно, если
необходимо временно прекратить процесс импорта данных.

> **Note**
> 
> После успешного завершения процесса обучения не забудьте удалить .csv,
> .log, а также .last файлы - они больше не нужны

## Ведение черных и белых списков получателей

Несмотря на то, что алгоритмы работы системы могут обнаруживать
мошеннические платежи без ведения черных списков получателей, в
системе предусмотрена возможность ручного заведения информации о
получателях, которые были зафиксированы в мошеннических платежах
(так называемые «черные списки получателей»), а также о получателях,
которые не могут являться мошенниками («белые списки получателей»).

В черный и белый список могут быть занесены как физические, так и
юридические лица (за исключением юридических лиц, выполняющих
роль платежных шлюзов).

> **Note**
> 
> В рамках технической поддержки системы FraudWall черные и белые списки
> получателей не распространяются. Вы можете их вести вручную (см.
> [Ведение черных и белых списков получателей в ручном
> режиме](#blacklist_manual)), либо использовать уже существующие
> черные списки получателей (см. [Поддержка межбанковского почтового
> обмена ("антидроп-клуб")](#blacklist_antidrop) и [Интеграция с
> системой FraudMonitor](#blacklist_fraudmonitor)).

### Ведение черных и белых списков получателей в ручном режиме

Ручной ввод информации о получателях возможен через WWW-интерфейс
системы (интерфейс «Получатель» меню «Аналитика»).

![Интерфейс аналитики по получателю - физическому
лицу](./images/figure72.jpg)

Можно помещать получателя (даже если по нему отсутствует накопленная
статистика) в черный список (статус «все платежи на данного
получателя считать мошенническими»), помещать в белый список
(статус «все платежи на данного получателя считать хорошими»), а также
удалять из него (статус «анализировать платежи на данного получателя как
обычно»).

## Ручной ввод данных о мошенническом платеже

Регистрация мошеннического платежа возможен только для тех платежей,
которые были зафиксированы непосредственно в банке, где установлена
система FraudWall.

Для ведения «черных» и «белых» списков получателей на основании
информации из других банков см. раздел
[title\_title](#blacklist).

  - формирование корректной статистической модели (чтобы повысить
    вероятность обнаружения мошеннических платежей в дальнейшем)

  - формирование аналитических отчетов по мошенничеству в банке

Ввод данных осуществляется вручную, через WWW-интерфейс системы (пункт
«Ручной импорт» меню «Платежи»).

![Интерфейс ввода данных о мошенническом платеже](./images/figure71.jpg)

> **Warning**
> 
> Следует помнить, что из-за особенностей структуры статистических
> данных, удаление ошибочно введенного мошеннического платежа
> невозможно.

## Поддержка межбанковского почтового обмена ("антидроп-клуб")

В системе FraudWall реализована функция автоматического импорта черных
списков, распространяемых в рамках межбанковского почтового обмена.

Поддерживается только односторонний обмен, т.е. FraudWall позволяет
только импортировать информацию о мошенниках, информация о которых
содержится в почтовых сообщениях. Автоматическая рассылка почтовых
сообщений получателям в других банках не предусмотрена.

Для удобства в системе реализован функционал формирования файла с
реквизитами мошенника. Этот файл можно будет в дальнейшем
отправить по почте в другие банки как обычное вложение.

### Автоматическая обработка входящих почтовых сообщений

Для выполнения процедуры импорта достаточно перенаправить (forward)
письмо, содержащее Excel-файл с черным списком, на адрес
`fwblack@IP_адрес_сервера_управления`. Например, если IP адрес сервера
управления **192.168.1.1**, то почтовое сообщение необходимо
перенаправлять на адрес **`fwblack@192.168.1.1`**

Проверить выполнение процедуры импорта вы можете, воспользовавшись
интерфейсом получения аналитики по получателю (пункт "Получатель"
в меню "Аналитика").

> **Warning**
> 
> Если в аналитике по получателю статус получателя не выставился как
> "Все платежи на данного получателя считать мошенническими" через
> 2-3 минуты после перенаправления письма, необходимо проверить -
> доставляется ли почтовое сообщение на сервер управления системы
> FraudWall.
> 
> Если на сервере управления в файле `/var/log/maillog` нет
> соответствующих событий по приему почтового сообщения,
> необходимо убедиться, что внутрибанковский почтовый сервер
> отправлял письма на IP адрес сервера управления, и что на
> межсетевых экранах, которые находятся между ними, открыт
> соответствующий доступ (т.е. с внутрибанковского сервера на
> сервер управления по порту TCP 25)

Рекомендуется настроить автоматическое перенаправление таких писем в
систему FraudWall, т.к. в этом случае процесс импорта не будет
зависеть от того, находится ли сотрудник на рабочем месте или нет.

### Ручная загрузка Excel-файла через WWW-интерфейс FraudWall

В FraudWall можно импортировать Excel-файл, полученного в рамках
межбанковского почтового обмена, также через WWW-интерфейс
системы FraudWall.

Для импорта Excel-файла необходимо зайти в интерфейс "Аналитика по
получателю", нажать на кнопку "Импорт черного списка получателей",
а затем указать Excel-файл:

![Кнопка для импорта черного списка
получателей](./images/figure99.jpg)

### Формирование Excel-файла, используемого при обмене в рамках "антидроп-клуба"

При выставлении в интерфейсе системы FraudWall документу статуса
"мошеннический", появляется дополнительная кнопка "Подготовить
Excel-файл для антидроп-клуба":

![Интерфейс формирования файла для
антидроп-клуба](./images/figure85.jpg)

При нажатии этой кнопки, будет автоматически сформирован Excel-файл, в
котором будут заполнены реквизиты получателя мошеннического платежа.

> **Note**
> 
> При формировании файла используются реквизиты получателя из платежного
> поручения, а также содержимое поля "Назначение платежа".
> 
> Информация о сумме платежа автоматически вырезается, даже если она
> была указана в тексте "Назначение платежа" в произвольном формате.

## Интеграция с системой FraudMonitor

Система обнаружения мошеннических платежей FraudWall интегрирована с
системой контроля мошенничества **FraudMonitor** (разработчиком
которой является компания Group-IB, [](http://www.group-ib.ru/)).

Данная интеграция предполагает:

  - получение из системы FraudMonitor реквизитов получателей
    мошеннических платежей и автоматическое обучение системы
    FraudWall

  - (если разрешено банком) автоматическая отправка в систему
    FraudMonitor реквизитов получателей мошеннических платежей,
    зафиксированных в банке, чтобы остальные банки -
    пользователи системы FraudMonitor могли воспользоваться
    этой информацией.

### Конфигурационный файл для интеграции с системой FraudMonitor

Все параметры интеграции с системой FraudMonitor находятся в
конфигурационном файле
`/etc/fraudwall/fraudmonitor/config.xml`, который представляет собой
XML-файл в кодировке UTF-8.

Синтаксис строки параметра следующий:

    <option name="параметр" value="значение"/>

> **Warning**
> 
> Так как конфигурационный файл имеет синтаксис XML, при указании
> значений параметров необходимо учитывать необходимость
> преобразования некоторых спецсимволов. Детали можно уточнить
> по ссылке <http://ru.wikipedia.org/wiki/XML>

<table>
<caption>Перечень параметров файла <code>/etc/fraudwall/fraudmonitor/config.xml</code></caption>
<thead>
<tr class="header">
<th style="text-align: center;">параметр</th>
<th style="text-align: center;">допустимые значения</th>
<th>назначение</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">key</td>
<td style="text-align: center;">текст</td>
<td><p>ключ доступа к системе FraudMonitor через API</p>
<blockquote>
<p><strong>Warning</strong></p>
<p>Ключ доступа через API - это не пароль доступа к интерфейсу системы FraudMonitor.</p>
<p>Данный ключ формируется банком через личный кабинет в интерфейсе системы FraudMonitor.</p>
</blockquote></td>
</tr>
<tr class="even">
<td style="text-align: center;">server</td>
<td style="text-align: center;">текст</td>
<td><p>сервер системы FraudMonitor, с которым будет работать система FraudWall, например <strong>fm.group-ib.ru</strong></p></td>
</tr>
<tr class="odd">
<td style="text-align: center;">inform</td>
<td style="text-align: center;">текст yes или no</td>
<td><p>при значениях <strong>yes</strong>, <strong>true</strong> или <strong>1</strong> включает механизм отправки реквизитов получателя при обнаружении мошеннического платежа.</p>
<p>При остальных значениях параметра, система FraudWall будет только получать информацию из системы FraudMonitor.</p></td>
</tr>
</tbody>
</table>

### Получение черных списков получателей из системы FraudMonitor

Для работы механизма получения информации о мошенниках необходимо
указать в конфигурационном файле интеграции с системой
FraudMonitor значения параметров **key** и **server**.

Процесс получения данных осуществляется автоматически с периодом
примерно 1 раз в час.

Журнал событий находится в файле
`/var/log/fraudwall/fw_fraudmonitor_get.log`

### Информирование системы FraudMonitor об обнаруженных мошеннических платежах

При указании в конфигурационном файле параметру **inform** одного из
значений **true**, **yes** или **1**, система FraudWall будет
передавать в систему FraudMonitor информацию о получателях
мошеннических платежей.

В систему FraudMonitor будут передаваться следующие данные из реквизитов
платежного поручения:

  - время создания платежного поручения

  - текст поля "Наименование получателя"

  - текст поля "ИНН получателя"

  - текст поля "БИК банка получателя"

  - текст поля "расчетный счет получателя"

  - текст поля "Город получателя"

  - текст поля "Назначение платежа" (с вырезанным из текста значением
    суммы платежа и суммы НДС)

Значение поля "Сумма платежа" для всех документов передается как 1
рубль.

Процесс отправки данных в систему FraudMonitor осуществляется
автоматически, как только в системе FraudWall документу
выставлен статус "Мошеннический" (передача данных на сервер
осуществляется с частотой примерно 1 раз в час).

Журнал событий находится в файле
`/var/log/fraudwall/fw_fraudmonitor_inform.log`

## Импорт списков по 550-П

В системе FraudWall реализована функция автоматического импорта списков,
получаемых банком в рамках 550-П.

Данный список может быть использован при написании собственных правил
антифрода, например, можно останавливать для дополнительной проверки
платежи на плательщиков, находящихся в этом списке.

Для импорта файлов на сервере управления предусмотрен сетевой диск сети
Microsoft с именем "`550p`". Для подключения к нему необходимо запустить
Проводник, ввести в пути текст вида `\\1.2.3.4\550p` (вместо 1.2.3.4
нужно указать IP адрес или доменное имя сервера управления
FraudWall). В качестве логина необходимо указать одного из пользователей
операционной системы: **root**, **secure** или **podft** с
соответствующим паролем (более детально см. [Интерфейс
передачи файлов посредством сетевых дисков сети
Microsoft](#admin_file_samba)).

На данном ресурсе должны храниться все XML-файлы, получаемые по 550-П.
При получении нового XML-файла, его нужно скопировать на данный
сетевой ресурс, не удаляя при этом уже находящиеся там файлы.

> **Warning**
> 
> С этого ресурса можно удалять только некорректные XML-файлы. Все ранее
> обработанные XML-файлы удалять не нужно, т.к. FraudWall при построении
> актуального списка 550-П использует только те XML-файлы, которые
> находятся на этом ресурсе на текущий момент.

Импорт списков 550-П начинается автоматически, как только завершилось
копирование новых XML-файлов на этот сетевой ресурс.

Процедура импорта файлов выполняется продолжительное время (до 30
минут), по завершению импорта формируется соответствующее событие в
журнале аудита системы (с указанием общего числа обработанных
XML-файлов).

При обнаружении ошибок импорта (например, XML-файл некорректного
формата) дополнительно формируется важное событие аудита, которое
отправляется по почте пользователям с ролью "Администратор", "Аудитор" и
"Сотрудник службы безопасности".

### Использование списков 550-П

Для использования списков 550-П необходимо в профиле обнаружения
мошеннических платежей создать одно или несколько ручных правил,
использующих критерии вида "ИНН плательщика из списка 550-П", "ИНН
получателя из списка 550-П" и аналогичных. При этом возможна как
остановка платежа, так и просто фиксация факта срабатывания правила -
для этого необходимо выбрать соответствующее действие "**подозревать в
краже средств**" или "**не останавливать платеж, но зафиксировать
срабатывание правила**".

## Импорт файлов фидов ФинЦЕРТ

FraudWall может автоматически обрабатывать файлы фидов с реквизитами
получателей, распространяемые ФинЦЕРТ ЦБ РФ в соответствии с частью
5 статьи 27 Федерального закона от 27 июня 2011 года "О национальной
платежной системе" 161-ФЗ.

Импорт таких файлов в FraudWall может быть осуществлен 2 способами:

  - через Web-интерфейс системы FraudWall "Аналитика по получателю"

  - путем отправки ZIP-файла на ящик
    **fwblack@сервер\_управления\_FraudWall**
    (аналогично рассылке "антидроп-клуба")

### Импорт файла фида ФинЦЕРТ через Web-интерфейс FraudWall

Для импорта файла фида ФинЦЕРТ необходимо зайти в интерфейс "Аналитика
по получателю", нажать на кнопку "Импорт черного списка получателей",
а затем указать ZIP-файл, полученный от ФинЦЕРТ:

![Кнопка для импорта черного списка получателей](./images/figure99.jpg)

> **Note**
> 
> Файл фида обрабатывается в том виде, в котором его предоставил ФинЦЕРТ
> - т.е. в виде ZIP-файла. Предварительно извлекать из него CSV-файлы не
> требуется.

### Импорт файла фида ФинЦЕРТ через почтовое сообщение

Файл фида может быть импортирован также путем отправки почтового
сообщения, содержащего ZIP-файл фида ФинЦЕРТ, на ящик
**fwblack@сервер\_управления** (аналогично обработки письма
антидроп-клуба).

> **Note**
> 
> Письма с фидами ФинЦЕРТ должны быть отправлены только с почтовых
> ящиков пользователей FraudWall с ролью "администратор" и
> "сотрудник безопасности"

# Информирование о событиях в системе

## Информирование по SMTP-почте

  - административные

  - при обнаружении подозрительного платежного поручения в системе ДБО

Схема доставки SMTP-сообщений показана на рисунке:

![Схема доставки SMTP-сообщений](./images/figure73.jpg)

Для доставки **SMTP**-сообщений, формируемых компонентами системы
FraudWall, используется локально установленный почтовый сервер на базе
программного обеспечения **postfix**, выполняющего роль почтового
релея.

Все письма, попадающие на **postfix**, перенаправляются на внешний
**SMTP**-сервер банка, IP адрес которого указан в параметре
`mail_server` конфигурационного файла `fraudwall.xml`.

Каждый пользователь, которому необходимо получать SMTP-сообщения, должен
быть создан в WWW-интерфейсе системы. Почтовый SMTP-ящик пользователя
указывается в параметре ` e-mail пользователя  `(см.рисунок):

![Конфигурирование SMTP-почтового ящика
пользователя](./images/figure74.jpg)

Каждый пользователь может иметь только один почтовый ящик.

Если в системе зарегистрировано несколько пользователей, каждое
сообщение отправляется параллельно нескольким пользователям (с
учетом их ролей и прав доступа в системе).

### Формирование конфигурации postfix

Формирование конфигурации postfix осуществляется автоматически на основе
данных о пользователях WWW-интерфейса системы (список SMTP-адресов
пользователей и их права доступа), а также конфигурационного файла
`fraudwall.xml` (IP адрес внешнего почтового сервера банка, на который
будет отправляться все сообщения системы.

Каждый раз после изменения параметра mail\_server в файле
`fraudwall.xml`, а также создания (удаления) пользователей с ролью
«Администратор» и изменения их SMTP-адресов, необходимо выполнить
следующую команду: `fw_control -s mail`

### Журнал событий доставки SMTP-сообщений

Т.к. доставкой SMTP-сообщений занимается postfix, все события помещаются
в файл журнала
    `/var/log/maillog`.

    Apr 19 06:10:53 localhost postfix/pickup[4926]: E579F60556: uid=0 from=<>
    Apr 19 06:10:53 localhost postfix/cleanup[7824]: E579F60556: message-id=<20120419061053.E579F60556@localhost.localdomain>
    Apr 19 06:10:53 localhost postfix/qmgr[1331]: E579F60556: from=<>, size=2173, nrcpt=2 (queue active)
    Apr 19 06:10:53 localhost postfix/smtp[7827]: connect to 192.168.1.158[192.168.1.158]:25: Connection refused
    Apr 19 06:10:53 localhost postfix/smtp[7827]: E579F60556: to=<b@test.com>, relay=none, delay=0.01, delays=0.01/0/0/0, dsn=4.4.1, status=deferred (connect to 192.168.1.158[192.168.1.158]:25: Connection refused)
    Apr 19 06:10:53 localhost postfix/smtp[7827]: E579F60556: to=<x@x.com>, relay=none, delay=0.01, delays=0.01/0/0/0, dsn=4.4.1, status=deferred (connect to 192.168.1.158[192.168.1.158]:25: Connection refused)

Дата/время в файле журнала событий фиксируются во временной зоне UTC.

В файле журнала событий, каждому почтовому сообщению присваивается
уникальный идентификатор (в данном случае это **E579F60556**), по
которому можно отследить историю доставки почтового сообщения.

### Повторная отправка почты

В случае недоступности почтового сервера банка, все SMTP-сообщения
помещаются в очередь. Максимальное время хранения одного письма в
очереди - 1 сутки.

Почтовая система postfix автоматически пытается повторить доставку писем
через каждые 3 минуты с момента времени неуспешной доставки.

Для принудительной доставки всех писем из очереди необходимо выполнить
команду: `postqueue -f`

### Особенности доставки административных SMTP-сообщений

  - проблемы, обнаруженные при мониторинге работоспособности системы
    (сбой одного из сервисов системы FraudWall, чрезмерная загрузка
    памяти, процессора и т.д.)

  - события по самовосстановлению системы (перезапуск отказавшего
    сервиса и т.д.)

  - ошибки при выполнении системных процессов

Административные сообщения направляются всем пользователям
WWW-интерфейса системы FraudWall с ролью «Администратор», у
которых указан
e-mail.

### Особенности доставки SMTP-сообщений при обнаружении подозрительного платежного поручения

  - сотрудник службы безопасности

  - операционист бэк-офиса

<!-- end list -->

  - пользователь должен быть активным (т.е. не заблокированным и не
    удаленным)

  - реквизиты подозрительного платежного поручения должны удовлетворять
    правам доступа пользователя на основании списков БИК, масок
    расчетных счетов либо кодов подразделений

Это разделение сделано для того, чтобы уведомления о подозрительных
платежных поручениях отправлялись сотрудникам соответствующего
филиала.

# Мониторинг и самовосстановление системы

## Общие принципы

В системе FraudWall предусмотрена система непрерывного мониторинга и
автоматического самовосстановления на основе программного
обеспечения **[monit](http://mmonit.com/monit/)**.

Система мониторинга осуществляет проверку работоспособности всех
сервисов и процессов системы, а также общей загрузки памяти (как
оперативной, так и виртуальной), места на жестком диске и загрузки
процессора.

В случае обнаружения неработоспособности какого-либо сервиса за
определенный промежуток времени, monit автоматически
перезапускает отказавший сервис.

Если несколько перезапусков отказавшего сервиса не смогли устранить
проблему, осуществляется автоматическая перезагрузка операционной
системы.

При чрезмерной продолжительной общей загрузке процессорного времени,
вызванной несколькими сервисами, перезагрузка операционной системы
не осуществляется - периодически формируется только почтовое
уведомление.

На каждое из событий системы мониторинга и самовосстановления
формируется почтовое уведомление на e-mail всех пользователей
WWW-интерфейса с ролью «Администратор».

Среднее время на самовосстановление отказавшего компонента составляет
порядка 2 минут, а в сложных случаях (с перезагрузкой операционной
системы) - порядка 15 минут.

Реализованный механизм мониторинга системы обеспечивает непрерывность
процесса самовосстановления системы в режиме 24x7.

## Журнал событий системы мониторинга

Все события системы мониторинга фиксируются в файле журнала событий
`/var/log/monit`.

    [16.04.2012 10:08:47 UTC] info     : Reinitializing monit daemon
    [16.04.2012 10:08:47 UTC] info     : monit: No daemon process found
    [16.04.2012 10:08:57 UTC] info     : Starting monit daemon with http interface at [*:2812]
    [16.04.2012 10:08:57 UTC] info     : Starting monit HTTP server at [*:2812]
    [16.04.2012 10:08:57 UTC] info     : monit HTTP server started
    [16.04.2012 10:08:57 UTC] info     : 'system' Monit instance changed (Monit started)
    [16.04.2012 10:09:07 UTC] error    : 'fwslave_process' Does not exist (process is not running)
    [16.04.2012 10:09:07 UTC] info     : 'fwslave_process' trying to restart
    [16.04.2012 10:09:07 UTC] info     : 'fwslave_process' start: /etc/init.d/fw_slave
    [16.04.2012 10:10:19 UTC] info     : 'fwslave_process' Exists (process is running with pid 4386)

Дата/время в файле журнала событий фиксируются во временной зоне UTC.

## WWW-интерфейс системы мониторинга

Система мониторинга имеет собственный WWW-интерфейс, посредством
которого можно посмотреть актуальный статус каждого из
контролируемых сервисов, а также журнал событий.

WWW-интерфейс системы мониторинга доступен по протоколу HTTP, TCP порт
2812 (пользователь admin, пароль admin).

Несмотря на то, что WWW-интерфейс системы monit настроен в режиме
«только для чтения», рекомендуется на межсетевых экранах
разрешить доступ к этому порту только с компьютеров
администраторов системы.

## Мониторинг серверов ДБО

Помимо непрерывного мониторинга работоспособности компонент FraudWall, в
системе предусмотрен также мониторинг работоспособности самой системы
ДБО в целом.

Проверка работоспособности системы ДБО осуществляется на основании дампа
трафика работы клиентов (который также используется для обнаружения
мошеннических платежей).

> **Note**
> 
> Так как в качестве исходных данных для анализа используется дамп
> трафика, мониторинг работоспособности ДБО осуществляется только
> для "тонкого" клиента ДБО.

Проверке подлежат следующие параметры:

  - задержки в сохранении файла дампа

  - общее время загрузки (UPLOAD) файла на сервер

  - максимальное время обработки HTTP-запроса WWW-сервером (первая
    страница, "быстрые" запросы, любой запрос)

Вся конфигурация подсистемы мониторинга ДБО находится в файле
`/etc/fraudwall/diagnose.conf`. Описание проверяемых параметров, а также
пороговые значения для срабатывания приведены непосредственно в этом
файле.

### Автоматическая диагностика проблем в ДБО

Дамп трафика проверяется на наличие каких-либо проблем на серверах ДБО с
периодом в 10 минут.

Система мониторинга автоматически проверяет - сколько HTTP-запросов в
единицу времени обрабатывалось дольше допустимого времени. Если таких
HTTP-запросов слишком много, то система автоматически формирует почтовый
алерт на администраторов системы.

> **Note**
> 
> Если на сервере системы ДБО в ночное время выполняются технологические
> работы, можно отключить формирование почтовых уведомлений в ночное
> время, указав в конфигурационном файле
> `/etc/fraudwall/diagnose.conf` в параметре **email\_options** значение
> (будут проверяться только события с 9 до 18 часов местного времени):
> 
>     $email_options = "-t 09 18";
> 
> При желании в значение этого параметра можно также добавить
> дополнительные опции: ограничить список проверяемых сайтов,
> указать собственные параметры группировки отчета и т.д.
> 
> Полный перечень параметров можно увидеть, выполнив команду
> `fw_diagnose`

### Диагностика проблем с ДБО в ручном режиме

С помощью утилиты диагностики, поставляемой в комплекте FraudWall, можно
также анализировать динамику возникновения проблем в системе ДБО за
любой период времени (на основании архивов дампа трафика).

Утилита диагностики запускается командой `fw_diagnose`

Для анализа данных в ручном режиме в командной строке необходимо указать
путь, где находятся дампы трафика, имя результирующего файла с отчетом и
т.д. - их полный список отображается при запуске утилиты диагностики без
параметров.

# Обновление программного обеспечения

## Общие принципы

  - обновление программного обеспечения операционной системы

  - обновление программного обеспечения FraudWall

Обновление осуществляется посредством штатного механизма скачивания и
установки обновлений на базе программного обеспечения
**[yum](http://yum.baseurl.org/)**, являющегося частью операционной
системы RedHat Enterprise Linux.

  - репозиторий RedHat - используется для обновления операционной
    системы RedHat Enterprise Linux

  - общебанковский репозиторий FraudWall - используется для обновлений
    программного обеспечения, используемого системой FraudWall для
    всех банков

  - персональный банковский репозиторий FraudWall - используется для
    обновлений программного обеспечения, используемого в конкретном
    банке.

В упрощенной конфигурации предполагается, что сервер с установленной
системой FraudWall будет скачивать обновления непосредственно из
сети Интернет.

В случае установки выделенного WWW-сервера обновлений, скачивание
обновлений осуществляется централизованно WWW-сервером
обновлений. Каждый из серверов системы FraudWall в этом случае
скачивает обновление не через Интернет, а непосредственно с WWW-сервера
обновлений (в этом случае какого-либо доступа с серверов системы
FraudWall в сеть Интернет не требуется).

## Информирование о необходимости установки обновлений

Все сервера системы FraudWall автоматически (ежечасно) проверяют наличие
обновлений на операционную систему и программное обеспечение системы
FraudWall.

Если новое обновление не удалось установить в автоматическом режиме
(например, установлен ручной режим обновлений, либо произошла
какая-либо ошибка), на почтовые ящики пользователей с ролью
«администратор системы» формируется письмо с соответствующим
текстом.

## Обновление программного обеспечения операционной системы

### Техническая поддержка на RedHat Enterprise Linux

Для обновления программного обеспечения операционной системы необходимо
наличие со стороны компании RedHat действующей технической поддержки
операционной системы RedHat Enterprise Linux уровня не ниже
«Self-support Subscription». Если сотрудники банка имеют недостаточный
опыт работы с операционной системе RedHat Linux, рекомендуется
заключить техническую поддержку более высокого уровня
(«Standard Subscription» либо «Premium Subscription»).

Компания RedHat также предоставляет возможность получить бесплатную
техническую поддержку на операционную систему уровня «Self-support
Subscription» на ознакомительный период сроком на 1 месяц.

> **Warning**
> 
> При отсутствии действующей технической поддержки со стороны компании
> RedHat обновление программного обеспечения операционной системы
> невозможно, кроме того, работоспособность системы FraudWall не
> гарантируется.

### Установка обновлений на операционную систему в ручном режиме

По умолчанию, установка обновлений на операционную систему
осуществляется в ручном режиме.

Для обновления программного обеспечения операционной системы и
FraudWall, необходимо в SSH-консоли вручную выполнить следующую команду:
`fw_update -s`

> **Note**
> 
> Без опции "`-s`" будет осуществляться обновление только программного
> обеспечения FraudWall.

Если на момент запуска указанной команды процедура обновления уже
запущена в параллельном процессе, будет выведен соответствующий
текст и работа команды будет прекращена. В этом случае необходимо
подождать 5-10 минут и повторить еще раз:

![Сообщение о уже запущенном процессе обновления](./images/figure75.jpg)

Если предыдущий запуск процедуры обновления завершился некорректно,
запуск нового процесса обновления возможен не ранее, чем через 300
минут с момента предыдущего запуска.

Как правило, обновления на операционную систему не требуют перезагрузки
и не вносят существенного изменения в работоспособность запущенных
компонент системы FraudWall, поэтому их можно устанавливать в
рабочее время.

Тем не менее, обновление некоторых системных компонент (например, glibc)
приводит к сбросу параметров, используемых запущенными компонентами
FraudWall, поэтому они перестают работать до полной перезагрузки
операционной системы.

Обновления на операционную систему рекомендуется устанавливать во
внерабочее время, но не не реже 1 раза в неделю.

Если в процессе обновления было обновлено ядро Linux (пакет kernel-…),
то после завершения процесса обновлений необходимо перегрузить
операционную систему командой: `reboot`

Если при этом сервер установлен на виртуальную машину VMWare, после
перезагрузки необходимо дополнительно выполнить команду:
`vmware-config-tools.pl -m`

### Установка обновлений на операционную систему в автоматическом режиме

Если в конфигурационном файле `/etc/fraudwall/fraudwall.xml` значение
параметра `autoupdate_rh` задано как “**on**”, а `autoupdate_fw` не
задано как “**off**”, то обновление операционной системы
осуществляется автоматически, как только обновление
доступно в репозитории.

> **Warning**
> 
> Указанные параметры необходимо сконфигурировать на каждом сервере.

Если установка обновления привела к сбросу параметров, используемых
запущенными компонентами FraudWall, они завершают свою работу. В
этом случае система мониторинга автоматически попытается
перезапустить отказавший компонент, а затем (после
нескольких попыток) выполнит перезагрузку операционной системы.
После перезагрузки все сервисы FraudWall продолжат свою работу в обычном
режиме.

Таким образом, ориентировочное время неработоспособности компонент не
превысит 15 минут (это примерное время отказа сервиса, после которого
система мониторинга отправит сервер на перезагрузку).

После установки обновлений на ядро Linux (пакет kernel-\*), обновления
не вступят в силу до тех пор, пока администратор системы вручную не
перезагрузит сервер (см. раздел [Установка обновлений на операционную
систему в ручном режиме](#manual_os_update)).

## Обновление программного обеспечения системы FraudWall

### Техническая поддержка на систему FraudWall

Для обновления программного обеспечения FraudWall необходимо наличие
действующей технической поддержки на систему FraudWall. Текущий срок
окончания действия техподдержки можно посмотреть в WWW-интерфейсе
системы FraudWall, пункт «о системе» меню «Помощь»:

### Установка обновлений на систему FraudWall в ручном режиме

По умолчанию, установка обновлений на систему FraudWall осуществляется в
**автоматическом** режиме. Тем не менее, можно отключить режим
автоматической установки обновлений на систему FraudWall,
выставив значение параметра `autoupdate_fw` как “**off**”. При
обнаружении нового доступного обновления, на почтовые ящики
пользователей с ролью «администратор системы» формируется письмо
с соответствующим текстом.

> **Warning**
> 
> Указанные параметры необходимо сконфигурировать на каждом сервере.

Обновление программного обеспечения системы FraudWall осуществляется
вручную в SSH-консоли посредством выполнения следующей команды:
`fw_update`

Если на момент запуска указанной команды процедура обновления уже
запущена в параллельном процессе, будет выведен соответствующий
текст и работа команды будет прекращена.

Если предыдущий запуск процедуры обновления завершился некорректно,
запуск нового процесса обновления возможен не ранее, чем через 300
минут с момента предыдущего запуска.

Обновления программного обеспечения системы FraudWall готовятся с тем
расчетом, чтобы они могли быть установлены на рабочую систему без
существенного простоя (ориентировочный простой составит не более 2-3
секунд), поэтому рекомендуется не отключать автоматическое обновление
компонент системы FraudWall.

Рекомендуется устанавливать обновления программного обеспечения системы
FraudWall не реже, чем 1 раз в день.

### Установка обновлений на систему FraudWall в автоматическом режиме

Если в конфигурационном файле `/etc/fraudwall/fraudwall.xml` значение
параметра `autoupdate_fw` не задано как “off” (т.е. выставлено
значение “on”, либо данный параметр отсутствует), обновление
программного обеспечения FraudWall осуществляется автоматически,
как только обновление станет доступным в репозитории.

## Механизм получения обновлений

Получение (скачивание) обновлений осуществляется штатной утилитой
**yum** по протоколу HTTP с WWW-серверов, находящихся в сети Интернет.

В случае использования выделенного WWW-сервера обновлений, все
обновления скачиваются централизованно и автоматически
«публикуются» на WWW-сервере **apache**, являющейся частью
программного обеспечения WWW-сервера обновлений. Поэтому, все
остальные сервера могут забирать обновления не из сети Интернет, а
непосредственно с сервера обновлений.

При отсутствии выделенного WWW-сервера обновлений, каждый из серверов с
системой FraudWall вынужден самостоятельно скачивать обновления из сети
Интернет.

### Использование централизованного WWW-сервера обновлений

> **Warning**
> 
> Конфигурирование серверов FraudWall на централизованное получение
> обновлений можно только после завершения настройки WWW-сервера
> обновлений (раздел [Установка WWW-сервера
> обновлений](#fraudwall_update_install)).

IP адрес сервера обновлений является одним из сетевых параметров
операционной системы и указывается в процессе установки
операционной системы (см.раздел [Установка операционной
системы](#os_install)) либо после (см.раздел [Администрирование
сетевых настроек](#os_network_cfg)).

  - обновления операционной системы - ежесуточно примерно в 8:00 и 20:00
    временной зоны UTC (в 12:00 и 24:00 московского времени
    соответственно)

  - обновления программного обеспечения FraudWall - ежечасно

Инициировать процесс скачивания обновлений можно также вручную, выполнив
на WWW-сервере обновлений команду: `fw_update`

После успешного получения обновлений, они становятся доступными для
серверов с системой FraudWall.

### Конфигурирование получения обновлений в проксированном режиме

> **Warning**
> 
> Данные настройки необходимо делать только на сервере, который
> непосредственно получает обновления из сети Интернет. Если
> используется WWW-сервер обновлений, то указывать параметры
> подключения к proxy-серверу необходимо делать только на нем.

Если взаимодействие с Интернет осуществляется через proxy-сервер, в
конфигурационном файле `/etc/yum.conf` в секции **\[main\]**
необходимо прописать IP адрес и порт proxy-сервера, а также
добавить опцию http\_caching=none, как показано ниже:

    [main]
    # в параметре proxy укажите IP адрес и порт подключения
    # к proxy-серверу
    proxy=http://192.168.1.1:3128
    http_caching=none

При необходимости можно также указать логин и пароль для доступа к
proxy-серверу (если авторизации на proxy-сервере нет, строки с
proxy\_username и proxy\_password необходимо удалить\!):

    [main]
    proxy=http://192.168.1.1:3128
    proxy_username=USER
    proxy_password=PASSWORD
    http_caching=none

# Интеграция FraudWall с информационными системами банка

## С какими системами банка и для каких целей требуется интеграция

FraudWall является аналитической системой, которая для анализа получает
следующую
информацию:

| тип информации                                                                                                                    | возможные источники                                                                                                       |
| :-------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------- |
| реквизиты платежных поручений, создаваемых посредством систем ДБО                                                                 | база данных ДБО, база данных АБС                                                                                          |
| реквизиты платежных поручений, создаваемых сотрудниками банка в системе АБС                                                       | база данных АБС                                                                                                           |
| дамп трафика работы клиентов в системе ДБО, поступающего на WWW-сервер банка                                                      | WWW-сервер ДБО                                                                                                            |
| история исполненных в АБС платежных поручений клиентов                                                                            | база данных ДБО, база данных АБС                                                                                          |
| реквизиты платежных поручений, поступающих из других банков                                                                       | база данных АБС                                                                                                           |
| информацию о счетах клиенте банка (перечне его счетов и текущем остатке на счете)                                                 | база данных ДБО, база данных АБС                                                                                          |
| контактную информацию о клиенте банка (ФИО, должность и контактный телефон представителей клиента (директор, гл.бухгалтер и т.д.) | база данных ДБО, база данных АБС, база данных CRM                                                                         |
| информацию о наличии вредоносной активности на стороне компьютера клиента                                                         | облачные решения Kaspersky Fraud Prevention Cloud, Group-IB Bot-Trek Secure Bank, IBM Trusteer Pinpoint Malware Detection |

Источники данных

> **Note**
> 
> Для FraudWall необязательно предоставлять всю вышеперечисленную
> информацию - он будет использовать только те данные, которые
> ему доступны на текущий момент.
> 
> Например, информация о наличии вредоносной активности на стороне
> компьютера клиента требует интеграции с дополнительными
> решениями от компаний Group-IB, Kaspersky Labs или IBM
> Trusteer. Если такие решения в банке не внедрялись, FraudWall
> принимает решение о подозрительности платежа по оставшимся
> доступным ему данным.

Результатом работы FraudWall является:

  - статус обработки платежного поручения - является ли оно
    подозрительным или нет, нужно ли его приостановить его
    дальнейшее исполнение в АБС

  - информирование сотрудников банка о подозрительных событиях -
    например, подозрительное изменение паспортных данных клиента
    и т.д.

  - звонок клиенту для подтверждения подозрительного платежа (общение
    осуществляется полностью в автоматизированном режиме с помощью
    сервера синтеза и распознавания речи)

> **Warning**
> 
> При минимальной настройке, FraudWall может только информировать о
> подозрительных событиях и платежах, никак не вмешиваясь в процесс
> создания и исполнения платежей в банке (т.е. работа в режиме
> мониторинга).
> 
> Чтобы останавливать подозрительные платежи, требуется дополнительная
> донастройка FraudWall и, возможно, доработка АБС или ДБО банка.

## Варианты интеграции FraudWall с системами банка

### Анализ платежей из базы данных

> **Note**
> 
> Этот вариант интеграции является наиболее оптимальным на этапе
> тестирования системы (см.[Типовой вариант интеграции с ДБО на
> этапе тестирования системы](#af_testdrive_mode)).

В данном варианте FraudWall периодически опрашивает базу данных ДБО или
АБС на предмет появления новых платежей.

Работа с базой данных осуществляется в режиме "только на чтение", что
исключает какие-либо проблемы с работоспособностью ДБО или АБС.
Платеж, даже если он вызвал подозрение, в ДБО не останавливается,
и выгружается в АБС штатными механизмами.

Остановка подозрительных платежей осуществляется в системе АБС, для
этого FraudWall выгружает реквизиты подозрительного платежа в
таблицу - справочник подозрительных платежей, созданной в базе
данных АБС. Задача АБС заключается в том, чтобы запретить исполнение
платежных документов, реквизиты которых находятся в таблице -
справочнике подозрительных платежей.

![Упрощенная схема интеграции на уровне анализа платежей в базе
данных](./images/common2.gif)

Для данного варианта интеграции, в базе ДБО или АБС обязательно должны
быть доступны следующие VIEW:

  - VIEW **fraudwall\_doc**

  - VIEW **fraudwall\_learn**

  - VIEW **fraudwall\_balance**

Остальные VIEW создаются по возможности.

Для торможения подозрительных платежей дополнительно необходимо
реализовать функционал, описанный в разделе [Остановка
подозрительного платежа через таблицу
fraudwall\_alert](#abs_stop).

### Анализ WWW-трафика

Дополнительно к анализу реквизитов платежей из базы данных, FraudWall
может анализировать информацию из дампа трафика работы клиента в ДБО.

Дамп трафика дает для анализа гораздо больше информации, чем
непосредственная работа с реквизитами платежного документа в
базе данных.

Например, если в процессе анализа трафика фиксируется, что сервер на
запрос клиента возвращает ошибку, весьма вероятна ситуация, что
данный запрос был сформирован троянской программой, которая не
учитывает особенности настройки конкретного сервера ДБО. Если же с
сервером «в ручном режиме» работает непосредственно клиент,
возникновение ошибки маловероятно.

Дамп трафика снимается на стороне банка модулем hGuard системы
FraudWall. Снятый дамп записывается в файл, который в дальнейшем
анализируется системой FraudWall в online-режиме.

Размер файла дампа трафика получается небольшим, т.к. в него
записывается только динамический контент, а статический
(картинки, html-страницы и т.д.) в файл дампа не помещаются.

Параметры интеграции с системой ДБО задаются посредством пункта «Сайты»
в меню «Система», вкладка «WWW-сервер ДБО»:

![Параметры интеграции с ДБО на уровне анализа дампа
трафика](./images/figure76.jpg)

> **Warning**
> 
> Обратите внимание, анализ дампа трафика является дополнением к способу
> анализа платежей в базе данных, поэтому в базах ДБО и АБС необходимо
> создать соответствующие VIEW и таблицы.
> 
> Для торможения подозрительных платежей дополнительно необходимо
> реализовать функционал, описанный в разделе [Остановка
> подозрительного платежа через таблицу
> fraudwall\_alert](#abs_stop).

#### Интеграция в случае установки модуля BSI системы BS-Client на сервере FraudWall

> **Note**
> 
> При интеграции с ДБО BS-Client "Интернет-клиент" данный вариант
> является предпочтительным

Одним из вариантов интеграции системы FraudWall заключается в установке
модуля BSI ДБО BS-Client непосредственно на тот же WWW-сервер apache,
где уже установлен модуль hGuard системы FraudWall.

В этом случае модуль BSI системы BS-Client (а следовательно, и вся
система ДБО BS-Client) работает непосредственно с IP-адресом
клиента в сети Интернет, тем самым позволяя фильтровать клиента по
внешнему IP-адресу.

Со стороны системы ДБО BSClient, модуль BSI, установленный на сервере
системы FraudWall, полностью соответствует требованиям раздела
«Настройка параметров взаимодействия компонентов при
использовании веб-сервера Apache» документации по системе
BSClient.

Формирование всех конфигурационных файлов (apache, mod\_jk, tomcat и
т.д.), указанное в документации по системе BSClient, осуществляется
автоматически на основе параметрах, указанных в настройках сайта
конфигурации системы FraudWall. Вручную необходимо только
сформировать bsi.xml, а также скопировать bsi.jar и файлы
www-сервера (детали в разделе [Установка модуля BSI на сервер FraudWall
(предварительный этап)](#bsi_install_step1)).

#### Интеграция в проксированном режиме

В типовом сценарии интеграции системы FraudWall с внутренним
WWW-сервером (в т.ч. являющимся сервером системы ДБО)
предполагается, что клиент первоначально соединяется с
модулем hGuard, где осуществляется проверка данных запроса
клиента на допустимость. В случае, если запрос допустим согласно
правил фильтрации, он передается на защищаемый WWW-сервер в
прокси-режиме. Информация о IP-адресе клиента,
SSL-характеристик установки HTTPS-соединения передается на
защищаемый WWW-сервер как дополнительные HTTP-теги.

![Упрощенная схема интеграции в проксированном
режиме](./images/common.gif)

Недостатком такой схемы интеграции FraudWall с системой ДБО является то,
что на WWW-сервере в качестве IP адреса клиента будет выступать IP-адрес
сервера системы FraudWall.

Поэтому, модуль фильтрации трафика FraudWall передает информацию об
оригинальном IP адресе клиента в HTTP-заголовке `X-hGuard-ClientIP`
каждого HTTP-запроса, передаваемого на WWW-сервер ДБО. Если для системы
ДБО важна информация об IP адресе клиента, программное обеспечение ДБО
должно использовать значение из этого HTTP-заголовка вместо IP адреса,
с которого было соединение с WWW-сервером системы
ДБО.

### Анализ платежей по принципу "вопрос - ответ" (POST-запрос через HTTPS)

В данном варианте интеграции система ДБО сама передает реквизиты платежа
для анализа, а FraudWall, в свою очередь, сразу возвращает результат
проверки данного платежа. В этом случае система ДБО не будет
выгружать подозрительный платеж в АБС до тех пор, пока по
данному платежу не будет получено подтверждение клиента.

Преимуществом данного варианта является то, что не требуется доработка
АБС, т.к. в АБС будут попадать только "хорошие" платежные поручения.
На текущий момент по такому варианту интеграции работает ДБО isFront.

Взаимодействие осуществляется по протоколу HTTPS, путем отправки
POST-запроса, содержащего реквизиты платежного поручения. В базе ДБО
необходимо дополнительно создать VIEW
**fraudwall\_learn**.

### Анализ платежей по принципу "вопрос - ответ" (через таблицу fraudwall\_alert)

В некоторых случаях реализация варианта "вопрос-ответ" посредством
HTTPS-протокола не удобна или вообще не возможна. Поэтому в FraudWall
предусмотрен механизм обмена данными через таблицу fraudwall\_alert.

В таком варианте интеграции система ДБО или АБС помещает реквизиты
платежа для анализа в таблицу fraudwall\_alert с значением поля
status, равным X. FraudWall же, в свою очередь, периодически ищет записи
в этой таблице с значением поля status, равным X, анализирует найденные
платежи, а результат анализа (является ли документ подозрительным или
нет) помещает в поле status.

> **Warning**
> 
> Необходимо убедится, что на проверку АБС отдает только переводы
> клиентов банка на счета клиентов того же банка (переводы внутри
> банка) и любые переводы в другие банки. Внутренние платежи (погашению
> процентов по кредитным договорам, начисление процентов на депозиты,
> расчеты по процессингу и т.д.) не должны попадать на проверку
> FraudWall.

Для данного варианта интеграции, помимо таблицы fraudwall\_alert
обязательно должны быть доступны следующие VIEW:

  - VIEW **fraudwall\_learn**

  - VIEW **fraudwall\_balance**

Остальные VIEW создаются по возможности.

### Типовой вариант интеграции с ДБО на этапе тестирования системы

#### Настройка на стороне базы данных ДБО

Наиболее простым является вариант интеграции путем анализа платежей из
базы данных ДБО без их остановки в АБС. Это не потребует каких-либо
доработок, достаточно будет настроить базу данных ДБО.

  - создать пользователя, под которым FraudWall будет подключаться к
    базе данных

  - предоставить созданному пользователю доступ с правом SELECT для
    работы VIEW

  - создать набор VIEW в соответствии с требованиями настоящего раздела

  - создать индексы (при необходимости), ускоряющие работу запросов типа
    SELECT FROM VIEW

> **Note**
> 
> Примеры SQL-команд для интеграции с различными системами ДБО под
> разные СУБД находятся в директории `/usr/share/doc/fraudwall` на
> сервере управления. Если вы затрудняетесь самостоятельно создать
> необходимые VIEW, обратитесь в службу технической поддержки.

#### Настройка на стороне FraudWall

Работы по настройке FraudWall необходимо начинать только после того, как
были выполнены работы на стороне сервера базы данных системы ДБО.

> **Warning**
> 
> Конфигурирование осуществляется на сервере управления.

Подключение к базе данных ДБО осуществляется посредством ODBC. Процедура
установки и конфигурирования ODBC-драйверов приведена в разделе
[Установка ODBC-драйверов](#odbc_install).

После проверки работоспособности ODBC, необходимо открыть WWW-интерфейс
администрирования системы, пункт «Сайты» меню «Система», и создать
новый Web-сайт с типом «`Анализ платежей в базе данных
(универсальный режим)`»:

![Тип Web-сайта, который используется для подключения к базе данных
ДБО](./images/figure77.jpg)

В вкладке «Анализируемая база данных» необходимо указать параметры
подключения к базе данных ДБО:

![Параметры для подключения к базе данных ДБО](./images/figure78.jpg)

После сохранения конфигурации сайта, FraudWall автоматически подключится
к серверу баз данных и начнет анализировать платежи, начиная с текущего
момента времени.

Журнал событий анализатора платежей из базы данных ДБО находится в файле
`/var/log/fraudwall/siteXXX-af.log`, где XXX - ID созданного сайта.

При обнаружении ошибок в анализируемой базе данных (например, отсутствие
прав доступа, некорректный набор полей в VIEW и т.д.), пользователю с
ролью "Администратор" формируется почтовое уведомление с описанием
текста ошибки.

## Получение анализируемого платежа из базы данных

В зависимости от варианта интеграции, платеж для анализа получается из
базы данных АБС или ДБО либо из VIEW **fraudwall\_doc**, либо из
таблицы **fraudwall\_alert**.

Преимуществом работы через VIEW **fraudwall\_doc** является то, что она
не требует доработки ДБО или АБС - вся работа по интеграции сводится к
конфигурированию СУБД.

Преимуществом работы через таблицу **fraudwall\_alert** является гораздо
большая производительность, гарантированная обработка всех платежей и
небольшая нагрузка на базу данных ДБО или АБС.

### VIEW fraudwall\_doc

#### Назначение

VIEW **fraudwall\_doc** используется для получения реквизитов платежных
поручений, которые должны быть проверены системой FraudWall.

> **Warning**
> 
> Данная VIEW должна возвращать все документы, имеющие в ДБО статусы
> вида "сохранен черновик", "подписан", "отправлен в АБС" и т.д.
> 
> Во VIEW **не должны** попадать документы с конечным статусом (
> "исполнен", "отказан в исполнении", "удален" и т.д.)

VIEW **fraudwall\_doc** по желанию банка может возвращать реквизиты даже
платежей, которые еще не отправлены в банк на исполнение (т.е.
черновики). Для того, чтобы FraudWall мог отличить черновик
документа от его конечной версии (т.е. отправленной в банк на
исполнение), предусмотрено поле docid - если оно пустое (NULL или
пустая строка), FraudWall будет считать этот документ черновиком. Как
только платежное поручение было отправлено в банк на исполнение, у
него должно обновится поле **updated** (чтобы этот документ опять
попал в результат выборки), а также **docid** - оно должно уже
содержать непустое значение.

#### Применимость

VIEW fraudwall\_doc необходимо создавать только для антифрода платежей
физ.лиц, юр.лиц и операционистов, и только если предполагается
интеграция в режиме анализа VIEW fraudwall\_doc.

При интеграции в режиме анализа таблицы fraudwall\_alert, а также для
FraudWall AML эту VIEW создавать не нужно.

VIEW fraudwall\_doc может создаваться как в ДБО, так и в АБС - в
зависимости от того, где находятся платежи для анализа.

#### Запросы, которые делает FraudWall

FraudWall периодически формирует следующие запросы в анализируемую базу
данных:

` SELECT * FROM fraudwall_doc  `

`WHERE updated >= lasttime`

` /* условие ниже добавляется, если в свойствах сайта указано непустое
значение параметра "Анализировать платежи, у которых поле дата
платежа..." */  `

`AND docdate >= startdate`

`ORDER BY updated ASC, from_inn, docnumber ASC`

где **lasttime** - дата и время последней обработанной записи при
предыдущем опросе, **startdate** - поле документа "дата платежа",
начиная с которой нужно возвращать данные.

> **Note**
> 
> Фильтр по полю docdate добавлен в SQL-запрос, т.к. в некоторых
> системах ДБО не предусмотрено штатного индекса для значения
> updated. Значение startdate вычисляется на основании параметра
> "Анализировать платежи, у которых поле "дата платежа" ...
> рабочих дней"

Периодичность опроса базы данных ДБО устанавливается в конфигурации
сайта FraudWall, в параметре "Периодичность поиска новых платежей в
базе данных: NNN секунд"

#### Перечень полей

<table>
<caption>Перечень полей VIEW fraudwall_doc</caption>
<thead>
<tr class="header">
<th>Поле</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>updated</td>
<td>Время последнего изменения состояния документа на стороне сервера банка. Формат поля - ДАТА ВРЕМЯ.
<blockquote>
<p><strong>Warning</strong></p>
<p>При создании VIEW убедитесь, что поле в базе данных соответствует времени на стороне сервера, а не времени на стороне клиента (особенно это актуально для толстого клиента ДБО)</p>
</blockquote></td>
</tr>
<tr class="even">
<td>docid</td>
<td><p>Идентификатор документа в анализируемой базе, или пустое значение, если документ еще не отправлен в банк на исполнение (например, является черновиком)</p></td>
</tr>
<tr class="odd">
<td>sid</td>
<td><p>Идентификатор сессии на стороне сервера банка. Если не известен, то можно всегда возвращать пустое значение.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>Идентификатор сессии применим только для тонкого клиента - это значение, передаваемое браузером на сервер банка в виде JSESSIONID=<strong>12345678</strong>, SID=<strong>12345678</strong>, ASPSESSIONID=<strong>12345678</strong>. Если система ДБО не сохраняет в базе значение SID, всегда возвращайте пустое значение.</p>
<p>Для "толстого" клиента ДБО возвращайте всегда пустое значение, т.к. в "толстом" клиенте сессия отсутствует.</p>
</blockquote></td>
</tr>
<tr class="even">
<td>ip</td>
<td>IP адрес компьютера клиента банка в сети Интернет, с которого была работа с документом. Если неизвестно, можно возвращать пустую строку</td>
</tr>
<tr class="odd">
<td>userid</td>
<td><p>Логин, который вводил клиент для входа в ДБО. Если неизвестно, можно возвращать пустую строку</p></td>
</tr>
<tr class="even">
<td>docnumber</td>
<td>Поле документа «Номер документа».</td>
</tr>
<tr class="odd">
<td>docdate</td>
<td><p>Поле документа «Дата документа». Формат поля - ДАТА ВРЕМЯ.</p>
<blockquote>
<p><strong>Warning</strong></p>
<p>Обратите внимание, что это поле в SQL-запросах будет сравниваться по принципу docdate &gt;= 'дата'</p>
</blockquote></td>
</tr>
<tr class="even">
<td>from_operid</td>
<td><p>ID сотрудника банка в системе АБС, который создал данный платеж (если платеж был создан не клиентом, а сотрудником банка в АБС), NULL в остальных случаях</p>
<blockquote>
<p><strong>Warning</strong></p>
<p>Если VIEW создается в базе данных ДБО, это поле создавать нельзя.</p>
<p>Если VIEW создается в базе данных АБС, это поле должно быть всегда создано, даже если оно всегда будет возвращать NULL</p>
</blockquote></td>
</tr>
<tr class="odd">
<td>from_oper</td>
<td><p>Фамилия Имя Отчество сотрудника банка в системе АБС, который создал данный платеж (если платеж был создан не клиентом, а сотрудником банка в АБС), NULL в остальных случаях</p>
<blockquote>
<p><strong>Warning</strong></p>
<p>Если VIEW создается в базе данных ДБО, это поле создавать нельзя.</p>
<p>Если VIEW создается в базе данных АБС, это поле должно быть всегда создано, даже если оно всегда будет возвращать NULL</p>
</blockquote></td>
</tr>
<tr class="even">
<td>from_id</td>
<td><p>Идентификатор плательщика - клиента банка в анализируемой базе данных. Если не известен, можно возвращать пустую строку</p>
<blockquote>
<p><strong>Warning</strong></p>
<p>При анализе платежей физ.лиц, а также платежей операционистов, это поле является обязательным - там не должно быть пустой строки</p>
</blockquote></td>
</tr>
<tr class="odd">
<td>from_name</td>
<td>Поле документа «Наименование плательщика»</td>
</tr>
<tr class="even">
<td>from_inn</td>
<td>Поле документа «ИНН плательщика»</td>
</tr>
<tr class="odd">
<td>from_account</td>
<td>Поле документа «расчетный счет плательщика»
<blockquote>
<p><strong>Warning</strong></p>
<p>При создании VIEW убедитесь, что это значение соответствует расчетному счету клиента, а не корр. счету банка</p>
</blockquote></td>
</tr>
<tr class="even">
<td>from_bic</td>
<td>Поле документа «БИК банка плательщика»</td>
</tr>
<tr class="odd">
<td>from_bank</td>
<td>Поле документа «Наименование банка плательщика» (без указания населенного пункта), например, ОАО "Сбербанк России"
<blockquote>
<p><strong>Note</strong></p>
<p>Если в базе данных это поле отсутствует, или же наименование банка хранится в одном текстовом поле вместе с населенным пунктом, то в VIEW можно возвращать всегда пустую строку - в этом случае значение будет вычислено на основании справочника банков РФ</p>
</blockquote></td>
</tr>
<tr class="even">
<td>from_city</td>
<td>Город, к которому относится банк плательщика, например, «МОСКВА», «БАРНАУЛ» и т.д.
<blockquote>
<p><strong>Note</strong></p>
<p>Если в базе данных это поле отсутствует, или же наименование банка хранится в одном текстовом поле вместе с населенным пунктом, то в VIEW можно возвращать всегда пустую строку - в этом случае значение будет вычислено на основании справочника банков РФ</p>
</blockquote></td>
</tr>
<tr class="odd">
<td>to_id</td>
<td><p>Идентификатор получателя - клиента банка в анализируемой базе данных. Если не известен, можно возвращать пустую строку</p>
<blockquote>
<p><strong>Note</strong></p>
<p>При анализе платежей операционистов, это поле настоятельно рекомендуется заполнять (но тем не менее, там могут быть пустые строки, например, если получателем является клиент другого банка). В остальных случаях это поле заполнять по возможности.</p>
</blockquote></td>
</tr>
<tr class="even">
<td>to_name</td>
<td>Поле документа «Наименование получателя»</td>
</tr>
<tr class="odd">
<td>to_inn</td>
<td>Поле документа «ИНН получателя»</td>
</tr>
<tr class="even">
<td>to_account</td>
<td>Поле документа «расчетный счет получателя»
<blockquote>
<p><strong>Warning</strong></p>
<p>При создании VIEW убедитесь, что это значение соответствует расчетному счету получателя, а не корр. счету банка</p>
</blockquote></td>
</tr>
<tr class="odd">
<td>to_bic</td>
<td>Поле документа «БИК банка получателя»</td>
</tr>
<tr class="even">
<td>to_bank</td>
<td>Поле документа «Наименование банка получателя» (без указания населенного пункта), например, ОАО "Сбербанк России"
<blockquote>
<p><strong>Note</strong></p>
<p>Если в базе данных это поле отсутствует, или же наименование банка хранится в одном текстовом поле вместе с населенным пунктом, то в VIEW можно возвращать всегда пустую строку - в этом случае значение будет вычислено на основании справочника банков РФ</p>
</blockquote></td>
</tr>
<tr class="odd">
<td>to_city</td>
<td>Город, к которому относится банк получателя, например, «МОСКВА», «БАРНАУЛ» и т.д.
<blockquote>
<p><strong>Note</strong></p>
<p>Если в базе данных это поле отсутствует, или же наименование банка хранится в одном текстовом поле вместе с населенным пунктом, то в VIEW можно возвращать всегда пустую строку - в этом случае значение будет вычислено на основании справочника банков РФ</p>
</blockquote></td>
</tr>
<tr class="even">
<td>amount</td>
<td>Сумма платежа в валюте счета получателя</td>
</tr>
<tr class="odd">
<td>purpose</td>
<td>Поле документа «Назначение платежа»</td>
</tr>
</tbody>
</table>

### Анализ платежей из таблицы fraudwall\_alert

> **Warning**
> 
> Данный раздел применим только для варианта интеграции [Анализ платежей
> по принципу "вопрос - ответ" (через таблицу
> fraudwall\_alert)](#mode_alert). В остальных вариантах интеграции
> таблица fraudwall\_alert используется для торможения платежей в
> АБС, см. [Остановка подозрительного платежа через таблицу
> fraudwall\_alert](#abs_stop).

Работы по настройке FraudWall необходимо начинать только после того, как
были выполнены работы на стороне анализируемой системы банка: создана
таблица fraudwall\_alert, а сама система банка умеет выгружать в нее
платежи для анализа.

В интерфейсе FraudWall необходимо открыть пункт «Сайты» меню «Система»,
выбрать в выпадающем списке «Создать новый сайт». В графе «Тип сайта
FraudWall» вкладки «Общие параметры» из выпадающего списка выбрать
«Анализ платежей из таблицы fraudwall\_alert».

![Создание нового сайта](./images/figure95.jpg)

После необходимо указать, в какой базе данных создана таблица
fraudwall\_alert. Для этого во вкладке «Анализируемая база данных»
необходимо указать параметры созданного подключения, как показано
на рисунке.

![Выбор анализируемой базы данных](./images/figure96.jpg)

FraudWall начнет анализ таблицы fraudwall\_alert сразу же после
сохранения настроек.

Журнал событий анализа платежей из таблицы fraudwall\_alert находится в
файле `/var/log/fraudwall/siteNNN-afdb.log`.

## Получение информации об исполненных платежах клиентов

FraudWall получает информацию об исполненных платежах непосредственно из
анализируемой базы данных (даже если анализируется база данных ДБО, в
ней также есть информация о том, что платеж был исполнен в АБС).

### VIEW fraudwall\_learn

#### Назначение

VIEW fraudwall\_learn используется для получения реквизитов платежей,
исполненных в АБС. Эта информация необходима для процесса
формирования статистики антифрода, а также для проверки
платежей клиентов системой FraudWall AML.

#### Применимость

VIEW fraudwall\_learn необходимо создавать всегда - как для антифрода,
так и для FraudWall AML.

VIEW fraudwall\_learn может создаваться как в ДБО, так и в АБС - в
зависимости от того, где находятся платежи для анализа.

> **Warning**
> 
> Обратите внимание, что для антифрода VIEW fraudwall\_learn должна
> возвращать исполненные платежи, созданные только клиентами банка.
> 
> Для FraudWall AML VIEW fraudwall\_learn должна возвращать все платежи,
> исполненные в АБС, в том числе связанные с зачислением средств из
> других банков.

> **Warning**
> 
> Если в банке предполагается, что FraudWall будет анализировать платежи
> в АБС и как антифрод, и как FraudWall AML, в АБС необходимо создать 2
> отдельные VIEW fraudwall\_learn: одна из них будет отдавать
> исполненные платежи только клиентов банка, а вторая - все
> исполненные платежи.
> 
> Для этого в базе данных АБС создаются 2 отдельных пользователя, и в
> схеме каждого из них создается своя VIEW fraudwall\_learn (и свой
> набор остальных VIEW при необходимости).

#### Запросы, которые делает FraudWall

FraudWall периодически формирует следующие запросы в анализируемую базу
данных:

` SELECT * FROM fraudwall_learn  `

`WHERE updated >= lasttime AND updated <= lasttime + 1 day`

` /* условие ниже добавляется, если в свойствах сайта указано непустое
значение параметра "Анализировать платежи, у которых поле дата
платежа..." */  `

`AND docdate >= startdate AND docdate <= startdate + 1 day`

`/* условие ниже добавляется, если создано опциональное поле abs_date
*/`

`AND abs_date >= last_abs_date AND abs_date <= last_abs_date + 1 day`

`/* сортировка добавляется, если updated содержит часы, минуты и секунды
*/`

`ORDER BY updated ASC`

где **lasttime** - дата и время последней обработанной записи при
предыдущем опросе, **startdate** - поле документа "дата платежа",
начиная с которой нужно возвращать данные, **last\_abs\_date** - дата и
время, полученное из поля abs\_date последней обработанной записи.

> **Note**
> 
> Т.к. в АБС содержится огромное число платежей, чтобы не создавать
> излишней нагрузки на СУБД:
> 
> 1.  За один раз FraudWall запрашивает данные максимум за одни сутки.
> 
> 2.  Если по полю updated нет индекса, но в анализируемой базе данных
>     есть индекс по полю "дата исполнения платежа в АБС", FraudWall
>     будет в запросе указывать abs\_date.
> 
> 3.  Если нет индекса ни по полю updated, ни по полю abs\_date, но есть
>     индекс по полю "дата платежа", FraudWall будет в запросе указывать
>     docdate.
> 
> 4.  Если сортировка (ORDER BY в конце запроса) существенно увеличивает
>     нагрузку на СУБД, в поле updated можно помещать только дату
>     изменения статуса (без часов, минут и секунд). В этом
>     случае FraudWall автоматически уберет из запроса сортировку.

Периодичность, с которым FraudWall опрашивает VIEW fraudwall\_learn,
зависит от скорости получения данных из этой VIEW. Если данные
получаются быстро (до 30 секунд), FraudWall будет опрашивать VIEW
fraudwall\_learn с периодичностью примерно раз в 10 минут.

Если данные получаются медленно, FraudWall запрашивает данные из VIEW
fraudwall\_learn только в ночное время.

#### Перечень полей

<table>
<caption>Перечень полей VIEW fraudwall_learn</caption>
<thead>
<tr class="header">
<th>Поле</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>updated</td>
<td><p>Время исполнения документа в АБС. Формат поля - ДАТА ВРЕМЯ.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>Если есть проблемы с нагрузкой на СУБД при работе с данной VIEW, это поле может содержать только дату (без учета времени), т.е. часы, минуты и секунды всегда равны 00:00:00</p>
</blockquote></td>
</tr>
<tr class="even">
<td>abs_date</td>
<td><p>дата исполнения платежа в АБС</p>
<blockquote>
<p><strong>Note</strong></p>
<p>Данное поле является опциональным и создается только в том случае, если нужно учесть индекс по дате исполнения платежа в АБС. В остальных случаях его создавать не нужно.</p>
</blockquote></td>
</tr>
<tr class="odd">
<td>docid</td>
<td>аналогично VIEW fraudwall_doc (но не может быть пустой строкой, т.к. документ в VIEW fraudwall_learn не может являться черновиком)</td>
</tr>
<tr class="even">
<td>docnumber</td>
<td>аналогично VIEW fraudwall_doc</td>
</tr>
<tr class="odd">
<td>docdate</td>
<td>аналогично VIEW fraudwall_doc</td>
</tr>
<tr class="even">
<td>from_id</td>
<td>аналогично VIEW fraudwall_doc (для входящих платежей клиентов других банков может содержать пустую строку)</td>
</tr>
<tr class="odd">
<td>from_name</td>
<td>аналогично VIEW fraudwall_doc</td>
</tr>
<tr class="even">
<td>from_inn</td>
<td>аналогично VIEW fraudwall_doc</td>
</tr>
<tr class="odd">
<td>from_account</td>
<td>аналогично VIEW fraudwall_doc</td>
</tr>
<tr class="even">
<td>from_bic</td>
<td>аналогично VIEW fraudwall_doc</td>
</tr>
<tr class="odd">
<td>from_bank</td>
<td>аналогично VIEW fraudwall_doc</td>
</tr>
<tr class="even">
<td>from_city</td>
<td>аналогично VIEW fraudwall_doc</td>
</tr>
<tr class="odd">
<td>to_id</td>
<td>аналогично VIEW fraudwall_doc</td>
</tr>
<tr class="even">
<td>to_name</td>
<td>аналогично VIEW fraudwall_doc</td>
</tr>
<tr class="odd">
<td>to_inn</td>
<td>аналогично VIEW fraudwall_doc</td>
</tr>
<tr class="even">
<td>to_account</td>
<td>аналогично VIEW fraudwall_doc</td>
</tr>
<tr class="odd">
<td>to_bic</td>
<td>аналогично VIEW fraudwall_doc</td>
</tr>
<tr class="even">
<td>to_bank</td>
<td>аналогично VIEW fraudwall_doc</td>
</tr>
<tr class="odd">
<td>to_city</td>
<td>аналогично VIEW fraudwall_doc</td>
</tr>
<tr class="even">
<td>amount</td>
<td>аналогично VIEW fraudwall_doc</td>
</tr>
<tr class="odd">
<td>purpose</td>
<td>аналогично VIEW fraudwall_doc</td>
</tr>
<tr class="even">
<td>kbk</td>
<td>Код КБК. Представляет из себя 20-ти значный код. Заполняется только для бюджетных платежей. У остальных платежей – NULL. (поле нужно только при использовании FraudWall AML (системы ПОД/ФТ))</td>
</tr>
</tbody>
</table>

## Получение информации об остатках на счетах клиента

### VIEW fraudwall\_balance

#### Назначение

VIEW fraudwall\_balance используется для получения остатка на счете
клиента, а также для получения всех счетов клиента, открытых в
банке

#### Применимость

VIEW fraudwall\_balance необходимо создавать всегда.

#### Запросы, которые делает FraudWall

Запросы, которые делает FraudWall, зависят от наличия полей в этой VIEW.

При обработке платежа FraudWall делает запросы вида:

` SELECT TOP 1 * FROM fraudwall_balance  `

`WHERE id=ID AND bic=BIC AND account=ACCOUNT`

Если данный запрос не вернул данных (такое может быть при анализе
платежей в АБС), FraudWall делает дополнительный запрос без учета
поля id:

` SELECT TOP 1 * FROM fraudwall_balance  `

`WHERE bic=BIC AND account=ACCOUNT`

Также FraudWall для получения списка всех счетов клиента периодически
делает запросы вида:

` SELECT * FROM fraudwall_balance  `

`WHERE id=ID AND date_close IS NOT NULL`

> **Note**
> 
> Т.к. в анализируемой базе данных может хранится не текущий остаток на
> счете, а история остатков на заданный момент времени, в VIEW
> fraudwall\_balance может быть создано опциональное поле time\_when -
> время, на которое известен остаток. В этом случае FraudWall
> автоматически добавит в запросы условие соответствие
> time\_when текущему дню, а также сортировку по полю time\_when, чтобы
> первым в запросе был самый актуальный остаток.

#### Перечень полей

<table>
<caption>Перечень полей VIEW fraudwall_balance</caption>
<thead>
<tr class="header">
<th>Поле</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>id</td>
<td><p>ID клиента банка в анализируемой базе данных. Соответствует полю <strong>from_id</strong> VIEW fraudwall_doc</p></td>
</tr>
<tr class="even">
<td>time_when</td>
<td><p>Время, на которое был подготовлен остаток на счете (если в анализируемой базе данных хранится не текущий остаток на счете, а история его изменений). Формат поля - ДАТА ВРЕМЯ.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>Данное поле является опциональным - если доступна актуальная информация на текущий момент, это поле создавать не нужно.</p>
<p>Основное назначение этого поля - использовать индексы по времени получения остатка, если это требуется.</p>
</blockquote></td>
</tr>
<tr class="odd">
<td>account</td>
<td>Расчетный счет клиента банка.</td>
</tr>
<tr class="even">
<td>bic</td>
<td><p>БИК банка, где открыт данный расчетный счет.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>Для ДБО юр.лиц это поле является опциональным - если связать счет с БИК невозможно, это поле создавать не нужно. Во всех остальных случаях это поле является обязательным.</p>
</blockquote></td>
</tr>
<tr class="odd">
<td>amount</td>
<td>Сумма остатка на счете клиента в валюте счета.</td>
</tr>
<tr class="even">
<td>amountrub</td>
<td><p>Сумма остатка на счете клиента в рублевом эквиваленте. Если не известно, можно возвращать NULL.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>Данное поле является опциональным - если в анализируемой базе данных нет информации о рублевом эквиваленте, это поле создавать не нужно</p>
</blockquote></td>
</tr>
<tr class="odd">
<td>date_open</td>
<td><p>Дата открытия счета в банке. Формат поля - ДАТА ВРЕМЯ.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>Для ДБО юридических лиц это поле является опциональным - если в анализируемой базе данных соответствующей информации нет, это поле создавать не нужно.</p>
<p>Во всех остальных случаях (в т.ч. при анализе платежей юридических лиц в АБС) это поле является обязательным.</p>
</blockquote></td>
</tr>
<tr class="even">
<td>date_close</td>
<td><p>Дата закрытия счета в банке, или NULL, если счет не закрыт. Формат поля - ДАТА ВРЕМЯ.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>Для ДБО юридических лиц это поле является опциональным - если в анализируемой базе данных соответствующей информации нет, это поле создавать не нужно.</p>
<p>Во всех остальных случаях (в т.ч. при анализе платежей юридических лиц в АБС) это поле является обязательным.</p>
</blockquote></td>
</tr>
</tbody>
</table>

## Получение журнала событий системы ДБО

### VIEW fraudwall\_dbolog

#### Назначение

Помимо анализа реквизитов платежей ДБО из VIEW fraudwall\_doc или
таблицы fraudwall\_alert, FraudWall дополнительно анализирует
сопутствующую информацию о сессии клиента, в которой был создан
данный платеж.

Эту информацию FraudWall может получить при анализе дампа трафика либо
из базы данных посредством VIEW fraudwall\_dbolog.

Данная VIEW по сути представляет собой журнал событий действий клиентов
в ДБО и содержит в себе следующую информацию:

  - события успешной/неуспешной аутентификации

  - события смены (сброса) пароля пользователя

  - события завершения сессии

  - и т.д.

> **Note**
> 
> Эта VIEW опциональна и создается только в той базе данных, из которой
> получен платеж для анализа.

#### Применимость

Данная VIEW создается только в базе данных ДБО.

Для ДБО физических лиц она является обязательной, для ДБО юридических
лиц ее создание рекомендуется. Во всех остальных случаях (при анализе
платежей в базе АБС и в FraudWall AML) ее создание не требуется.

#### Запросы, которые делает FraudWall

FraudWall получает информацию из VIEW fraudwall\_dbolog в режиме чтения
всех событий по всем клиентам за заданный диапазон времени.

Чтобы успеть соотнести платеж с сессией клиента, FraudWall делает частые
(но не чаще, чем 1 раз в секунду) запросы вида:

`SELECT * FROM fraudwall_dbolog`

`WHERE time_when >= lasttime ORDER BY time_when ASC`

где **lasttime** - время последней обработанной записи в предыдущем
запросе.

> **Warning**
> 
> Т.к. опрос этой VIEW осуществляется часто, по полю time\_when должен
> быть соответствующий индекс.

#### Перечень полей

<table>
<caption>Перечень полей VIEW fraudwall_dbolog</caption>
<thead>
<tr class="header">
<th>Поле</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>time_when</td>
<td>Время события. Формат поля - ДАТА ВРЕМЯ.</td>
</tr>
<tr class="even">
<td>from_id</td>
<td>Идентификатор клиента в базе данных ДБО, которому принадлежит событие (соответствует полю from_id VIEW fraudwall_doc или таблицы fraudwall_alert), или пустая строка, если это событие не относится к какому-либо клиенту.</td>
</tr>
<tr class="odd">
<td>corpid</td>
<td>Текст логина юридического лица. Если не известен, то можно всегда возвращать пустую строку.
<blockquote>
<p><strong>Note</strong></p>
<p>Понятие «логин юридического лица» применимо только к некоторым системам ДБО, где логин пользователя может быть одинаковым у разных юридических лиц. Например, у юридических лиц с разными логинами «CORP1» и «CORP2» могут быть пользователи с одинаковым логином «DIRECTOR»</p>
</blockquote></td>
</tr>
<tr class="even">
<td>userid</td>
<td>Текст логина пользователя. Если не известен, то можно всегда возвращать пустую строку.</td>
</tr>
<tr class="odd">
<td>ip</td>
<td>IP адрес компьютера клиента банка в сети Интернет, с которого произошло событие. Если неизвестно, можно возвращать пустую строку</td>
</tr>
<tr class="even">
<td>sid</td>
<td>Идентификатор сессии на стороне сервера банка (соответствует полю sid VIEW fraudwall_doc). Если не известен, то можно всегда возвращать пустую строку.</td>
</tr>
<tr class="odd">
<td>dbotype</td>
<td>Код системы ДБО (присваивается разработчиком FraudWall)</td>
</tr>
<tr class="even">
<td>event_code</td>
<td>Краткий код события, который фиксируется системой ДБО (например, "LOGIN", "LOGOUT", "AUTHFAIL"). Если нет, можно возвращать пустую строку</td>
</tr>
<tr class="odd">
<td>event_text</td>
<td>Детальный текст события</td>
</tr>
</tbody>
</table>

> **Note**
> 
> Т.к. для одного и того же события (например, "успешная
> аутентификация") разные системы ДБО фиксируют
> собственный текст события, при интеграции с новой ДБО
> необходимо предоставить разработчику FraudWall примеры таких
> событий.

## Получение контактной информации о клиентах банка

Получение контактной информации о клиентах необходимо в следующих
случаях:

  - отображение ФИО, должности и телефона представителя клиента в
    интерфейсе системы для удобства пользователя FraudWall

  - для автоматизированного общения с клиентом банка системой
    FraudInform

Контактную информацию FraudWall получает из следующих VIEW:

  - fraudwall\_contact

  - fraudwall\_contact\_doc

### VIEW fraudwall\_contact

#### Назначение

VIEW fraudwall\_contact используется для получения контактной информации
о клиенте банка (номерах телефонов клиента, ФИО, адресе и т.д.)

#### Применимость

VIEW fraudwall\_contact является обязательной для антифрода платежей
клиентов - физических лиц, а также платежей, созданных
операционистами. Для антифрода платежей юридических лиц
она является обязательной только при внедрении FraudInform. Во всех
остальных случаях эта VIEW используется только для удобства работы в
интерфейсе FraudWall.

VIEW fraudwall\_contact может быть создана не только в базе данных, в
которой анализируются платежи, но и в другой базе данных (например, в
CRM). В этом случае необходимо создать сайт с типом "Получение
контактной информации о клиентах банка", в котором указаны
параметры подключения к этой базе данных.

#### Запросы, которые делает FraudWall

FraudWall получает данные из VIEW fraudwall\_contact в следующих
случаях:

  - при открытии в интерфейсе FraudWall платежа, вызвавшего подозрение

  - в момент совершения звонка клиенту системой FraudInform по платежу,
    вызвавшего подозрение

  - в интерфейсе FraudWall при открытии досье клиента

  - периодически по всем клиентам банка

Запросы, которые делает FraudWall в анализируемую базу данных, выглядят
следующим образом:

`SELECT TOP 25 * FROM fraudwall_contact`

`WHERE id = from_id`

где **from\_id** - идентификатор клиента в базе данных ДБО.

> **Note**
> 
> Запрос может вернуть несколько строк данных - например, если у клиента
> несколько контактных телефонов, либо у клиента-юридического лица
> несколько ответственных сотрудников.

Если результат не вернул никаких данных, FraudWall пытается сделать
запрос по ИНН плательщика, если он указан в платежном поручении:

`SELECT TOP 25 * FROM fraudwall_contact`

`WHERE inn = from_inn`

где **from\_inn** - ИНН плательщика

> **Note**
> 
> Этот запрос делается по всем анализируемым базам данных, пока не будет
> получена контактная информация хотя бы из одной базы данных.

При открытии в интерфейсе FraudWall досье клиента, FraudWall
дополнительно пытается сделать запрос по наименованию
организации - плательщика либо ФИО плательщика - физического
лица, указанного в строке поиска:

`SELECT TOP 25 * FROM fraudwall_contact`

`WHERE company LIKE 'from_name%'`

`SELECT TOP 25 * FROM fraudwall_contact`

`WHERE company LIKE '%from_name%'`

`SELECT TOP 25 * FROM fraudwall_contact`

`WHERE fio LIKE 'from_name%'`

`SELECT TOP 25 * FROM fraudwall_contact`

`WHERE fio LIKE '%from_name%'`

где **from\_name** - переведенное в верхний регистр наименование
организации либо ФИО клиента банка

#### Перечень полей

<table>
<caption>Перечень полей VIEW fraudwall_contact</caption>
<thead>
<tr class="header">
<th>Поле</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>id</td>
<td>Идентификатор клиента в анализируемой базе данных.
<blockquote>
<p><strong>Note</strong></p>
<p>Если контактная информация получается не из базы данных, где анализируются платежи, необходимо всегда возвращать пустую строку.</p>
</blockquote></td>
</tr>
<tr class="even">
<td>inn</td>
<td>ИНН клиента</td>
</tr>
<tr class="odd">
<td>company</td>
<td>Наименование организации
<blockquote>
<p><strong>Note</strong></p>
<p>Для клиентов - физических лиц можно всегда возвращать пустую строку</p>
</blockquote></td>
</tr>
<tr class="even">
<td>address</td>
<td>Фактический адрес клиента</td>
</tr>
<tr class="odd">
<td>phone</td>
<td>Строка с телефонами для связи с клиентом. Можно указать несколько телефонов через запятую.
<blockquote>
<p><strong>Note</strong></p>
<p>Рекомендуется указывать телефоны с кодом города вида +7 (123) 456-78-90, чтобы сотрудник банка не ошибся с набором номера</p>
</blockquote></td>
</tr>
<tr class="even">
<td>title</td>
<td>Должность представителя клиента - юридического лица (например, директор, гл. бухгалтер и т.д.)
<blockquote>
<p><strong>Note</strong></p>
<p>Для клиентов - физических лиц можно всегда возвращать пустую строку.</p>
<p>Если должность неизвестна, можно также всегда возвращать пустую строку.</p>
</blockquote></td>
</tr>
<tr class="odd">
<td>fio</td>
<td>Фамилия Имя Отчество клиента (если клиент - физическое лицо) либо представителя клиента - юридического лица
<blockquote>
<p><strong>Note</strong></p>
<p>Для клиентов - физических лиц необходимо выводить полную фамилию, имя и отчество, предпочтительно в верхнем регистре.</p>
<p>Для клиентов - юридических лиц достаточно выводить любой текст, в том числе и инициалы, и даже пустую строку, если данные отсутствуют.</p>
</blockquote></td>
</tr>
<tr class="even">
<td>birthday</td>
<td>Дата рождения клиента - физического лица. Формат поля - ДАТА ВРЕМЯ
<blockquote>
<p><strong>Note</strong></p>
<p>Для клиентов - юридических лиц можно всегда возвращать NULL</p>
</blockquote></td>
</tr>
<tr class="odd">
<td>infotext</td>
<td>Текст, который дополнительно нужно выводить вместе с телефоном (например, контрольный вопрос/ответ и т.д.). Допускаются переводы строки в тексте. Если дополнительный текст выводить не нужно, можно всегда возвращать пустую строку</td>
</tr>
<tr class="even">
<td>infohtml</td>
<td>HTML-текст, который дополнительно нужно выводить вместе с телефоном. Если дополнительный текст выводить не нужно, можно всегда возвращать пустую строку</td>
</tr>
</tbody>
</table>

### Функция или VIEW fraudwall\_contact\_doc

#### Назначение

В ДБО юридических лиц для одной организации могут быть создано несколько
клиентов - директор, главный бухгалтер и т.д.

Если платеж вызвал подозрение, лучше связаться непосредственно с
сотрудниками организации, которые участвовали в создании этого
платежа - подписантами, создателями и т.д.

Для получения информации о контактах таких сотрудников и предусмотрена
fraudwall\_contact\_doc.

#### Применимость

VIEW или табличная функция fraudwall\_contact\_doc является опциональной
и может быть создана только для ДБО юридических лиц.

#### Запросы, которые делает FraudWall

В зависимости от конкретной ДБО, fraudwall\_contact\_doc может быть
реализована как VIEW либо как табличная функция.

При открытии подозрительного платежа в интерфейсе FraudWall, а также при
в момент совершения звонка системой FraudInform, в анализируемую базу
ДБО делаются следующие запросы:

`SELECT TOP 1 * FROM fraudwall_contact_doc`

`WHERE docid = docid`

`ORDER BY time_when DESC`

где **docid** - идентификатор документа в базе данных ДБО.

Если fraudwall\_contact\_doc реализована как табличная функция, запрос
выглядит следующим образом:

`SELECT * FROM TABLE(fraudwall_contact_doc(docid))`

#### Перечень полей

<table>
<caption>Перечень полей VIEW fraudwall_contact_doc</caption>
<thead>
<tr class="header">
<th>Поле</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>docid</td>
<td><p>Идентификатор документа в анализируемой базе данных</p>
<blockquote>
<p><strong>Note</strong></p>
<p>Создается только во VIEW fraudwall_contact_doc.</p>
</blockquote></td>
</tr>
<tr class="even">
<td>time_when</td>
<td>Дата и время, когда данный сотрудник работал с документом. Формат поля - ДАТА ВРЕМЯ
<blockquote>
<p><strong>Note</strong></p>
<p>Создается только во VIEW fraudwall_contact_doc.</p>
<p>Если неизвестно, можно всегда возвращать NULL</p>
</blockquote></td>
</tr>
<tr class="odd">
<td>company</td>
<td>Наименование юридического лица</td>
</tr>
<tr class="even">
<td>address</td>
<td>Фактический адрес клиента</td>
</tr>
<tr class="odd">
<td>phone</td>
<td>Строка с телефонами для связи с клиентом. Можно указать несколько телефонов через запятую.</td>
</tr>
<tr class="even">
<td>title</td>
<td>Должность представителя клиента - юридического лица (например, директор, гл. бухгалтер и т.д.)
<blockquote>
<p><strong>Note</strong></p>
<p>Если данный сотрудник является конечным подписантом документа перед отправкой в банк, к наименованию должности рекомендуется добавить текст-комментарий "<strong>(подписант)</strong>"</p>
<p>Если должность неизвестна, можно также всегда возвращать пустую строку.</p>
</blockquote></td>
</tr>
<tr class="odd">
<td>fio</td>
<td>Фамилия Имя Отчество сотрудника клиента</td>
</tr>
<tr class="even">
<td>birthday</td>
<td>Дата рождения сотрудника клиента. Формат поля - ДАТА ВРЕМЯ
<blockquote>
<p><strong>Note</strong></p>
<p>Если не известно, можно всегда возвращать NULL</p>
</blockquote></td>
</tr>
<tr class="odd">
<td>infotext</td>
<td>Текст, который дополнительно нужно выводить вместе с телефоном (например, контрольный вопрос/ответ и т.д.). Допускаются переводы строки в тексте. Если дополнительный текст выводить не нужно, можно всегда возвращать пустую строку</td>
</tr>
<tr class="even">
<td>infohtml</td>
<td>HTML-текст, который дополнительно нужно выводить вместе с телефоном. Если дополнительный текст выводить не нужно, можно всегда возвращать пустую строку</td>
</tr>
</tbody>
</table>

## Получение информации о клиентах банка

FraudWall периодически подгружает из всех анализируемых систем
информацию о всех клиентах, которые там зарегистрированы -
реквизиты клиента, перечень его расчетных счетов, контактных
телефонов.

Для этого FraudWall предварительно получает реквизиты клиента из VIEW
fraudwall\_client, а затем уже, на основе ID клиента в анализируемой
базе данных (полученной из VIEW fraudwall\_client) получает перечень
его расчетных счетов из VIEW fraudwall\_balance, информацию по
контактным телефонам клиента из VIEW fraudwall\_contact. Для
этого в анализируемой базе данных должны быть созданы соответствующие
VIEW, кроме того, каждая VIEW должна отдавать данные на основе ID
клиента.

### VIEW fraudwall\_client

#### Назначение

VIEW fraudwall\_client используется для получения информации о всех
клиентах банка.

#### Применимость

VIEW fraudwall\_client является обязательной для FraudWall AML, а также
для антифрода платежей ДБО физических лиц и платежей, созданных
сотрудниками банка.

#### Запросы, которые делает FraudWall

Периодически FraudWall по каждому клиенту банка делает следующий запрос:

`SELECT * FROM fraudwall_client`

`WHERE id=from_id`

где **from\_id** - идентификатор клиента в анализируемой базе
данных.

#### Перечень полей

| Поле          | Описание                                                                                                                                  |
| ------------- | ----------------------------------------------------------------------------------------------------------------------------------------- |
| id            | Идентификатор клиента в анализируемой базе данных                                                                                         |
| client\_type  | Возвращает следующее значение в зависимости от типа клиента: 1 - юридическое лицо или ИП, 2 - физическое лицо, 3 - банк.                  |
| resident      | Возвращает следующее значение в зависимости от типа клиента: 1 - резидент, 0 - нерезидент                                                 |
| name          | Полное наименование клиента (для юридического лица или ИП) или Фамилия Имя Отчество (для физического лица)                                |
| name\_short   | Краткое наименование клиента - юридического лица. Для физического лица можно возвращать пустое значение.                                  |
| inn           | ИНН клиента                                                                                                                               |
| date\_open    | Дата регистрации юридического лица или ИП, NULL для физического лица. Формат поля - ДАТА ВРЕМЯ                                            |
| date\_born    | Дата рождения для физического лица или ИП , NULL для юридического лица. Формат поля - ДАТА ВРЕМЯ                                          |
| address       | юридический адрес (для юридических лиц) либо адрес регистрации (для физических лиц). Если не известен, можно возвращать пустую строку     |
| address\_real | фактический адрес клиента. Если не известен, можно возвращать пустую строку                                                               |
| address\_post | почтовый адрес клиента. Если не известен, можно возвращать пустую строку                                                                  |
| doc\_name     | наименование документа, удостоверяющего личность (для клиентов - физических лиц или ИП). Если не известен, можно возвращать пустую строку |
| doc\_seria    | серия документа, удостоверяющего личность (для клиентов - физических лиц или ИП). Если не известен, можно возвращать пустую строку        |
| doc\_num      | номер документа, удостоверяющего личность (для клиентов - физических лиц или ИП). Если не известен, можно возвращать пустую строку        |
| doc\_date     | Дата выдачи документа, удостоверяющего личность, NULL если не известен. Формат поля - ДАТА ВРЕМЯ                                          |

Перечень полей VIEW fraudwall\_client

## Остановка подозрительного платежа через таблицу fraudwall\_alert

Система FraudWall изначально создавалась как отдельно стоящая система,
не влияющая на работу систем ДБО и АБС. Такой подход исключает
возможность возникновения каких-либо сбоев в ДБО и АБС
(например, из-за несовместимости FraudWall с обновлениями на ДБО
и АБС).

С другой стороны, отсутствие в FraudWall механизма блокирования
подозрительного платежного поручения может привести к тому, что
пока один сотрудник банка будет дозваниваться до клиента, другой
сотрудник уже успеет исполнить в АБС мошеннический документ.

Для исключения таких ситуаций, в FraudWall предусмотрен механизм
интеграции через таблицу-справочник подозрительных платежей
**fraudwall\_alert**.

В зависимости от настроек сайта, FraudWall может выгружать в эту
таблицу:

  - только платежи, вызвавшие подозрение

  - все платежи, обработанные FraudWall

При интеграции по принципу "вопрос - ответ" (см. [Анализ платежей по
принципу "вопрос - ответ" (через таблицу
fraudwall\_alert)](#mode_alert)), в эту таблицу платежи помещает не
FraudWall, а система банка (ДБО или АБС).

В любом случае, после проверки платежа для каждой записи в таблице
fraudwall\_alert система FraudWall всегда проставляет соответствующее
непустое значение в поле "статус".

![Механизм остановки подозрительного платежа](./images/figure90.jpg)

> **Note**
> 
> Торможение подозрительных платежей через таблицу **fraudwall\_alert**
> может быть реализовано как в АБС (в момент проводки документа), так и
> в ДБО (в момент выгрузки документа в АБС). Но для удобства по тексту
> будет написано, что торможение осуществляется в АБС.

Перед исполнением платежного документа, АБС должна проверить – есть ли
данный документ в таблице **fraudwall\_alert**, а если есть – какое
значение имеет поле «статус». Например, если статус документа
«подозрительный», АБС должна прекратить исполнение платежного
документа и выдать соответствующее сообщение вида «документ
подозрительный, требуется подтверждение клиентом».

После того, как сотрудник банка пообщался с клиентом, он выставляет
подозрительному платежу соответствующий статус либо в интерфейсе
АБС, либо в интерфейсе FraudWall - это приводит к тому, что в таблице
fraudwall\_alert меняется значение поля "статус". Поэтому, при повторном
вызове операции исполнения платежного документа, АБС уже не найдет
«подозрительный» статус для данного документа, поэтому позволит
его исполнить.

В свою очередь, FraudWall учтет новый статус платежа и автоматически
дообучится.

### Таблица fraudwall\_alert

На стороне базы данных системы банка (АБС или ДБО - в зависимости от
того, где будет реализован механизм остановки подозрительных
платежей) необходимо выполнить следующие операции:

  - создать пользователя, под которым FraudWall будет подключаться к
    базе данных

  - создать таблицу **fraudwall\_alert**, владельцем которого является
    созданный пользователь

  - предоставить приложению АБС или ДБО доступ с правом **SELECT**,
    **UPDATE** на таблицу **fraudwall\_alert**

  - создать индексы (при необходимости), ускоряющие работу запросов

> **Note**
> 
> Примеры SQL-команд для создания таблицы под разные СУБД находятся в
> директории `/usr/share/doc/fraudwall` на сервере FraudWall.

<table>
<caption>Перечень полей таблицы <strong>fraudwall_alert</strong></caption>
<thead>
<tr class="header">
<th>Поле</th>
<th>Формат</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>docid</td>
<td>текст, 32 символа</td>
<td><p>Уникальный ID документа, формируемый системой FraudWall для служебных целей</p>
<blockquote>
<p><strong>Warning</strong></p>
<p>Это поле не имеет отношения к полю <strong>DOCID</strong> из VIEW <strong>fraudwall_doc</strong>. См. также поле <strong>dboid</strong> таблицы <strong>fraudwall_alert</strong></p>
</blockquote>
<blockquote>
<p><strong>Note</strong></p>
<p>Это поле заполняет только FraudWall. Если документ помещается в таблицу fraudwall_alert системой банка, значение должно быть всегда NULL.</p>
</blockquote></td>
</tr>
<tr class="even">
<td>dboid</td>
<td>текст, 32 символа</td>
<td><p>ID документа в системе ДБО, NULL если не известно</p>
<blockquote>
<p><strong>Note</strong></p>
<p>Если документ в таблицу fraudwall_alert помещает АБС, значение должно быть всегда NULL.</p>
</blockquote></td>
</tr>
<tr class="odd">
<td>absid</td>
<td>текст или число</td>
<td><p>ID документа в системе АБС, NULL если не известно</p>
<blockquote>
<p><strong>Note</strong></p>
<p>Если документ в таблицу fraudwall_alert помещает ДБО, значение должно быть всегда NULL.</p>
</blockquote></td>
</tr>
<tr class="even">
<td>siteid</td>
<td>текст, 32 символа</td>
<td><p>ID сайта в конфигурации системы FraudWall, через который был получен подозрительный документ</p>
<blockquote>
<p><strong>Note</strong></p>
<p>Это поле заполняет только FraudWall. Если документ помещается в таблицу fraudwall_alert системой банка, значение должно быть всегда NULL.</p>
</blockquote></td>
</tr>
<tr class="odd">
<td>updated</td>
<td>ДАТА ВРЕМЯ</td>
<td><p>Дата и время создания или обновления записи</p>
<blockquote>
<p><strong>Note</strong></p>
<p>Это поле заполняется как системой FraudWall, так и системами банка</p>
</blockquote></td>
</tr>
<tr class="even">
<td>docnumber</td>
<td>текст, 9 символов</td>
<td>Поле документа «Номер документа»</td>
</tr>
<tr class="odd">
<td>docdate</td>
<td>текст, 10 символов</td>
<td>Поле документа «Дата документа» в формате ДД.ММ.ГГГГ</td>
</tr>
<tr class="even">
<td>from_name</td>
<td>текст, 4000 символов</td>
<td>Поле документа «Наименование плательщика»</td>
</tr>
<tr class="odd">
<td>from_inn</td>
<td>текст, 12 символов</td>
<td>Поле документа «ИНН плательщика»</td>
</tr>
<tr class="even">
<td>from_account</td>
<td>текст, 20 символов</td>
<td>Поле документа «расчетный счет плательщика»</td>
</tr>
<tr class="odd">
<td>from_bic</td>
<td>текст, 9 символов</td>
<td>Поле документа «БИК банка плательщика»</td>
</tr>
<tr class="even">
<td>from_city</td>
<td>текст, 1024 символа</td>
<td>Город, к которому относится банк плательщика, например, «МОСКВА», «БАРНАУЛ» и т.д.</td>
</tr>
<tr class="odd">
<td>from_bank</td>
<td>текст, 4000 символа</td>
<td>Поле документа «Наименование банка плательщика»</td>
</tr>
<tr class="even">
<td>to_name</td>
<td>текст, 4000 символов</td>
<td>Поле документа «Наименование получателя»</td>
</tr>
<tr class="odd">
<td>to_inn</td>
<td>текст, 12 символов</td>
<td>Поле документа «ИНН получателя»</td>
</tr>
<tr class="even">
<td>to_account</td>
<td>текст, 20 символов</td>
<td>Поле документа «расчетный счет получателя»</td>
</tr>
<tr class="odd">
<td>to_bic</td>
<td>текст, 9 символов</td>
<td>Поле документа «БИК банка получателя»</td>
</tr>
<tr class="even">
<td>to_city</td>
<td>текст, 1024 символа</td>
<td>Город, к которому относится банк получателя, например, «МОСКВА», «БАРНАУЛ» и т.д.</td>
</tr>
<tr class="odd">
<td>to_bank</td>
<td>текст, 4000 символа</td>
<td>Поле документа «Наименование банка получателя»</td>
</tr>
<tr class="even">
<td>purpose</td>
<td>текст, 4000 символа</td>
<td>Поле документа «Назначение платежа»</td>
</tr>
<tr class="odd">
<td>amount</td>
<td>число с 2 знаками после запятой</td>
<td><p>Поле документа «Сумма платежа»</p>
<blockquote>
<p><strong>Note</strong></p>
<p>FraudWall при добавлении в таблицу значения указывает число в виде текста формата ЧЧЧЧЧЧ.ЧЧ (разделитель копеек - символ точки ".")</p>
</blockquote></td>
</tr>
<tr class="even">
<td>status</td>
<td>текст, 1 символ</td>
<td><p>Статус документа (см. <a href="#abs_status_1">Статусы документа в таблице fraudwall_alert</a>).</p>
<blockquote>
<p><strong>Warning</strong></p>
<p>Если документ в таблицу fraudwall_alert помещает АБС или ДБО, значение должно быть всегда X.</p>
</blockquote></td>
</tr>
<tr class="odd">
<td>showtext</td>
<td>текст, 4000 символов</td>
<td><p>Текст - комментарий, который формирует FraudWall для отображения в интерфейсе АБС при открытии данного подозрительного документа</p>
<blockquote>
<p><strong>Note</strong></p>
<p>Например, "наименование получателя возможно является подделкой, обязательно попросите клиента сверить р/с получателя с бумажным договором"</p>
</blockquote></td>
</tr>
<tr class="even">
<td>reason</td>
<td>текст, 4000 символов</td>
<td>Текст комментария, который импортируется в FraudWall при получении обновленного статуса из данной таблицы</td>
</tr>
<tr class="odd">
<td>from_id</td>
<td>текст или число</td>
<td><p>ID плательщика в системе АБС (если запись в fraudwall_alert создала АБС), ID плательщика в ДБО (если запись в fraudwall_alert создала ДБО) или NULL, если не известен</p>
<blockquote>
<p><strong>Note</strong></p>
<p>Размерность и тип поля выбираются исходя из соответствующих типов полей в базе АБС или ДБО, т.к. FraudWall обрабатывает это поле как текст неограниченной длины.</p>
</blockquote></td>
</tr>
<tr class="even">
<td>to_id</td>
<td>текст или число</td>
<td><p>ID получателя в системе АБС (если запись в fraudwall_alert создала АБС), ID получателя в ДБО (если запись в fraudwall_alert создала ДБО) или NULL, если не известен</p>
<blockquote>
<p><strong>Note</strong></p>
<p>Размерность и тип поля выбираются исходя из соответствующих типов полей в базе АБС или ДБО, т.к. FraudWall обрабатывает это поле как текст неограниченной длины.</p>
</blockquote></td>
</tr>
<tr class="odd">
<td>from_operid</td>
<td>текст или число</td>
<td><p>ID сотрудника банка в системе АБС, который создал данный платеж (если платеж был создан не клиентом, а сотрудником банка в АБС), NULL в остальных случаях</p>
<blockquote>
<p><strong>Note</strong></p>
<p>Размерность и тип поля выбираются исходя из соответствующих типов полей в базе АБС, т.к. FraudWall обрабатывает это поле как текст неограниченной длины.</p>
</blockquote></td>
</tr>
<tr class="even">
<td>from_oper</td>
<td>текст</td>
<td><p>Фамилия Имя Отчество сотрудника банка в системе АБС, который создал данный платеж (если платеж был создан не клиентом, а сотрудником банка в АБС), NULL в остальных случаях</p>
<blockquote>
<p><strong>Note</strong></p>
<p>Размерность и тип поля выбираются исходя из соответствующих типов полей в базе АБС, т.к. FraudWall обрабатывает это поле как текст неограниченной длины.</p>
</blockquote></td>
</tr>
</tbody>
</table>

> **Warning**
> 
> Перед помещением в таблицу fraudwall\_alert данных, FraudWall удаляет
> пробелы слева и справа текста.
> 
> Если любое поле платежного документа превысит размерность
> соответствующего поля в таблице - справочнике, оно будет
> обрезано, гарантируя тем самым создание документа в таблице -
> справочнике АБС.

> **Note**
> 
> При необходимости вы можете добавлять собственные поля в таблицу
> fraudwall\_alert, проконсультировавшись при этом со службой
> технической поддержки.

### Статусы документа в таблице fraudwall\_alert

> **Note**
> 
> Выставление статуса в таблице **fraudwall\_alert** может быть
> реализовано как в АБС, так и в ДБО. Но для удобства по тексту
> будет написано, что статус выставляет АБС.

Каждой записи в таблице fraudwall\_alert соответствует статус, который
может принимать одно из следующих значений:

  - **S** (статус выставляется FraudWall) - платеж является
    подозрительным и его нельзя исполнять

  - **F** (статус выставляется АБС) - документ является мошенническим, в
    интерфейсе АБС сотрудник банка выставил статус "мошеннический" и АБС
    меняет статус на «F», а FraudWall еще не знает об этом

  - **f** (статус выставляется FraudWall) - документ является
    мошенническим, FraudWall знает об этом (либо он поменял
    статус "F" на "f" при обучении, либо статус изначально был
    выставлен в интерфейсе FraudWall)

  - **G** (статус выставляется АБС) - клиент подтвердил, что платеж не
    является мошенническим, он исполнен в АБС, и АБС меняет статус
    документа на "G", а FraudWall еще не знает об этом

  - **g** (статус выставляется FraudWall) - исполненный в АБС платеж не
    является мошенническим, FraudWall знает об этом (либо он поменял
    статус "G" на "g" при обучении, либо статус изначально был
    выставлен в интерфейсе FraudWall)

  - **R** (статус выставляется АБС) - клиент подтвердил, что платеж не
    является мошенническим, но по каким-либо причинам платежу было
    отказано в исполнении (например, нет средств на счету клиента,
    документ отозван и т.д.). АБС меняет статус документа на "R", а
    FraudWall еще не знает об этом

  - **r** (статус выставляется FraudWall) - отказанный в исполнении
    платеж не является мошенническим, FraudWall знает об этом (либо
    он поменял статус "R" на "r" при обучении, либо статус изначально
    был выставлен в интерфейсе FraudWall)

  - **X** (статус выставляется АБС) - система FraudWall должна проверить
    этот документ (см. [Анализ платежей по принципу "вопрос - ответ"
    (через таблицу fraudwall\_alert)](#mode_alert)).

  - **j** (статус выставляется FraudWall) – платеж требует проверки со
    стороны работника финмониторинга банка и его нельзя исполнять,
    пока в интерфейсе FraudWall статус не будет изменен на другой.
    Данный статус не может быть изменен в АБС на другой (статус
    меняется только в системе FraudWall), т.е. платежи со
    статусом "j" не могут быть проведены в АБС.

### Доработка АБС

  - (только при интеграции по принципу "вопрос - ответ") помещать в эту
    таблицу все платежи, подлежащие проверке, со значением поля
    статуса, равным "X".

  - блокировать исполнение платежей, реквизиты которых есть в таблице
    fraudwall\_alert, но статус отличен от "g" или "G"

  - для платежей со статусом "j" помимо блокировки исполнения платежей
    также необходимо блокировать возможность изменения данного статуса
    в самой АБС на какой-либо другой (изменение с данного статуса
    возможно только через интерфейс FraudWall, который обновит
    запись в таблице fraudwall\_alert)

  - при открытии в интерфейсе АБС платежа, реквизиты которого есть в
    таблице fraudwall\_alert со статусом "j", выводить на экран
    соответствующее сообщение со следующей информацией для
    операциониста: «Платеж не может быть проведен в АБС
    поскольку попал под контроль ПОД/ФТ в системе FraudWall.
    Статус платежа может быть изменен только специалистом
    финмониторинга в интерфейсе системы FraudWall» (или
    другой схожий по смыслу текст). Без возможности изменить
    статус в АБС.

  - при открытии в интерфейсе АБС платежа, реквизиты которого есть в
    таблице fraudwall\_alert со статусом "S", выводить на экран
    соответствующее сообщение с краткой инструкцией для
    операциониста - что говорить клиенту, куда обращаться
    при подтверждении мошеннического платежа, об ответственности
    операциониста и т.д.С возможностью изменить статус в АБС.

  - запрашивать у операциониста текстовый комментарий с результатами
    общения с клиентом при изменении операционистом статуса в АБС

  - хранить комментарий в журнале аудита действий операциониста

  - в зависимости от результата общения с клиентом, выставлять статус (G
    - "создан клиентом", F - "мошеннический", R - "отказан в исполнении,
    но не мошеннический") в таблице fraudwall\_alert для
    соответствующего платежа (кроме платежей со статусом
    "j")

Если для сайта указан способ диагностики работоспособности АБС с помощью
тестового платежного поручения, для записи в таблице fraudwall\_alert со
значением docid, равным 0, выставлять статус "G" (этот статус необходимо
выставлять каждый раз, т.к. через некоторое время FraudWall сбрасывает
статус такому документу).

### Конфигурирование FraudWall

Работы по настройке FraudWall необходимо начинать только после того, как
были выполнены работы на стороне АБС.

> **Note**
> 
> К АБС устанавливает соединение только сервер управления системы
> FraudWall.

Подключение к базе данных АБС осуществляется посредством механизма ODBC.
Процедура установки и конфигурирования ODBC-драйверов приведена в
разделе [Установка ODBC-драйверов](#odbc_install).

После проверки работоспособности ODBC, необходимо открыть WWW-интерфейс
администрирования системы, пункт «Сайты» меню «Система», вкладка
«Остановка платежей в АБС».

![Параметры для интеграции с АБС](./images/figure79.jpg)

В свойствах сайта необходимо указать параметры интеграции с АБС.
FraudWall начнет взаимодействовать с АБС сразу после сохранения
настроек.

Журнал событий работы с базой данных АБС находится в файле
`/var/log/fraudwall/fw_control.log`.

Разные сайты могут использовать разные подключения к АБС - например в
случае, если в каждом филиале банка установлена собственная АБС.

### Автоматическое очищение старых записей в fraudwall\_alert

Чтобы уменьшить размер таблицы **fraudwall\_alert**, в FraudWall
предусмотрен механизм автоматического очищения старых записей
(на основе поля updated таблицы). Для этого во вкладке «Остановка
платежей в АБС» свойств сайта необходимо указать количество дней,
после которых удаляются старые записи о платежах в таблице
fraudwall\_alert.

![Срок хранения записей в таблице
fraudwall\_alert](./images/figure97.jpg)

### Обеспечение надежности механизма интеграции с АБС

При интеграции антифрод-системы FraudWall с АБС важно обеспечить
бесперебойную работу не только самой антифрод-системы, но и
механизмов самой системы АБС, которая осуществляет непосредственную
блокировку платежа на основании информации, предоставляемой системой
FraudWall.

Высокая надежность работы FraudWall достигается за счет встроенной
системы мониторинга, которая постоянно проверяет функционирование
всех компонент системы FraudWall, и при выявлении сбоя перезапускает
отказавший компонент и информирует об этом администратора.

В FraudWall предусмотрены следующие механизмы, позволяющие обеспечить
надежное функционирование интеграции с АБС:

Кроме того, в FraudWall реализован механизм, позволяющий своевременно
обнаружить неработоспособность механизма остановки подозрительных
платежей. Предусмотрено 2 способа проверки:

  - простой способ проверки

  - расширенный (с помощью тестового платежного поручения)

Простой способ проверки основывается на том, что если платежное
поручение уже исполнено в АБС, но в FraudWall его статус все
еще находится в состоянии "требует проверки клиентом", значит, АБС не
обработала информацию от FraudWall о необходимости остановки платежа.
Такая проверка осуществляется ежечасно, поэтому администратор узнает
о проблемах на стороне АБС не позже, чем через 90 минут.

Расширенный способ проверки предусматривает не только ежечасная проверка
по предыдущему способу, но и создание в таблице **fraudwall\_alert**
тестового подозрительного платежного поручения (со статусом "**S**")
каждые 10 минут. В свою очередь, АБС должна при очередном сканировании
таблицы fraudwall\_alert этой тестовой записи выставить статус
"**G**". Если через 10 минут статус не был обновлен системой АБС,
FraudWall считает, что механизм блокирования платежных поручений в АБС
неработоспособен, и отсылает администратору соответствующее почтовое
сообщение. Такой способ позволяет ускорить обнаружение проблем в АБС,
но требует небольших дополнительных доработок в АБС.

# Приложения

## Процедура регистрации операционной системы RedHat Enterprise Linux

> **Note**
> 
> При установке системы FraudWall на операционную систему CentOS,
> указанные в этом разделе действия выполнять не требуется.

Выполняем команду регистрации сервера в RedHat Customer Portal :
`subscription-manager register --auto-attach`

Если подключение к сети Internet осуществляется в проксированном режиме,
в командной строке необходимо дополнительно указать IP адрес
proxy-сервера:`subscription-manager register --auto-attach
--proxy=1.2.3.4:3128`

Если в процессе установки были ошибки, проверяем настройки сети, а также
наличия на межсетевом экране и прокси-сервера необходимых прав доступа к
сети Интернет.

Убеждаемся, что сервер имеет статус "Действительный" при выполнении
команды:`subscription-manager status`

![Статус успешной регистрации сервера в RedHat Customer
Portal](./images/figure24.jpg)

> **Warning**
> 
> Если текущий статус неуспешный, зайдите на сайт redhat.com в раздел
> Red Hat Customer Portal и устраните проблемы.

После успешной регистрации в RedHat Customer Portal, необходимо
подключить дополнительные репозитории командами:

`subscription-manager repos --enable=rhel-6-server-rpms`

`subscription-manager repos --enable=rhel-6-server-optional-rpms`

Убеждаемся, что серверу подключены 2 этих дополнительных репозитория
командой:`subscription-manager repos --list-enabled`

> **Warning**
> 
> В случае установки компонентов системы FraudWall на нескольких
> серверах, в Red Hat Customer Portal должны быть
> зарегистрированы все сервера
> 
> Без успешной регистрации сервера в Red Hat Customer Portal дальнейшая
> установка системы FraudWall невозможна

## Процедура экспорта SSL-сертификата из IIS

Установка на сервер FraudWall такого же SSL-сертификата, который
установлен на существующем WWW-сервере ДБО, позволит обеспечить
плавный и незаметный переход клиентов на работу через сервер FraudWall.

> **Warning**
> 
> Экспорт сертификата осуществляется непосредственно с существующего
> WWW-сервера ДБО. Для этого Вам необходимо удаленно подключится к
> рабочему столу сервера, например, с помощью TeamViewer, RADMIN,
> DameWare или Microsoft Terminal Client.

Пример процедуры экспорта SSL-сертификата в операционной системе
Microsoft Windows (например, используемый WWW-сервером IIS):

1.  На WWW-сервере системы ДБО через меню «Пуск\\Выполнить» запускаем
    команду: `mmc`

2.  Выбрать в меню «Консоль» пункт «Добавить оснастку»:
    
    ![Пункт меню mmc для добавления оснастки](./images/figure28.jpg)

3.  Нажимаем на кнопку «Добавить» и добавляем оснастку «Сертификаты»:
    
    ![Добавление оснастки Сертификаты](./images/figure29.jpg)

4.  На открывшемся диалоге выбираем «управление сертификатами учетной
    записью службы», затем «локальный компьютер»:
    
    ![Управление сертификатами учетной записью
    службы](./images/figure30.jpg)

5.  В списке доступных служб выбираем «Службу веб-публикаций»:
    
    ![Выбор службы веб-публикаций](./images/figure31.jpg)

6.  Выполняем аналогичные действия для «управления сертификатами учетной
    записи компьютера»:
    
    ![Управление сертификатами учетной записью
    компьютера](./images/figure32.jpg)

7.  Параллельно открываем свойства существующего сайта ДБО в консоли
    администрирования IIS и открываем на просмотр сертификат,
    используемый для существующего сайта ДБО

8.  В ранее открытой консоли **mmc** ищем в ветке Личные (Personal)
    сертификатов службы либо компьютера сертификат, используемый
    WWW-сервером системы ДБО (как правило, достаточно сверить
    идентичность серийного номера и даты устаревания
    сертификата):
    
    ![Выбор сертификата](./images/figure33.jpg)

9.  Правой кнопкой мыши выбираем меню экспорта сертификата:
    
    ![Выбор меню экспорта сертификата](./images/figure34.jpg)

10. Экспортируем сертификат, при этом обязательно указываем опцию
    «экспортировать секретный ключ» («Export private key»),
    формат «PKCS\#12», включаем «При возможности включить дерево
    сертификатов» («Include all certificates in the certification path
    if possible»), выключаем опции «Включить усиленную защиту» («Enable
    strong protection») и «Удалить секретный ключ после экспорта»
    («Delete the private key if export is successful»), как показано на
    рисунке:
    
    ![Опции экспорта сертификата](./images/figure35.jpg)

11. Указываем пароль, на котором будет зашифрован секретный ключ
    сертификата
    
    > **Warning**
    > 
    > В качестве символов пароля рекомендуется указывать только
    > латинские буквы разного регистра и цифры.
    > 
    > Не забывайте пароль экспорта, так как он понадобится при
    > конфигурировании системы FraudWall
    > 
    > Файл экспорта содержит критичную информацию о секретном ключе
    > сайта ДБО. Рекомендуется удалить экспортный файл после
    > конфигурирования системы FraudWall

## Формирование bsi.xml в формате Linux

1.  Заходим консолью на Web-сервер BS-Client

2.  Создаем архивную копию конфигурационного файла модуля BSI `bsi.xml`
    (как правило, он располагается в папке
    `C:\BSSystems\Inetpub\Bsi_scripts\RT_Ic\`) (это требуется для того,
    чтобы в дальнейшем восстановить его содержимое)

3.  Запускаем bsiset.exe (как правило, он располагается в папке
    `C:\BSSystems\Inetpub\EXE\`)

4.  Переходим в окно выбора конфигурационного файла (кнопка с «…»):
    
    ![Выбор конфигурационного файла утилиты
    bsiset.exe](./images/figure41.jpg)

5.  Выбираем в "Files of type" тип "Config file (\*.xml)" и открываем
    конфигурационный файл `bsi.xml` (как правило, он располагается в
    папке `C:\BSSystems\Inetpub\Bsi_scripts\RT_Ic\`):
    
    ![Выбор конфигурационного файла bsi.xml в утилите
    bsiset.exe](./images/figure42.jpg)

6.  Нажимаем на кнопку Edit утилиты `bsiset.exe`

7.  Убираем галочку для опции Indent XML в нижней части интерфейса
    утилиты `bsiset.exe`:
    
    ![Опция bsiset.exe, которая устанавливает формат
    bsi.xml](./images/figure43.jpg)

8.  Как правило, в рабочей системе конфигурационный файл `bsi.xml` уже
    содержит все необходимые конфигурационные параметры, поэтому их
    редактирование не обязательно (за исключением путей к `trace-` и
    `log-` файлам). Если необходимо формирование ` trace-  `либо
    `log-файлов` модуля BSI, необходимо выставить корректные пути к
    файлу в формате **Linux**:
    
    ![Путь к trace-файлу в формате Linux](./images/figure44.jpg)
    
    > **Warning**
    > 
    > Обязательно проверьте, что во всех параметрах, отображаемых в
    > интерфейсе `bsiset.exe`, отсутствуют пути к файлам в формате
    > Windows (типа `C:\BSSystems\`). Модуль BSI на сервере FraudWall
    > работает под операционной системой Red Hat Enterprise Linux,
    > формат путей к файлам отличается (`/var/log/`). Если формат
    > файлов не будет исправлен, модуль BSI работать не будет и в
    > файлах в директории `/var/log/tomcat6` будет зафиксирована
    > соответствующая ошибка.
    
    > **Note**
    > 
    > Подробности конфигурирования bsi.xml для модуля BSI под Apache
    > находятся в документации к системе BS-Client

9.  Закрываем все окна утилиты `bsiset.exe`, нажав на кнопку Ok, а также
    выходим из нее, нажав на кнопку Exit.

10. Через Проводник Windows в сетевой диск bsi (или в файловом менеджере
    в директорию `/etc/tomcat6/RT_Ic по протоколу SFTP/SCP`) копируем
    обновленный файл конфигурации `bsi.xml` (как правило, он
    располагается в папке
    `C:\BSSystems\Inetpub\Bsi_scripts\RT_Ic\`).

11. На Web-сервере BS-Client восстанавливаем файл bsi.xml из архивной
    копии, созданной на предыдущих этапах.

## Установка ODBC-драйверов

Установка драйверов ODBC осуществляется в следующей последовательности:

1.  Через вкладку "Базы данных" интерфейса "Система\\Конфигурирование
    системы" регистрируются все внешние базы данных, к которым должен
    подключаться FraudWall.

2.  Устанавливаются драйвера подключения к базе данных (в зависимости от
    типа базы данных, см. ниже [Установка ODBC-драйверов для
    Oracle](#odbc_oracle),[Установка ODBC-драйверов для Microsoft SQL
    Server и Sybase](#odbc_mssql), [Установка ODBC-драйверов для
    PostgreSQL](#odbc_psql), [Установка ODBC-драйверов для
    Firebird](#odbc_firebird), [Установка ODBC-драйверов для Progress
    OpenEdge](#odbc_progress), [Установка ODBC-драйверов для Pervasive
    SQL](#odbc_pervasive),[Установка ODBC-драйверов для H2](#odbc_h2),
    [Установка ODBC-драйверов для MySQL](#odbc_mysql) )
    
    > **Note**
    > 
    > На один и тот же сервер FraudWall при необходимости может быть
    > установлено несколько различных ODBC-драйверов, например, для
    > СУБД Oracle и Microsoft SQL Server.

3.  Тестируется работоспособность ODBC-соединения (см. раздел
    [Диагностика и решение проблем с
    ODBC-драйверами](#odbc_diagnose))

### Установка ODBC-драйверов для Oracle

  - `oracle-instantclient11.2-basic-11.2.0.3.0-1.i386.rpm`

  - `oracle-instantclient11.2-odbc-11.2.0.3.0-1.i386.rpm`

<!-- end list -->

  - `rpm -i oracle-instantclient11.2-basic-11.2.0.3.0-1.i386.rpm`

  - `rpm -i oracle-instantclient11.2-odbc-11.2.0.3.0-1.i386.rpm`

  - `yum install fraudwall-odbc-oracle`

> **Note**
> 
> FraudWall автоматически определяет, какие версии драйверов Oracle были
> установлены, и использует самую максимальную версию. Деинсталлировать
> старые версии драйверов при этом не нужно.

После установки, в директории ` 
/usr/lib/oracle/NNN/client/network/admin/ ` (NNN соответствует самой
большой установленной версии драйверов Oracle) необходимо в файлах
`tnsnames.ora` и `sqlnet.ora` прописать параметры для подключения к базе
данных (их можно уточнить у администраторов базы данных Oracle).

> **Warning**
> 
> После выполнения настроек необходимо закрыть текущую SSH-сессию и
> переподключиться к серверу FraudWall повторно (если не уверены,
> просто перегрузите сервер командой **reboot**). Если этого не
> сделать, переменные окружения не обновятся, и в дальнейшем при
> установке будут ошибки.

### Установка ODBC-драйверов для Microsoft SQL Server и Sybase

В качестве ODBC-драйверов к СУБД Microsoft SQL Server и Sybase
используются бесплатно распространяемые драйвера проекта
[FreeTDS](http://freetds.schemamania.org/).

Для начала установки ODBC-драйверов на сервер FraudWall необходимо
выполнить команду: `yum install fraudwall-odbc-freetds`

### Установка ODBC-драйверов для PostgreSQL

> **Note**
> 
> Несмотря на то, что FraudWall для работы с собственной базой данных
> использует нативные протоколы обмена с базой данных PostgreSQL, при
> работе с внешними базами данных (систем ДБО и АБС) используется
> протокол ODBC, даже если эта база данных работает на СУБД
> PostgreSQL.

ODBC-драйвера к PostgreSQL входят в комплект программного обеспечения,
поставляемого совместно с операционной системой.

Для установки ODBC-драйверов для базы данных PostgreSQL необходимо
выполнить команду: `yum install fraudwall-odbc-psql`

### Установка ODBC-драйверов для Firebird

Для установки ODBC-драйверов для базы данных Firebird необходимо
выполнить команду: `yum install fraudwall-odbc-firebird`

### Установка ODBC-драйверов для Progress OpenEdge

ODBC-драйвера к СУБД Progress OpenEdge являются частью коммерческого
программного обеспечения DataDirect Connectors (необходим драйвер
**Progress OpenEdge ODBC Connector for Linux 32-bit**).

  - в параметре **CUSTOMER** указывается имя пользователя

  - в параметре **COMPANYNAME** указывается наименование компании

  - в параметре **SERIALNUMBER** указывается серийный номер, полученный
    при покупке ODBC-драйвера

  - в параметре **KEYLIST** указывается лицензионный ключ (control
    number)

> **Warning**
> 
> После выполнения настроек необходимо закрыть текущую SSH-сессию и
> переподключиться к серверу FraudWall повторно (если не уверены,
> просто перегрузите сервер командой **reboot**). Если этого не
> сделать, переменные окружения не обновятся, и в дальнейшем при
> установке будут ошибки.

Затем скопируйте инсталляционный архив с ODBC-драйверами во временную
директорию (например, `/var/tmp`), перейдите в нее, и выполните
команду:

`uncompress имя_файла_архива`

Расширение имени файла архива сменится с **.tar.Z** на **.tar** . Затем
выполните команду:

`tar xvf имя_tar_файла`

После чего выполните команду:

`ksh unixmi.ksh -f /usr/lib/progress/silent.cfg`

Для проверки корректности установки драйверов откройте директорию
`/usr/lib/progress/lib/` и найдите в ней файл `ivoeNNN.so` (значение
**NNN** зависит от версии ODBC-драйверов). Выполните команду (укажите
корректное значение NNN)

`ivtestlib /usr/lib/progress/lib/ivoeNNN.so`

В результате выполнения команды не должно отобразиться каких-либо
сообщений об ошибке.

Далее необходимо открыть на редактирование файл `/etc/odbcinst.ini`, и в
секции \[Progress\] исправить значение параметра **Driver**, указав
правильный путь к файлу `ivoeNNN.so`

### Установка ODBC-драйверов для Pervasive SQL

ODBC-драйвера к СУБД Pervasive SQL распространяются разработчиком данной
СУБД.

Перед началом установки ODBC-драйверов к СУБД Pervasive SQL необходимо с
сайта компании-разработчика данной СУБД скачать архив **PSQL Client -
Linux TAR 32-bit**для версии **v11 (SP3 и выше)**.

Данный TAR-файл необходимо записать на сервер Fraudwall в директорию
**/tmp**, затем выполнить команду: `yum install
fraudwall-odbc-pervasive`

> **Warning**
> 
> После выполнения настроек необходимо закрыть текущую SSH-сессию и
> переподключиться к серверу FraudWall повторно (если не уверены,
> просто перегрузите сервер командой **reboot**). Если этого не
> сделать, переменные окружения не обновятся, и в дальнейшем при
> установке будут ошибки.

### Установка ODBC-драйверов для H2

Взаимодействие с базой данных H2 осуществляется посредством протокола
Postgresql.

Для установки ODBC-драйверов для базы данных H2 необходимо выполнить
команду: `yum install fraudwall-odbc-h2`

### Установка ODBC-драйверов для MySQL

ODBC-драйвера к MySQL входят в комплект программного обеспечения,
поставляемого совместно с операционной системой.

Для установки ODBC-драйверов для базы данных MySQL необходимо выполнить
команду: `yum install fraudwall-odbc-mysql`

Далее необходимо открыть на редактирование файл `/etc/odbcinst.ini`, и в
секции \[MySQL\] исправить значение параметра **Driver**, указав
правильный путь к файлу `libmyodbc3.so` (для MySQL до версии
4.1.1) либо `libmyodbc5.so` (для MySQL версии 4.1.1 и выше)

### Редактирование конфигурационного файла /etc/odbc.ini

Начиная с версии 4.3.4, редактирование файла /etc/odbc.ini необходимо
осуществлять через вкладку "Базы данных" интерфейса
"Система\\Конфигурирование".

### Диагностика и решение проблем с ODBC-драйверами

Проверить корректность подключения к внешней базе данных можно, выполнив
следующую команду (вместо `dsn`, `user` и `password` необходимо
соответственно указать наименование DSN, отображаемого во
вкладке "Базы данных" интерфейса "Система\\Конфигурирование", а
также логин и пароль пользователя, созданного в базе данных): `isql
-v dsn "user" "password"`

При корректных настройках будет осуществлено подключение к базе данных и
можно будет выполнить SQL-команды. Для выхода из утилиты isql необходимо
нажать Ctrl+C, либо ввести команду `quit`

Для включения диагностического trace-файла необходимо открыть на
редактирование файл `/etc/odbcinst.ini` и в секции \[ODBC\]
раскомментировать (т.е. удалить символ ‘\#’ в начале) параметр
TraceFile:

    [ODBC]
    # Для формирования отладочного trace-файла раскомментируйте
    # параметры TraceFile, Trace и ForceTrace
    TraceFile       = /var/log/fraudwall/odbc.log
    Trace           = Yes
    ForceTrace      = Yes

После сохранения изменений, необходимо выполнить команды `service
fw_control restart`

`service fw_master restart`

> **Warning**
> 
> Не забудьте отключить формирование trace-файла после устранения
> ошибок, закомментировав указанные параметры TraceFile, Trace и
> ForceTrace и перестартовав сервисы **fw\_control** и **fw\_master**,
> как указано выше.
> 
> Если вы самостоятельно не смогли устранить проблему, необходимо
> обратиться в службу технической поддержки.

# Термины и определения

GMT

Greenwich Mean Time, Среднее время по Гринвичу - устаревший стандарт
отсчета мирового времени. В настоящее время вместо GMT используют
UTC

UTC

Universal Coordinated Time, Всемирное координированное время - стандарт,
по которому общество регулирует часы и время. Отличается от GMT на доли
секунды.

АБС

автоматизированная банковская система

ДБО

дистанционное банковское обслуживание

Сайт

WWW-сайт, защищаемый системой FraudWall. Например, это WWW-сайт системы
ДБО, WWW-сайт банка и т.д.

фрод

(англ. fraud - обман, мошенничество, подделка) термин, означающий
действия злоумышленника, направленные на получение незаконной
прибыли за счет кражи финансовых средств у клиентов банка

антифрод - система

специализированный комплекс программно - аппаратных средств,
направленных на предотвращение фрода
